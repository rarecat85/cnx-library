const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./D4meORf1.js","./entry.yfGVSS21.css"])))=>i.map(i=>d[i]);
import{F as Ce,N as Re,r as v,a as Ne,u as Se,o as Be,_ as M,O as K,L as i,g as h,H as S,K as l,P as s,I as a,J as w,Q as F,M as b,G as O,R as Ve,S as xe,T as Le,U as j}from"./D4meORf1.js";import{_ as Ee}from"./HewfiHLd.js";import{g as Ie,C as Ae,_ as Te,c as Y}from"./BQA3864d.js";import{u as Pe,_ as Oe}from"./CXBglKcO.js";import{u as Ue}from"./CSLLkWyk.js";import{u as $e}from"./BF39NsgA.js";import{u as qe}from"./BnmRTHMY.js";import"./DovEHTV2.js";import"./C4Xq6-4w.js";import"./BKoeciCV.js";import"./C-xtXPWq.js";const ze={class:"home-page"},Me={class:"my-rental-status-section"},Fe={class:"rental-status-header mb-6"},He={class:"page-title mb-0"},Qe={class:"rental-dashboard"},We={class:"dashboard-number"},Xe={class:"dashboard-number"},Ge={class:"dashboard-number"},Je={class:"center-header mb-6"},Ke={class:"center-header-inner"},je={class:"page-title mb-0"},Ye={class:"new-books-section"},Ze={class:"more-books-btn-wrapper"},et={class:"mb-4 text-body-2"},tt={class:"label-list"},st=["onClick"],at={class:"label-info"},ot={class:"label-number"},nt={class:"label-location"},lt={key:0,class:"rent-book-card"},rt={class:"rent-book-cover"},it=["src","alt"],ut={class:"rent-book-info"},ct={class:"rent-book-title"},dt={class:"rent-book-author"},vt={class:"rent-book-details"},mt={class:"detail-item"},_t={class:"detail-item"},bt={key:1,class:"rent-notice mt-4"},pt={class:"drawer-content"},re=5,ft={__name:"index",setup(yt){const{user:p}=Ue(),{getBooksByCenter:ie,rentBook:ue,requestRent:ce,calculateBookStatus:U,checkAlreadyRentedSameIsbn:de}=$e(),{alert:C}=Re(),L=v(!1),R=v(null),g=v(""),B=v(""),m=v(null),V=v(!1),{$firebaseFirestore:ve}=Ne(),D=ve,H=v(!1),{drawer:A,drawerWidth:me}=Pe(),Z=[...Ae],_=v(""),$=v(""),T=v([]),Q=v(!1),q=v([]),W=v(null),ee=v([]),te=v(""),X=v(0),se=v(0),ae=v(0),_e=Se(),G=()=>{_e.push("/mypage")},be=async()=>{if(!p.value||!D)return{workplace:"",name:""};try{const{doc:t,getDoc:e}=await M(async()=>{const{doc:n,getDoc:c}=await import("./D4meORf1.js").then(k=>k.b2);return{doc:n,getDoc:c}},__vite__mapDeps([0,1]),import.meta.url),r=t(D,"users",p.value.uid),o=await e(r);if(o.exists()){const n=o.data();return{workplace:n.workplace||"",name:n.name||""}}}catch(t){console.error("사용자 정보 가져오기 오류:",t)}return{workplace:"",name:""}},oe=async()=>{if(!(!p.value||!D))try{const{collection:t,query:e,where:r,getDocs:o}=await M(async()=>{const{collection:u,query:P,where:x,getDocs:J}=await import("./D4meORf1.js").then(d=>d.b2);return{collection:u,query:P,where:x,getDocs:J}},__vite__mapDeps([0,1]),import.meta.url),n=t(D,"books"),c=e(n,r("rentedBy","==",p.value.uid)),f=(await o(c)).docs.map(u=>u.data()).filter(u=>u.status==="rented"||u.status==="overdue");X.value=f.length,ee.value=f.map(u=>u.isbn13||u.isbn).filter(u=>u);const y=new Date;y.setDate(y.getDate()+1),y.setHours(23,59,59,999),se.value=f.filter(u=>{if(u.rentedAt){const P=u.rentedAt?.toDate?.()||new Date(u.rentedAt),x=new Date(P);return x.setDate(x.getDate()+7),x<=y}return!1}).length;const N=t(D,"rentalHistory"),E=e(N,r("userId","==",p.value.uid)),I=await o(E);ae.value=I.docs.length}catch(t){console.error("대여 현황 로드 오류:",t)}};Be(async()=>{const t=await be();$.value=t.workplace,te.value=t.name,_.value=t.workplace?Ie(t.workplace):Z[0],await Promise.all([z(),oe(),le()])});const pe=async()=>{await Promise.all([z(),le()])},ne=v([]),z=async()=>{try{Q.value=!0;const e=(await ie(_.value)).filter(o=>o.location==="구매칸");ne.value=e;const r=new Map;e.forEach(o=>{const n=o.isbn13||o.isbn;if(!r.has(n))r.set(n,{...o,copies:[o],availableCount:1,totalCount:1});else{const c=r.get(n);c.copies.push(o),c.totalCount++,U(o)||c.availableCount++}}),r.forEach(o=>{o.availableCount=o.copies.filter(n=>!U(n)).length}),T.value=Array.from(r.values())}catch(t){console.error("신규 도서 로드 오류:",t),T.value=[],ne.value=[]}finally{Q.value=!1}},le=async()=>{if(!(!p.value||!D))try{const{collection:t,query:e,where:r,getDocs:o}=await M(async()=>{const{collection:y,query:N,where:E,getDocs:I}=await import("./D4meORf1.js").then(u=>u.b2);return{collection:y,query:N,where:E,getDocs:I}},__vite__mapDeps([0,1]),import.meta.url),n=t(D,"returnNotifySubscriptions"),c=e(n,r("userId","==",p.value.uid),r("center","==",_.value),r("notified","==",!1)),k=await o(c),f=[];k.forEach(y=>{f.push(y.data().isbn)}),q.value=f}catch(t){console.error("반납 알림 구독 목록 로드 오류:",t),q.value=[]}},fe=async t=>{if(!(!p.value||!D||!t))try{const e=t.isbn13||t.isbn;W.value=e;const{collection:r,addDoc:o,serverTimestamp:n}=await M(async()=>{const{collection:k,addDoc:f,serverTimestamp:y}=await import("./D4meORf1.js").then(N=>N.b2);return{collection:k,addDoc:f,serverTimestamp:y}},__vite__mapDeps([0,1]),import.meta.url),c=r(D,"returnNotifySubscriptions");await o(c,{userId:p.value.uid,userEmail:p.value.email,isbn:e,title:t.title,center:_.value,notified:!1,createdAt:n()}),q.value.push(e),await C(`반납 알림이 신청되었습니다.
도서가 반납되면 알림을 받으실 수 있습니다.`,{type:"success"})}catch(e){console.error("반납 알림 구독 오류:",e),await C("반납 알림 신청에 실패했습니다.",{type:"error"})}finally{W.value=null}},ye=async t=>{if(!p.value||!t)return;if(Y($.value,_.value)&&X.value>=re){await C(`${re}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(t.availableCount===0){await C("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const r=t.isbn13||t.isbn,o=await de(p.value.uid,r,_.value);if(o){await C(`이미 같은 도서를 대여중입니다.
(라벨번호: ${o.labelNumber||"-"})`,{type:"warning"});return}const n=t.copies.filter(c=>!U(c));if(n.length===1){const c=n[0];R.value=t,g.value=c.labelNumber,B.value=c.location,m.value=c,V.value=!0}else R.value=t,g.value="",B.value="",m.value=null,L.value=!0},we=t=>{g.value=t.labelNumber,B.value=t.location,m.value=t},ge=()=>{L.value=!1,R.value=null,g.value="",B.value="",m.value=null},he=()=>{!R.value||!g.value||(L.value=!1,V.value=!0)},ke=()=>{V.value=!1,R.value=null,g.value="",B.value="",m.value=null},De=async()=>{if(!m.value||!p.value)return;const t=Y($.value,_.value);try{H.value=!0,V.value=!1;const e=m.value.labelNumber,r=m.value.isbn13||m.value.isbn;t?(await ue(e,_.value,p.value.uid,r),await Promise.all([z(),oe()]),await C("도서 대여가 완료되었습니다.",{type:"success"})):(await ce(e,_.value,p.value.uid,r),await z(),await C(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(e){console.error("대여 신청 오류:",e),await C(e.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{H.value=!1,R.value=null,g.value="",B.value="",m.value=null}};return qe({title:"홈 - CNX Library",meta:[{name:"description",content:"CNX Library 도서 관리 시스템"}]}),(t,e)=>{const r=h("v-select"),o=Ee,n=h("v-btn"),c=Te,k=h("v-card-title"),f=h("v-icon"),y=h("v-card-text"),N=h("v-spacer"),E=h("v-card-actions"),I=h("v-card"),u=h("v-dialog"),P=Oe,x=h("v-navigation-drawer"),J=h("v-app");return S(),K(J,null,{default:i(()=>[l(c,{"header-type":"home","show-header-actions":!0,onToggleDrawer:e[1]||(e[1]=d=>A.value=!s(A))},{default:i(()=>[a("div",ze,[a("div",Me,[a("div",Fe,[a("h1",He,w(s(te))+"님의 도서 대여 현황 ",1)]),a("div",Qe,[a("div",{class:"dashboard-card",onClick:G},[a("div",We,w(s(X)),1),e[5]||(e[5]=a("div",{class:"dashboard-label"}," 대여중 도서 ",-1))]),a("div",{class:"dashboard-card warning",onClick:G},[a("div",Xe,w(s(se)),1),e[6]||(e[6]=a("div",{class:"dashboard-label"}," 반납 예정 도서 ",-1))]),a("div",{class:"dashboard-card",onClick:G},[a("div",Ge,w(s(ae)),1),e[7]||(e[7]=a("div",{class:"dashboard-label"}," 내가 읽은 책 ",-1))])])]),a("div",Je,[a("div",Ke,[a("h1",je,w(s(_))+" 신규 도서 ",1),l(r,{modelValue:s(_),"onUpdate:modelValue":[e[0]||(e[0]=d=>F(_)?_.value=d:null),pe],items:Z,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),a("div",Ye,[l(o,{books:s(T),center:s(_),"registered-books":s(T),loading:s(Q),title:`총 ${s(T).length}권`,"empty-message":"신규 입고된 도서가 없습니다.","nav-id":"new-books","show-action":!1,"show-status-flags":!0,"show-rent-button":!0,"hide-overdue-status":!0,"show-return-notify-button":!0,"subscribed-isbns":s(q),"my-rented-isbns":s(ee),"return-notify-loading-isbn":s(W),onRent:ye,onSubscribeReturnNotify:fe},null,8,["books","center","registered-books","loading","title","subscribed-isbns","my-rented-isbns","return-notify-loading-isbn"]),a("div",Ze,[l(n,{class:"more-books-btn",variant:"flat",size:"large",block:"",to:"/books"},{default:i(()=>[b(w(s(_))+" 도서 더보기 ",1)]),_:1})])])])]),_:1}),l(u,{modelValue:s(L),"onUpdate:modelValue":e[2]||(e[2]=d=>F(L)?L.value=d:null),"max-width":"500"},{default:i(()=>[l(I,{class:"label-select-card"},{default:i(()=>[l(k,{class:"label-select-title"},{default:i(()=>[...e[8]||(e[8]=[b(" 대여할 도서 선택 ",-1)])]),_:1}),l(y,{class:"label-select-content"},{default:i(()=>[a("p",et,[b(" 같은 도서가 "+w(s(R)?.copies?.length||0)+"권 있습니다.",1),e[9]||(e[9]=a("br",null,null,-1)),e[10]||(e[10]=b(" 대여할 도서를 선택해주세요. ",-1))]),a("div",tt,[(S(!0),O(Ve,null,xe(s(R)?.copies?.filter(d=>!s(U)(d))||[],d=>(S(),O("div",{key:d.labelNumber,class:Le(["label-item",{selected:s(g)===d.labelNumber}]),onClick:wt=>we(d)},[a("div",at,[a("span",ot,w(d.labelNumber),1),a("span",nt,w(d.location),1)]),s(g)===d.labelNumber?(S(),K(f,{key:0,color:"primary"},{default:i(()=>[...e[11]||(e[11]=[b(" mdi-check-circle ",-1)])]),_:1})):j("",!0)],10,st))),128))])]),_:1}),l(E,{class:"label-select-actions"},{default:i(()=>[l(N),l(n,{variant:"text",onClick:ge},{default:i(()=>[...e[12]||(e[12]=[b(" 취소 ",-1)])]),_:1}),l(n,{color:"primary",variant:"flat",disabled:!s(g),onClick:he},{default:i(()=>[...e[13]||(e[13]=[b(" 선택 완료 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(u,{modelValue:s(V),"onUpdate:modelValue":e[3]||(e[3]=d=>F(V)?V.value=d:null),"max-width":"500"},{default:i(()=>[l(I,{class:"rent-confirm-card"},{default:i(()=>[l(k,{class:"rent-confirm-title"},{default:i(()=>[...e[14]||(e[14]=[b(" 대여 확인 ",-1)])]),_:1}),l(y,{class:"rent-confirm-content"},{default:i(()=>[e[20]||(e[20]=a("div",{class:"rent-confirm-info mb-4"},[a("p",null,"아래 정보를 확인 후 대여해주세요.")],-1)),s(m)?(S(),O("div",lt,[a("div",rt,[s(m).cover?(S(),O("img",{key:0,src:s(m).cover,alt:s(m).title},null,8,it)):(S(),K(f,{key:1,size:"48",color:"grey-lighten-1"},{default:i(()=>[...e[15]||(e[15]=[b(" mdi-book-outline ",-1)])]),_:1}))]),a("div",ut,[a("h3",ct,w(s(m).title),1),a("p",dt,w(s(m).author),1),a("div",vt,[a("span",mt,[l(f,{size:"16"},{default:i(()=>[...e[16]||(e[16]=[b(" mdi-label-outline ",-1)])]),_:1}),b(" "+w(s(g)),1)]),a("span",_t,[l(f,{size:"16"},{default:i(()=>[...e[17]||(e[17]=[b(" mdi-map-marker-outline ",-1)])]),_:1}),b(" "+w(s(B)),1)])])])])):j("",!0),s(Y)(s($),s(_))?j("",!0):(S(),O("div",bt,[l(f,{size:"20",color:"warning"},{default:i(()=>[...e[18]||(e[18]=[b(" mdi-information-outline ",-1)])]),_:1}),e[19]||(e[19]=a("span",null,"관리자 승인 후 대여가 완료됩니다.",-1))]))]),_:1}),l(E,{class:"rent-confirm-actions"},{default:i(()=>[l(N),l(n,{variant:"text",onClick:ke},{default:i(()=>[...e[21]||(e[21]=[b(" 취소 ",-1)])]),_:1}),l(n,{color:"primary",variant:"flat",loading:s(H),onClick:De},{default:i(()=>[...e[22]||(e[22]=[b(" 대여하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(x,{modelValue:s(A),"onUpdate:modelValue":e[4]||(e[4]=d=>F(A)?A.value=d:null),location:"right",temporary:"",width:s(me),class:"side-navigation"},{default:i(()=>[a("div",pt,[l(P)])]),_:1},8,["modelValue","width"])]),_:1})}}},Lt=Ce(ft,[["__scopeId","data-v-4cb8dce7"]]);export{Lt as default};
