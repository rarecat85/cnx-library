const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BIWY0BJc.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as te,N as se,a as ae,r as c,D as oe,o as $,e as ne,u as re,O as ie,L as C,_ as O,g as B,H as ce,K as m,P as a,I as s,J as v,Q as U,M as le}from"./BIWY0BJc.js";import{_ as de}from"./qBcIzW3v.js";import{g as ue,C as _e,_ as me,c as ve}from"./Jl_NK9cT.js";import{_ as pe}from"./DhqokV3-.js";import{u as we}from"./CByBtQKx.js";import{u as he}from"./CFmHDJ5n.js";import{u as ge}from"./d4y8but8.js";import"./D4AyLeAP.js";const fe={class:"home-page"},ye={class:"my-rental-status-section"},be={class:"rental-status-header mb-6"},De={class:"page-title mb-0"},ke={class:"rental-dashboard"},Ce={class:"dashboard-number"},Be={class:"dashboard-number"},Re={class:"dashboard-number"},Ne={class:"center-header mb-6"},xe={class:"center-header-inner"},Ae={class:"page-title mb-0"},Le={class:"new-books-section"},Ve={class:"more-books-btn-wrapper"},Se={class:"drawer-content"},W=5,Ee={__name:"index",setup(Me){const{user:l}=we(),{getBooksByCenter:H,rentBook:q,requestRent:z}=he(),{confirm:Q,alert:y}=se(),{$firebaseFirestore:X}=ae(),p=X,L=c(!1),w=oe("navigationDrawer",()=>!1),V=c(280);$(()=>{const e=()=>{V.value=window.innerWidth>=769?360:280};e(),window.addEventListener("resize",e),ne(()=>{window.removeEventListener("resize",e)})});const S=[..._e],r=c(""),E=c(""),h=c([]),R=c(!1),M=c(""),N=c(0),P=c(0),T=c(0),F=re(),x=()=>{F.push("/mypage")},J=async()=>{if(!l.value||!p)return{workplace:"",name:""};try{const{doc:e,getDoc:t}=await O(async()=>{const{doc:d,getDoc:g}=await import("./BIWY0BJc.js").then(D=>D.aB);return{doc:d,getDoc:g}},__vite__mapDeps([0,1]),import.meta.url),n=e(p,"users",l.value.uid),o=await t(n);if(o.exists()){const d=o.data();return{workplace:d.workplace||"",name:d.name||""}}}catch(e){console.error("사용자 정보 가져오기 오류:",e)}return{workplace:"",name:""}},I=async()=>{if(!(!l.value||!p))try{const{collection:e,query:t,where:n,getDocs:o}=await O(async()=>{const{collection:i,query:A,where:f,getDocs:Z}=await import("./BIWY0BJc.js").then(ee=>ee.aB);return{collection:i,query:A,where:f,getDocs:Z}},__vite__mapDeps([0,1]),import.meta.url),d=e(p,"books"),g=t(d,n("rentedBy","==",l.value.uid)),k=(await o(g)).docs.map(i=>i.data()).filter(i=>i.status==="rented"||i.status==="overdue");N.value=k.length;const u=new Date;u.setDate(u.getDate()+1),u.setHours(23,59,59,999),P.value=k.filter(i=>{if(i.rentedAt){const A=i.rentedAt?.toDate?.()||new Date(i.rentedAt),f=new Date(A);return f.setDate(f.getDate()+7),f<=u}return!1}).length;const _=e(p,"rentalHistory"),G=t(_,n("userId","==",l.value.uid)),Y=await o(G);T.value=Y.docs.length}catch(e){console.error("대여 현황 로드 오류:",e)}};$(async()=>{const e=await J();E.value=e.workplace,M.value=e.name,r.value=e.workplace?ue(e.workplace):S[0],await Promise.all([b(),I()])});const K=async()=>{await b()},b=async()=>{try{R.value=!0;const e=await H(r.value),t=new Date;t.setMonth(t.getMonth()-1),h.value=e.filter(n=>n.registeredAt?(n.registeredAt?.toDate?.()||new Date(n.registeredAt))>=t:!1)}catch(e){console.error("신규 도서 로드 오류:",e),h.value=[]}finally{R.value=!1}},j=async e=>{if(!l.value||!e)return;const t=ve(E.value,r.value);if(t&&N.value>=W){await y(`${W}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}const n=t?`"${e.title}"을(를) 대여 신청하시겠습니까?`:`"${e.title}"을(를) 대여 신청하시겠습니까?
(관리자 승인 후 대여 가능)`;if(await Q(n))try{L.value=!0;const o=e.isbn13||e.isbn;t?(await q(o,r.value,l.value.uid),await Promise.all([b(),I()]),await y("도서 대여가 완료되었습니다.",{type:"success"})):(await z(o,r.value,l.value.uid),await b(),await y(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(o){console.error("대여 신청 오류:",o),await y(o.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{L.value=!1}};return ge({title:"홈 - CNX Library",meta:[{name:"description",content:"CNX Library 도서 관리 시스템"}]}),(e,t)=>{const n=B("v-select"),o=de,d=B("v-btn"),g=me,D=pe,k=B("v-navigation-drawer"),u=B("v-app");return ce(),ie(u,null,{default:C(()=>[m(g,{"header-type":"home","show-header-actions":!0,onToggleDrawer:t[1]||(t[1]=_=>w.value=!a(w))},{default:C(()=>[s("div",fe,[s("div",ye,[s("div",be,[s("h1",De,v(a(M))+"님의 도서 대여 현황 ",1)]),s("div",ke,[s("div",{class:"dashboard-card",onClick:x},[s("div",Ce,v(a(N)),1),t[3]||(t[3]=s("div",{class:"dashboard-label"}," 대여중 도서 ",-1))]),s("div",{class:"dashboard-card warning",onClick:x},[s("div",Be,v(a(P)),1),t[4]||(t[4]=s("div",{class:"dashboard-label"}," 반납 예정 도서 ",-1))]),s("div",{class:"dashboard-card",onClick:x},[s("div",Re,v(a(T)),1),t[5]||(t[5]=s("div",{class:"dashboard-label"}," 내가 읽은 책 ",-1))])])]),s("div",Ne,[s("div",xe,[s("h1",Ae,v(a(r))+" 신규 도서 ",1),m(n,{modelValue:a(r),"onUpdate:modelValue":[t[0]||(t[0]=_=>U(r)?r.value=_:null),K],items:S,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),s("div",Le,[m(o,{books:a(h),center:a(r),"registered-books":a(h),loading:a(R),title:`총 ${a(h).length}권`,"empty-message":"신규 입고된 도서가 없습니다.","nav-id":"new-books","show-action":!1,"show-status-flags":!0,"show-rent-button":!0,"hide-overdue-status":!0,onRent:j},null,8,["books","center","registered-books","loading","title"]),s("div",Ve,[m(d,{class:"more-books-btn",variant:"flat",size:"large",block:"",to:"/books"},{default:C(()=>[le(v(a(r))+" 도서 더보기 ",1)]),_:1})])])])]),_:1}),m(k,{modelValue:a(w),"onUpdate:modelValue":t[2]||(t[2]=_=>U(w)?w.value=_:null),location:"right",temporary:"",width:a(V),class:"side-navigation"},{default:C(()=>[s("div",Se,[m(D)])]),_:1},8,["modelValue","width"])]),_:1})}}},qe=te(Ee,[["__scopeId","data-v-3e9b8815"]]);export{qe as default};
