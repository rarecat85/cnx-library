const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./820eoStb.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as Ae,N as Re,a as qe,D as Ee,r as w,k as Ce,o as ue,e as Le,W as Ve,_ as T,O as P,L as d,g as b,H as i,K as r,P as n,I as a,Q as oe,M as p,G as f,X as j,Y as G,T as z,J as q}from"./820eoStb.js";import{_ as Ne}from"./Bf9VqjgN.js";import{g as Se,C as Ie,_ as $e}from"./Bo1do3YP.js";import{_ as He}from"./DkIAv4gB.js";import{u as Te,f as Pe}from"./cuN5Hmzw.js";import{u as ze}from"./CToKycOr.js";import{u as Oe}from"./Lb_6DAE3.js";import"./DMWE-QkB.js";const Me={class:"mypage"},Fe={class:"multi-rent-book-list"},We={class:"rent-book-card-inner"},Ue=["src","alt"],je={key:1,class:"rent-book-thumbnail-placeholder"},Ge={class:"rent-book-meta"},Qe={class:"rent-book-title"},Xe={key:0,class:"rent-book-author"},Ye={key:1,class:"rent-book-publisher"},Je={class:"rent-book-details"},Ke={class:"detail-item"},Ze={class:"detail-item"},et={class:"page-header mb-6"},tt={class:"page-header-inner"},st={class:"rental-section mb-8"},ot={class:"section-header-with-filter mb-4"},at={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},nt={class:"text-body-1"},rt={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},lt={key:0,class:"text-center py-8"},it={key:1,class:"rental-books-grid"},ct={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},dt={class:"requested-section mb-8"},ut={key:0,class:"text-center py-8"},mt={key:1,class:"requested-books-grid"},vt={class:"requested-book-item"},_t={class:"requested-book-actions"},pt={class:"requested-info"},ft={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},yt={class:"history-section"},ht={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},gt={class:"text-body-1"},wt={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},bt={key:0,class:"text-center py-8"},Dt={key:1,class:"history-books-grid"},kt={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},xt={class:"drawer-content"},Bt={__name:"index",setup(At){const{user:h}=ze(),{cancelRentRequest:me}=Te(),{confirm:ae,alert:N}=Re(),{$firebaseFirestore:ve}=qe(),k=ve,O=Ee("navigationDrawer",()=>!1),ne=w(280),S=w(!1),E=w([]),Q=w(!1),re=[...Ie],V=w(""),F=w([]),X=w(!1),I=w([]),Y=w(!1),J=w(null),W=Ce(()=>V.value?F.value.filter(t=>t.center===V.value):F.value),$=w([]),K=w(!1),x=w([]),B=w([]),Z=w(!1),_e=w(!1);ue(()=>{const t=()=>{ne.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Le(()=>{window.removeEventListener("resize",t)})}),Ve(V,()=>{x.value=[]});const pe=async()=>{if(!h.value||!k)return"";try{const{doc:t,getDoc:e}=await T(async()=>{const{doc:g,getDoc:D}=await import("./820eoStb.js").then(A=>A.aE);return{doc:g,getDoc:D}},__vite__mapDeps([0,1]),import.meta.url),l=t(k,"users",h.value.uid),_=await e(l);if(_.exists())return _.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};ue(async()=>{const t=await pe();V.value=t?Se(t):re[0],await Promise.all([le(),fe(),ee()])});const fe=async()=>{if(!(!h.value||!k))try{Y.value=!0;const{collection:t,query:e,where:l,getDocs:_}=await T(async()=>{const{collection:v,query:u,where:o,getDocs:m}=await import("./820eoStb.js").then(y=>y.aE);return{collection:v,query:u,where:o,getDocs:m}},__vite__mapDeps([0,1]),import.meta.url),g=t(k,"books"),D=e(g,l("requestedBy","==",h.value.uid),l("status","==","requested")),A=await _(D),c=[];A.forEach(v=>{c.push({id:v.id,...v.data()})}),c.sort((v,u)=>{const o=v.requestedAt?.toDate?.()||new Date(0);return(u.requestedAt?.toDate?.()||new Date(0))-o}),I.value=c}catch(t){console.error("신청 도서 로드 오류:",t),I.value=[]}finally{Y.value=!1}},le=async()=>{if(!(!h.value||!k))try{X.value=!0;const{collection:t,query:e,where:l,getDocs:_}=await T(async()=>{const{collection:v,query:u,where:o,getDocs:m}=await import("./820eoStb.js").then(y=>y.aE);return{collection:v,query:u,where:o,getDocs:m}},__vite__mapDeps([0,1]),import.meta.url),g=t(k,"books"),D=e(g,l("rentedBy","==",h.value.uid)),A=await _(D),c=[];A.forEach(v=>{const u=v.data();u.rentedAt&&c.push({id:v.id,...u})}),c.sort((v,u)=>{const o=v.rentedAt?.toDate?.()||new Date(0);return(u.rentedAt?.toDate?.()||new Date(0))-o}),F.value=c}catch(t){console.error("대여 도서 로드 오류:",t),F.value=[]}finally{X.value=!1}},ee=async()=>{if(!(!h.value||!k))try{K.value=!0;const{collection:t,query:e,where:l,getDocs:_}=await T(async()=>{const{collection:u,query:o,where:m,getDocs:y}=await import("./820eoStb.js").then(R=>R.aE);return{collection:u,query:o,where:m,getDocs:y}},__vite__mapDeps([0,1]),import.meta.url),g=t(k,"rentalHistory"),D=e(g,l("userId","==",h.value.uid)),A=await _(D),c=new Map;A.forEach(u=>{const o=u.data(),m=o.isbn13||o.isbn||"";if(!m){const y=o.bookId;c.has(y)||c.set(y,{id:u.id,...o});return}if(!c.has(m))c.set(m,{id:u.id,...o});else{const R=c.get(m).returnedAt?.toDate?.()||new Date(0);(o.returnedAt?.toDate?.()||new Date(0))>R&&c.set(m,{id:u.id,...o})}});const v=Array.from(c.values());v.sort((u,o)=>{const m=u.returnedAt?.toDate?.()||new Date(0);return(o.returnedAt?.toDate?.()||new Date(0))-m}),$.value=v}catch(t){console.error("대여 이력 로드 오류:",t),$.value=[]}finally{K.value=!1}},ye=t=>{if(!t)return"";const e=t?.toDate?.()||new Date(t),l=e.getFullYear(),_=String(e.getMonth()+1).padStart(2,"0"),g=String(e.getDate()).padStart(2,"0");return`${l}.${_}.${g} 신청`},he=t=>{if(!t.rentedAt)return null;const e=t.rentedAt?.toDate?.()||new Date(t.rentedAt),l=new Date(e);return l.setDate(l.getDate()+7),l},ie=t=>x.value.some(e=>e.id===t.id),ge=(t,e)=>{e?ie(t)||x.value.push(t):x.value=x.value.filter(l=>l.id!==t.id)},ce=t=>B.value.some(e=>e.id===t.id),we=(t,e)=>{e?ce(t)||B.value.push(t):B.value=B.value.filter(l=>l.id!==t.id)},be=async t=>{if(!(!h.value||!t)&&await ae(`"${t.title}" 대여 신청을 취소하시겠습니까?`))try{J.value=t.id;const e=t.labelNumber||t.id.split("_")[0];await me(e,t.center,h.value.uid),I.value=I.value.filter(l=>l.id!==t.id),await N("대여 신청이 취소되었습니다.",{type:"success"})}catch(e){console.error("신청 취소 오류:",e),await N(e.message||"신청 취소에 실패했습니다.",{type:"error"})}finally{J.value=null}},De=async()=>{if(B.value.length===0||!h.value)return;const t=B.value.map(e=>e.title).join(", ");if(await ae(`다음 도서들을 읽은 책 목록에서 삭제하시겠습니까?

${t}`))try{Z.value=!0;const{doc:e,deleteDoc:l}=await T(async()=>{const{doc:_,deleteDoc:g}=await import("./820eoStb.js").then(D=>D.aE);return{doc:_,deleteDoc:g}},__vite__mapDeps([0,1]),import.meta.url);for(const _ of B.value)await l(e(k,"rentalHistory",_.id));await ee(),await N(`${B.value.length}권이 읽은 책 목록에서 삭제되었습니다.`,{type:"success"}),B.value=[]}catch(e){console.error("이력 삭제 오류:",e),await N("삭제에 실패했습니다.",{type:"error"})}finally{Z.value=!1}},ke=()=>{x.value.length===0||!h.value||(E.value=[...x.value],S.value=!0)},de=()=>{S.value=!1,E.value=[]},xe=async()=>{if(!(E.value.length===0||!h.value))try{Q.value=!0;const{doc:t,updateDoc:e,collection:l,addDoc:_,query:g,where:D,getDocs:A,serverTimestamp:c,deleteField:v}=await T(async()=>{const{doc:o,updateDoc:m,collection:y,addDoc:R,query:C,where:L,getDocs:H,serverTimestamp:M,deleteField:te}=await import("./820eoStb.js").then(se=>se.aE);return{doc:o,updateDoc:m,collection:y,addDoc:R,query:C,where:L,getDocs:H,serverTimestamp:M,deleteField:te}},__vite__mapDeps([0,1]),import.meta.url);for(const o of E.value){const m=t(k,"books",o.id);await e(m,{status:"available",rentedBy:v(),rentedAt:v(),expectedReturnDate:v()});const y=l(k,"rentalHistory"),R=o.isbn13||o.isbn||"",C=g(y,D("userId","==",h.value.uid),D("isbn13","==",R)),L=await A(C);if(L.empty)await _(y,{bookId:o.id,labelNumber:o.labelNumber||"",isbn13:o.isbn13||"",isbn:o.isbn||"",title:o.title||"",author:o.author||"",publisher:o.publisher||"",cover:o.cover||o.image||"",center:o.center||"",userId:h.value.uid,rentedAt:o.rentedAt,returnedAt:c(),rentCount:1});else{const H=L.docs[0],M=H.data();await e(t(k,"rentalHistory",H.id),{rentedAt:o.rentedAt,returnedAt:c(),rentCount:(M.rentCount||1)+1})}}await Promise.all([le(),ee()]);const u=E.value.length;x.value=x.value.filter(o=>!E.value.some(m=>m.id===o.id)),de(),await N(`${u}권의 도서가 반납되었습니다.`,{type:"success"})}catch(t){console.error("반납 처리 오류:",t),await N("반납 처리에 실패했습니다.",{type:"error"})}finally{Q.value=!1}},Be=t=>{!h.value||!t||(E.value=[t],S.value=!0)};return Oe({title:"마이페이지 - CNX Library",meta:[{name:"description",content:"내 대여 목록 및 읽은 책 이력"}]}),(t,e)=>{const l=b("v-card-title"),_=b("v-icon"),g=b("v-alert"),D=b("v-card-text"),A=b("v-spacer"),c=b("v-btn"),v=b("v-card-actions"),u=b("v-card"),o=b("v-dialog"),m=b("v-select"),y=b("v-progress-circular"),R=Ne,C=b("v-col"),L=b("v-row"),H=$e,M=He,te=b("v-navigation-drawer"),se=b("v-app");return i(),P(se,null,{default:d(()=>[r(H,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[2]||(e[2]=s=>O.value=!n(O))},{default:d(()=>[a("div",Me,[r(o,{modelValue:n(S),"onUpdate:modelValue":e[0]||(e[0]=s=>oe(S)?S.value=s:null),"max-width":"500",persistent:""},{default:d(()=>[r(u,{class:"rent-confirm-card"},{default:d(()=>[r(l,{class:"rent-confirm-title"},{default:d(()=>[...e[4]||(e[4]=[p(" 반납 확인 ",-1)])]),_:1}),r(D,{class:"rent-confirm-content"},{default:d(()=>[e[11]||(e[11]=a("div",{class:"rent-confirm-info mb-4"},[a("p",null,"아래 도서들을 반납하시겠습니까?")],-1)),a("div",Fe,[(i(!0),f(j,null,G(n(E),s=>(i(),f("div",{key:s.id,class:"rent-book-card"},[a("div",We,[s.cover||s.image?(i(),f("img",{key:0,src:s.cover||s.image,alt:s.title,class:"rent-book-thumbnail"},null,8,Ue)):(i(),f("div",je,[...e[5]||(e[5]=[a("span",null,"NO IMAGE",-1)])])),a("div",Ge,[a("div",Qe,q(s.title),1),s.author?(i(),f("div",Xe,[e[6]||(e[6]=a("strong",null,"저자:",-1)),p(" "+q(s.author),1)])):z("",!0),s.publisher?(i(),f("div",Ye,[e[7]||(e[7]=a("strong",null,"출판사:",-1)),p(" "+q(s.publisher),1)])):z("",!0),a("div",Je,[a("span",Ke,[r(_,{size:"x-small",class:"mr-1"},{default:d(()=>[...e[8]||(e[8]=[p("mdi-label",-1)])]),_:1}),p(" "+q(s.labelNumber||"라벨없음"),1)]),a("span",Ze,[r(_,{size:"x-small",class:"mr-1"},{default:d(()=>[...e[9]||(e[9]=[p("mdi-map-marker",-1)])]),_:1}),p(" "+q(n(Pe)(s.location)||"위치없음"),1)])])])])]))),128))]),r(g,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:d(()=>[...e[10]||(e[10]=[p(" 위치와 라벨번호를 확인 후 해당 위치에 도서를 반납해주세요. ",-1)])]),_:1})]),_:1}),r(v,{class:"rent-confirm-actions"},{default:d(()=>[r(A),r(c,{variant:"text",onClick:de},{default:d(()=>[...e[12]||(e[12]=[p(" 취소 ",-1)])]),_:1}),r(c,{color:"primary",variant:"flat",loading:n(Q),onClick:xe},{default:d(()=>[...e[13]||(e[13]=[p(" 반납하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a("div",et,[a("div",tt,[e[15]||(e[15]=a("h1",{class:"page-title mb-0"}," 마이페이지 ",-1)),r(c,{class:"edit-profile-btn",variant:"flat",size:"small",to:"/mypage/edit"},{default:d(()=>[...e[14]||(e[14]=[p(" 정보수정 ",-1)])]),_:1})])]),a("div",st,[a("div",ot,[e[16]||(e[16]=a("h2",{class:"section-title"}," 내 대여 목록 ",-1)),r(m,{modelValue:n(V),"onUpdate:modelValue":e[1]||(e[1]=s=>oe(V)?V.value=s:null),items:re,variant:"outlined",density:"comfortable","hide-details":"",class:"center-filter-select"},null,8,["modelValue"])]),a("div",at,[a("div",nt,[e[17]||(e[17]=p(" 총 ",-1)),a("strong",null,q(n(W).length),1),e[18]||(e[18]=p("권 대여중 ",-1)),n(x).length>0?(i(),f("span",rt," ("+q(n(x).length)+"권 선택됨) ",1)):z("",!0)]),n(W).length>0?(i(),P(c,{key:0,class:"return-btn",variant:"flat",size:"small",disabled:n(x).length===0,loading:n(_e),onClick:ke},{default:d(()=>[...e[19]||(e[19]=[p(" 반납하기 ",-1)])]),_:1},8,["disabled","loading"])):z("",!0)]),n(X)?(i(),f("div",lt,[r(y,{indeterminate:"",color:"primary"})])):n(W).length>0?(i(),f("div",it,[r(L,{class:"book-list-row"},{default:d(()=>[(i(!0),f(j,null,G(n(W),(s,U)=>(i(),P(C,{key:`rented-${U}`,cols:"12",sm:"6",class:"book-list-col"},{default:d(()=>[r(R,{book:s,center:s.center||"","show-action":!1,selectable:!0,selected:ie(s),"show-status-flags":!1,"show-return-date":!0,"return-date":he(s),"show-label-number":!0,"label-number":s.labelNumber,"show-location":!0,location:s.location,onSelect:ge,onReturn:Be},null,8,["book","center","selected","return-date","label-number","location"])]),_:2},1024))),128))]),_:1})])):(i(),f("div",ct," 현재 대여중인 도서가 없습니다. "))]),a("div",dt,[e[22]||(e[22]=a("div",{class:"section-header mb-4"},[a("h2",{class:"section-title"}," 내가 신청한 책 ")],-1)),n(Y)?(i(),f("div",ut,[r(y,{indeterminate:"",color:"primary"})])):n(I).length>0?(i(),f("div",mt,[r(L,{class:"book-list-row"},{default:d(()=>[(i(!0),f(j,null,G(n(I),(s,U)=>(i(),P(C,{key:`requested-${U}`,cols:"12",sm:"6",class:"book-list-col"},{default:d(()=>[a("div",vt,[r(R,{book:s,center:s.center||"","show-action":!1,selectable:!1,"show-status-flags":!1,"show-label-number":!!s.labelNumber,"label-number":s.labelNumber,"show-location":!!s.location,location:s.location},null,8,["book","center","show-label-number","label-number","show-location","location"]),a("div",_t,[a("div",pt,[r(_,{size:"small",class:"mr-1"},{default:d(()=>[...e[20]||(e[20]=[p(" mdi-clock-outline ",-1)])]),_:1}),p(" "+q(ye(s.requestedAt)),1)]),r(c,{color:"error",variant:"outlined",size:"small",loading:n(J)===s.id,onClick:Rt=>be(s)},{default:d(()=>[...e[21]||(e[21]=[p(" 신청 취소 ",-1)])]),_:1},8,["loading","onClick"])])])]),_:2},1024))),128))]),_:1})])):(i(),f("div",ft," 신청한 도서가 없습니다. "))]),a("div",yt,[e[26]||(e[26]=a("div",{class:"section-header mb-4"},[a("h2",{class:"section-title"}," 읽은 책 목록 ")],-1)),a("div",ht,[a("div",gt,[e[23]||(e[23]=p(" 총 ",-1)),a("strong",null,q(n($).length),1),e[24]||(e[24]=p("권 ",-1)),n(B).length>0?(i(),f("span",wt," ("+q(n(B).length)+"권 선택됨) ",1)):z("",!0)]),n($).length>0?(i(),P(c,{key:0,class:"delete-history-btn",variant:"flat",size:"small",disabled:n(B).length===0,loading:n(Z),onClick:De},{default:d(()=>[...e[25]||(e[25]=[p(" 삭제하기 ",-1)])]),_:1},8,["disabled","loading"])):z("",!0)]),n(K)?(i(),f("div",bt,[r(y,{indeterminate:"",color:"primary"})])):n($).length>0?(i(),f("div",Dt,[r(L,{class:"book-list-row"},{default:d(()=>[(i(!0),f(j,null,G(n($),(s,U)=>(i(),P(C,{key:`history-${s.id}`,cols:"12",sm:"6",class:"book-list-col"},{default:d(()=>[r(R,{book:s,center:s.center||"","show-action":!1,selectable:!0,selected:ce(s),"show-status-flags":!1,onSelect:we},null,8,["book","center","selected"])]),_:2},1024))),128))]),_:1})])):(i(),f("div",kt," 아직 읽은 책이 없습니다. "))])])]),_:1}),r(te,{modelValue:n(O),"onUpdate:modelValue":e[3]||(e[3]=s=>oe(O)?O.value=s:null),location:"right",temporary:"",width:n(ne),class:"side-navigation"},{default:d(()=>[a("div",xt,[r(M)])]),_:1},8,["modelValue","width"])]),_:1})}}},$t=Ae(Bt,[["__scopeId","data-v-d65404a2"]]);export{$t as default};
