const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CClUKzdS.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as Ee,N as Te,a as Ce,D as Le,r as c,k as A,o as de,e as Se,_ as z,O as Z,L as x,g as B,H as v,K as m,P as s,I as r,G as f,S as K,J as O,Q,Y as Ae,M as R,V as j,W as ve}from"./CClUKzdS.js";import{u as Pe,_ as $e}from"./BK3y3DFm.js";import{_ as Ne}from"./DSLZ_CXF.js";import{g as Ue,C as We,_ as Oe}from"./BjDIYavT.js";import{_ as Me}from"./B35rczAg.js";import{u as Fe}from"./XGU_jhQq.js";import{u as ze}from"./CArDf3sq.js";import"./ClMSg4Ee.js";const Ke={class:"books-register-page"},Qe={class:"center-header mb-6"},je={class:"center-header-inner"},Ge={class:"page-title mb-0"},He={class:"search-section mb-6"},Je={key:0,class:"search-loading-section mb-8"},Xe={class:"text-center py-8"},Ye={key:1,class:"search-empty-section mb-8"},Ze={class:"text-center py-8 text-medium-emphasis empty-state"},et={class:"mb-2"},tt={key:2,class:"search-results-section mb-8"},st={class:"search-results-header mb-4"},ot={class:"text-body-1"},at={key:0,class:"d-flex justify-center mt-6"},rt={class:"book-requests-section"},nt={class:"book-requests-header mb-4"},lt={key:0,class:"text-body-2 text-medium-emphasis mt-2"},it={key:0,class:"text-center py-8"},ct={key:1,class:"book-requests-grid"},ut={key:0,class:"d-flex justify-center mt-6"},dt={key:2,class:"text-center py-8 text-medium-emphasis"},vt={class:"drawer-content"},ee=4,mt={__name:"register",setup(pt){const{user:T}=Fe(),{searchBooks:me,registerBook:te,getBooksByCenter:pe,getBestsellers:_e}=Pe(),{alert:C}=Te(),{$firebaseFirestore:ge}=Ce(),b=ge,P=Le("navigationDrawer",()=>!1),se=c(280),oe=[...We],l=c(""),ye=c(""),V=c(""),L=c([]),$=c(10),M=c(!1),ae=c(null),G=c(!1),N=A(()=>L.value.slice(0,$.value)),fe=A(()=>L.value.length),be=A(()=>$.value<L.value.length),H=c([]),J=c(!1),U=c([]),S=c(new Set),g=c([]),X=c({}),Y=c(!1),W=c(1),re=A(()=>g.value.length),ne=A(()=>Math.ceil(re.value/ee)),le=A(()=>{const t=(W.value-1)*ee,e=t+ee;return g.value.slice(t,e)});de(()=>{const t=()=>{se.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Se(()=>{window.removeEventListener("resize",t)})});const he=async()=>{if(!T.value||!b)return"";try{const{doc:t,getDoc:e}=await z(async()=>{const{doc:y,getDoc:h}=await import("./CClUKzdS.js").then(k=>k.aB);return{doc:y,getDoc:h}},__vite__mapDeps([0,1]),import.meta.url),o=t(b,"users",T.value.uid),p=await e(o);if(p.exists())return p.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};de(async()=>{const t=await he();ye.value=t,l.value=t?Ue(t):oe[0],await Promise.all([ie(),F(),ce()])});const ke=async()=>{W.value=1,await Promise.all([ie(),F(),ce()])},we=async()=>{if(V.value.trim())try{M.value=!0,ae.value=null,$.value=10,G.value=!0;const t=await me(V.value);L.value=t.items||[]}catch(t){console.error("도서 검색 오류:",t),ae.value=t.message||"도서 검색에 실패했습니다.",L.value=[]}finally{M.value=!1}},qe=()=>{V.value="",L.value=[],$.value=10,G.value=!1},Be=()=>{$.value+=10},ie=async()=>{try{J.value=!0;const t=await _e(10);H.value=t.items||[]}catch(t){console.error("베스트셀러 로드 오류:",t),H.value=[]}finally{J.value=!1}},F=async()=>{try{const t=await pe(l.value);U.value=t}catch(t){console.error("등록된 도서 로드 오류:",t),U.value=[]}},ce=async()=>{try{if(Y.value=!0,!b){g.value=[];return}const{collection:t,query:e,where:o,getDocs:p,doc:y,getDoc:h}=await z(async()=>{const{collection:a,query:i,where:u,getDocs:d,doc:E,getDoc:n}=await import("./CClUKzdS.js").then(D=>D.aB);return{collection:a,query:i,where:u,getDocs:d,doc:E,getDoc:n}},__vite__mapDeps([0,1]),import.meta.url),k=t(b,"bookRequests"),w=e(k,o("center","==",l.value),o("status","==","pending")),I=await p(w),_=[];I.forEach(a=>{_.push({id:a.id,...a.data()})}),_.sort((a,i)=>{const u=a.requestedAt?.toDate?.()||new Date(0);return(i.requestedAt?.toDate?.()||new Date(0))-u}),g.value=_;const q=[...new Set(_.filter(a=>a.requestedBy).map(a=>a.requestedBy))];for(const a of q)if(!X.value[a])try{const i=y(b,"users",a),u=await h(i);if(u.exists()){const d=u.data(),E=(d.email||"").split("@")[0],n=d.name||"",D=d.workplace||"";X.value[a]=`${D} ${n}(${E})`}}catch(i){console.error("신청자 정보 로드 오류:",i)}}catch(t){console.error("도서 신청 목록 로드 오류:",t),g.value=[]}finally{Y.value=!1}},Re=t=>t.requestedBy&&X.value[t.requestedBy]||"",ue=async t=>{const e=t.isbn13||t.isbn||"";if(!e){await C("ISBN 정보가 없어 등록할 수 없습니다.",{type:"error"});return}if(!S.value.has(e))try{S.value.add(e),await te(t,l.value,T.value.uid);const o=g.value.find(p=>(p.isbn13||p.isbn||"")===e);if(o&&b){const{doc:p,updateDoc:y,serverTimestamp:h,addDoc:k,collection:w}=await z(async()=>{const{doc:_,updateDoc:q,serverTimestamp:a,addDoc:i,collection:u}=await import("./CClUKzdS.js").then(d=>d.aB);return{doc:_,updateDoc:q,serverTimestamp:a,addDoc:i,collection:u}},__vite__mapDeps([0,1]),import.meta.url),I=p(b,"bookRequests",o.id);if(await y(I,{status:"approved",approvedAt:h(),approvedBy:T.value.uid}),o.requestedBy){const _=w(b,"notifications");await k(_,{userId:o.requestedBy,type:"book_registered",title:"신청 도서 등록 완료",message:`신청하신 도서 "${t.title}"이(가) ${l.value}에 등록되었습니다.`,bookTitle:t.title,bookIsbn:e,center:l.value,isRead:!1,createdAt:h()})}g.value=g.value.filter(_=>_.id!==o.id)}await F(),await C("도서가 성공적으로 등록되었습니다.",{type:"success"})}catch(o){console.error("도서 등록 오류:",o),await C(o.message||"도서 등록에 실패했습니다.",{type:"error"})}finally{S.value.delete(e)}},De=async t=>{const e=t.isbn13||t.isbn||"";if(!e){await C("ISBN 정보가 없어 등록할 수 없습니다.",{type:"error"});return}if(!S.value.has(e))try{if(S.value.add(e),await te(t,l.value,T.value.uid),b){const{doc:o,updateDoc:p,serverTimestamp:y,collection:h,query:k,where:w,getDocs:I,addDoc:_}=await z(async()=>{const{doc:i,updateDoc:u,serverTimestamp:d,collection:E,query:n,where:D,getDocs:xe,addDoc:Ie}=await import("./CClUKzdS.js").then(Ve=>Ve.aB);return{doc:i,updateDoc:u,serverTimestamp:d,collection:E,query:n,where:D,getDocs:xe,addDoc:Ie}},__vite__mapDeps([0,1]),import.meta.url);let q=t.id,a=t.requestedBy;if(!q){const i=h(b,"bookRequests"),u=k(i,w("center","==",l.value),w("status","==","pending"),w("isbn13","==",e)),d=await I(u);d.empty||(q=d.docs[0].id,a=d.docs[0].data().requestedBy)}if(q){const i=o(b,"bookRequests",q);if(await p(i,{status:"approved",approvedAt:y(),approvedBy:T.value.uid}),a){const u=h(b,"notifications");await _(u,{userId:a,type:"book_registered",title:"신청 도서 등록 완료",message:`신청하신 도서 "${t.title}"이(가) ${l.value}에 등록되었습니다.`,bookTitle:t.title,bookIsbn:e,center:l.value,isRead:!1,createdAt:y()})}}}g.value=g.value.filter(o=>(o.isbn13||o.isbn||"")!==e),await F(),await C("도서가 성공적으로 등록되었습니다.",{type:"success"})}catch(o){console.error("도서 등록 오류:",o),await C(o.message||"도서 등록에 실패했습니다.",{type:"error"})}finally{S.value.delete(e)}};return ze({title:"도서 등록 - CNX Library",meta:[{name:"description",content:"도서 검색 및 등록"}]}),(t,e)=>{const o=B("v-select"),p=B("v-text-field"),y=B("v-progress-circular"),h=B("v-icon"),k=$e,w=B("v-col"),I=B("v-row"),_=B("v-btn"),q=Ne,a=B("v-pagination"),i=Oe,u=Me,d=B("v-navigation-drawer"),E=B("v-app");return v(),Z(E,null,{default:x(()=>[m(i,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[3]||(e[3]=n=>P.value=!s(P))},{default:x(()=>[r("div",Ke,[r("div",Qe,[r("div",je,[r("h1",Ge,O(s(l))+" 도서 등록 ",1),m(o,{modelValue:s(l),"onUpdate:modelValue":[e[0]||(e[0]=n=>Q(l)?l.value=n:null),ke],items:oe,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),r("div",He,[m(p,{modelValue:s(V),"onUpdate:modelValue":e[1]||(e[1]=n=>Q(V)?V.value=n:null),label:"도서 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable",loading:s(M),clearable:"",class:"search-input",onKeyup:Ae(we,["enter"]),"onClick:clear":qe},null,8,["modelValue","loading"])]),s(M)?(v(),f("div",Je,[r("div",Xe,[m(y,{indeterminate:"",color:"primary"}),e[5]||(e[5]=r("p",{class:"mt-4 text-medium-emphasis"}," 검색 중... ",-1))])])):s(G)&&s(N).length===0?(v(),f("div",Ye,[r("div",Ze,[m(h,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:x(()=>[...e[6]||(e[6]=[R(" mdi-book-search-outline ",-1)])]),_:1}),r("p",et,[e[7]||(e[7]=R(" '",-1)),r("strong",null,O(s(V)),1),e[8]||(e[8]=R("'에 대한 검색 결과가 없습니다. ",-1))]),e[9]||(e[9]=r("p",{class:"text-body-2"}," 다른 검색어로 시도해보세요. ",-1))])])):s(N).length>0?(v(),f("div",tt,[r("div",st,[r("div",ot,[s(fe)>=10?(v(),f(j,{key:0},[e[10]||(e[10]=R(" 검색 결과가 많습니다. (현재 ",-1)),r("strong",null,O(s(N).length),1),e[11]||(e[11]=R("개 표시 중) ",-1))],64)):(v(),f(j,{key:1},[e[12]||(e[12]=R(" 총 ",-1)),r("strong",null,O(s(N).length),1),e[13]||(e[13]=R("개의 검색 결과 ",-1))],64))])]),m(I,{class:"book-list-row"},{default:x(()=>[(v(!0),f(j,null,ve(s(N),(n,D)=>(v(),Z(w,{key:`search-${D}`,cols:"12",sm:"6",class:"book-list-col"},{default:x(()=>[m(k,{book:n,center:s(l),"registered-books":s(U),"requested-books":s(g),selectable:!1,"show-action":!0,"allow-register-requested":!0,onRegister:ue},null,8,["book","center","registered-books","requested-books"])]),_:2},1024))),128))]),_:1}),s(be)?(v(),f("div",at,[m(_,{variant:"outlined",color:"primary",onClick:Be},{default:x(()=>[...e[14]||(e[14]=[R(" 더보기 ",-1)])]),_:1})])):K("",!0)])):K("",!0),m(q,{books:s(H),center:s(l),"registered-books":s(U),"requested-books":s(g),title:"베스트셀러",loading:s(J),"empty-message":"베스트셀러를 불러올 수 없습니다.","allow-register-requested":!0,"nav-id":"bestseller",class:"mb-8",onRegister:ue},null,8,["books","center","registered-books","requested-books","loading"]),r("div",rt,[r("div",nt,[e[17]||(e[17]=r("h2",{class:"section-title mb-0"}," 도서 신청 목록 ",-1)),s(g).length>0?(v(),f("div",lt,[e[15]||(e[15]=R(" 총 ",-1)),r("strong",null,O(s(re)),1),e[16]||(e[16]=R("건의 신청 ",-1))])):K("",!0)]),s(Y)?(v(),f("div",it,[m(y,{indeterminate:"",color:"primary"})])):s(le).length>0?(v(),f("div",ct,[m(I,{class:"book-list-row"},{default:x(()=>[(v(!0),f(j,null,ve(s(le),(n,D)=>(v(),Z(w,{key:`request-${D}`,cols:"12",sm:"6",class:"book-list-col"},{default:x(()=>[m(k,{book:n,center:s(l),"registered-books":s(U),selectable:!1,"show-action":!0,"action-button-text":`${s(l)}에 등록하기`,"requester-info":Re(n),onRegister:De},null,8,["book","center","registered-books","action-button-text","requester-info"])]),_:2},1024))),128))]),_:1}),s(ne)>1?(v(),f("div",ut,[m(a,{modelValue:s(W),"onUpdate:modelValue":e[2]||(e[2]=n=>Q(W)?W.value=n:null),length:s(ne),"total-visible":7},null,8,["modelValue","length"])])):K("",!0)])):(v(),f("div",dt," 신청된 도서가 없습니다. "))])])]),_:1}),m(d,{modelValue:s(P),"onUpdate:modelValue":e[4]||(e[4]=n=>Q(P)?P.value=n:null),location:"right",temporary:"",width:s(se),class:"side-navigation"},{default:x(()=>[r("div",vt,[m(u)])]),_:1},8,["modelValue","width"])]),_:1})}}},qt=Ee(mt,[["__scopeId","data-v-29c30846"]]);export{qt as default};
