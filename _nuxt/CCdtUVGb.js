const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./D2qf-AtE.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as He,N as Qe,a as Je,D as Ke,r as b,k as N,o as he,e as Ye,_ as ye,O as Q,L as r,g as w,H as v,K as n,P as a,I as l,J as d,Q as L,G as g,M as c,W as F,X as Ce,T as U,U as Ze}from"./D2qf-AtE.js";import{h as et,_ as tt,a as at}from"./DTp7pKj-.js";import{g as ot,C as lt,_ as st,c as xe}from"./CbG2bHAl.js";import{_ as nt}from"./BIHP7mSn.js";import{u as it,f as Be}from"./DvOg0xnj.js";import{u as rt}from"./Q6JvV8hj.js";import{u as ut}from"./Y4qtn-am.js";import"./Bwezaj8M.js";const ct={class:"books-page"},dt={class:"center-header mb-6"},vt={class:"center-header-inner"},mt={class:"page-title mb-0"},bt={class:"registered-books-section"},_t={class:"registered-books-header mb-0"},ft={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},pt={class:"text-body-1"},wt={class:"d-flex align-center registered-search-group"},kt={class:"d-flex align-center justify-space-between flex-wrap gap-4 mt-4"},gt={class:"text-body-2 text-medium-emphasis"},ht={key:0,class:"text-center py-8 mt-6"},yt={key:1,class:"registered-books-grid mt-6"},Ct={key:2,class:"text-center py-8 mt-6 text-medium-emphasis empty-state"},xt={key:0},Bt={key:1},Rt={class:"drawer-content"},Dt={key:0,class:"book-info-preview mb-4"},Nt={class:"book-info-preview-inner"},Vt=["src","alt"],Lt={class:"book-meta"},St={class:"book-title"},$t={class:"book-author"},qt={class:"label-select-list"},Et={class:"label-select-header mb-2"},At=["onClick"],Ut={class:"label-info"},Pt={class:"label-number"},zt={class:"label-location"},Gt={key:0,class:"book-info-preview mb-4"},Tt={class:"book-info-preview-inner"},It=["src","alt"],Mt={class:"book-meta"},Ft={class:"book-title"},Wt={class:"book-author"},Ot={class:"rent-details"},jt={class:"detail-item"},Xt={class:"detail-value"},Ht={class:"detail-item"},Qt={class:"detail-value"},S=5,Jt={__name:"index",setup(Kt){const{user:y}=rt(),{getBooksByCenter:Re,calculateBookStatus:P,rentBook:oe,requestRent:le,checkAlreadyRentedSameIsbn:se}=it(),{confirm:De,alert:k}=Qe(),{$firebaseFirestore:Ne}=Je(),W=Ne,z=Ke("navigationDrawer",()=>!1),ne=b(280),ie=[...lt],_=b(""),J=b(""),O=b([]),K=b(!1),R=b(""),G=b("date"),Ve=[{title:"등록일순",value:"date"},{title:"제목순",value:"title"}],f=b([]),$=b(!1),D=b(0),V=b(!1),m=b(null),p=b(""),x=b(""),h=b(null),T=b(!1),q=b(!1),j=b(!1),Le=N(()=>et(_.value));he(()=>{const t=()=>{ne.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Ye(()=>{window.removeEventListener("resize",t)})});const Se=async()=>{if(!y.value||!W)return"";try{const{doc:t,getDoc:e}=await ye(async()=>{const{doc:u,getDoc:B}=await import("./D2qf-AtE.js").then(I=>I.aE);return{doc:u,getDoc:B}},__vite__mapDeps([0,1]),import.meta.url),i=t(W,"users",y.value.uid),o=await e(i);if(o.exists())return o.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};he(async()=>{const t=await Se();J.value=t,_.value=t?ot(t):ie[0],await Promise.all([A(),Y()])});const Y=async()=>{if(!y.value||!W){D.value=0;return}try{const{collection:t,query:e,where:i,getDocs:o}=await ye(async()=>{const{collection:M,query:C,where:ee,getDocs:te}=await import("./D2qf-AtE.js").then(ae=>ae.aE);return{collection:M,query:C,where:ee,getDocs:te}},__vite__mapDeps([0,1]),import.meta.url),u=t(W,"books"),B=e(u,i("rentedBy","==",y.value.uid)),I=await o(B);let H=0;I.forEach(M=>{const C=M.data();(C.status==="rented"||C.status==="overdue")&&H++}),D.value=H}catch(t){console.error("대여중인 도서 수 로드 오류:",t),D.value=0}},X=N(()=>D.value<S),E=N(()=>S-D.value),$e=async()=>{f.value=[],await A()},A=async()=>{try{K.value=!0;const t=await Re(_.value);O.value=t}catch(t){console.error("등록된 도서 로드 오류:",t),O.value=[]}finally{K.value=!1}},qe=()=>{},re=N(()=>{const t=new Map;for(const e of O.value){const i=e.isbn13||e.isbn||e.id;t.has(i)||t.set(i,{isbn:i,title:e.title,author:e.author,publisher:e.publisher,image:e.image,copies:[],totalCount:0,availableCount:0,locations:[]});const o=t.get(i);o.copies.push(e),o.totalCount++,P(e)||(o.availableCount++,e.location&&!o.locations.includes(e.location)&&o.locations.push(e.location))}for(const e of t.values())e.copies.sort((i,o)=>{const u=i.labelNumber||"",B=o.labelNumber||"";return u.localeCompare(B,"ko")});return Array.from(t.values())}),ue=N(()=>{let t=[...re.value];if(R.value.trim()){const e=R.value.toLowerCase();t=t.filter(i=>{const o=(i.title||"").toLowerCase(),u=(i.author||"").toLowerCase(),B=(i.publisher||"").toLowerCase();return o.includes(e)||u.includes(e)||B.includes(e)})}return G.value==="title"?t.sort((e,i)=>{const o=(e.title||"").toLowerCase(),u=(i.title||"").toLowerCase();return o.localeCompare(u,"ko")}):G.value==="date"&&t.sort((e,i)=>{const o=e.copies[0]?.registeredAt?.toDate?.()||new Date(0);return(i.copies[0]?.registeredAt?.toDate?.()||new Date(0))-o}),t}),Ee=N(()=>O.value.length),Ae=N(()=>re.value.length),ce=t=>t.copies[0]||{title:t.title,author:t.author,publisher:t.publisher,image:t.image,isbn:t.isbn},Ue=t=>t.availableCount===0?t.copies.some(i=>P(i)==="requested")?"requested":"rented":null,Pe=t=>t.availableCount===0,de=t=>f.value.some(e=>e.isbn===t.isbn),ve=N(()=>m.value?m.value.copies.filter(t=>!P(t)):[]),ze=async t=>{if(de(t)){f.value=f.value.filter(o=>o.isbn!==t.isbn);return}if(!X.value){await k(`${S}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(f.value.length>=E.value){await k(`현재 ${E.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}if(t.availableCount===0){await k("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await se(y.value.uid,t.isbn,_.value);if(e){await k(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const i=t.copies.filter(o=>!P(o));if(i.length===1){const o=i[0];f.value.push({isbn:t.isbn,labelNumber:o.labelNumber,location:o.location,book:o})}else m.value=t,p.value="",x.value="",T.value=!0,V.value=!0},Ge=t=>{p.value=t.labelNumber,x.value=t.location,h.value=t},me=()=>{V.value=!1,m.value=null,p.value="",x.value="",h.value=null,T.value=!1},Te=()=>{!m.value||!p.value||(T.value?(f.value.push({isbn:m.value.isbn,labelNumber:p.value,location:x.value,book:h.value}),me()):(V.value=!1,q.value=!0))},Ie=async t=>{if(!y.value||!t)return;if(!X.value){await k(`${S}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(t.availableCount===0){await k("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await se(y.value.uid,t.isbn,_.value);if(e){await k(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const i=t.copies.filter(o=>!P(o));if(i.length===1){const o=i[0];m.value=t,p.value=o.labelNumber,x.value=o.location,h.value=o,T.value=!1,q.value=!0}else m.value=t,p.value="",x.value="",h.value=null,T.value=!1,V.value=!0},Z=()=>{q.value=!1,m.value=null,p.value="",x.value="",h.value=null},Me=()=>{j.value=!0},Fe=async()=>{if(!m.value||!p.value||!h.value)return;const t=xe(J.value,_.value);try{$.value=!0,t?(await oe(p.value,_.value,y.value.uid,m.value.isbn),await Promise.all([A(),Y()]),Z(),await k("도서 대여가 완료되었습니다.",{type:"success"})):(await le(p.value,_.value,y.value.uid,m.value.isbn),await A(),Z(),await k(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(e){console.error("대여 처리 오류:",e),await k(e.message||"대여 처리에 실패했습니다.",{type:"error"})}finally{$.value=!1}},We=async()=>{if(f.value.length===0||!y.value)return;const t=xe(J.value,_.value);if(t){if(!X.value){await k(`${S}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(f.value.length>E.value){await k(`현재 ${E.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}}const e=f.value.map(o=>`${o.book.title} (${o.labelNumber})`).join(`
`),i=t?`다음 도서들을 대여하시겠습니까?

${e}`:`대여 신청하시겠습니까?
(관리자 승인 후 대여 가능)

${e}`;if(await De(i))try{$.value=!0;const o=f.value.length;if(t){for(const u of f.value)await oe(u.labelNumber,_.value,y.value.uid,u.isbn);await Promise.all([A(),Y()]),await k(`${o}권의 도서 대여가 완료되었습니다.`,{type:"success"})}else{for(const u of f.value)await le(u.labelNumber,_.value,y.value.uid,u.isbn);await A(),await k(`${o}권의 도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"})}f.value=[]}catch(o){console.error("대여 신청 오류:",o),await k(o.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{$.value=!1}};return ut({title:"도서 대여 - CNX Library",meta:[{name:"description",content:"센터별 도서 대여 신청"}]}),(t,e)=>{const i=w("v-select"),o=w("v-text-field"),u=w("v-btn"),B=w("v-progress-circular"),I=tt,H=w("v-col"),M=w("v-row"),C=w("v-icon"),ee=st,te=nt,ae=w("v-navigation-drawer"),be=w("v-card-title"),_e=w("v-card-text"),fe=w("v-spacer"),pe=w("v-card-actions"),we=w("v-card"),ke=w("v-dialog"),Oe=w("v-alert"),je=at,Xe=w("v-app");return v(),Q(Xe,null,{default:r(()=>[n(ee,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[3]||(e[3]=s=>z.value=!a(z))},{default:r(()=>[l("div",ct,[l("div",dt,[l("div",vt,[l("h1",mt,d(a(_))+" 도서 대여 ",1),n(i,{modelValue:a(_),"onUpdate:modelValue":[e[0]||(e[0]=s=>L(_)?_.value=s:null),$e],items:ie,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),l("div",bt,[l("div",_t,[l("div",ft,[l("div",pt,[e[8]||(e[8]=c(" 총 ",-1)),l("strong",null,d(a(Ee)),1),c("권 ("+d(a(Ae))+"종) ",1)])]),l("div",wt,[n(o,{modelValue:a(R),"onUpdate:modelValue":[e[1]||(e[1]=s=>L(R)?R.value=s:null),qe],label:"도서 검색",placeholder:"도서명 또는 ISBN-13으로 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"registered-search-input"},null,8,["modelValue"]),n(i,{modelValue:a(G),"onUpdate:modelValue":e[2]||(e[2]=s=>L(G)?G.value=s:null),items:Ve,label:"정렬",variant:"outlined",density:"comfortable","hide-details":"",class:"sort-select"},null,8,["modelValue"])]),l("div",kt,[l("div",gt,[a(D)>=S?(v(),g(F,{key:0},[c(d(S)+"권 대여중 (반납 후 대여 가능) ")],64)):a(f).length>0?(v(),g(F,{key:1},[c(d(a(f).length)+"권 선택됨 ("+d(a(D))+"권 대여중, "+d(a(E))+"권 추가 가능) ",1)],64)):(v(),g(F,{key:2},[c(" 대여할 도서를 선택하세요 ("+d(a(D))+"권 대여중, "+d(a(E))+"권 추가 가능) ",1)],64))]),n(u,{class:"rent-request-btn",variant:"flat",size:"small",disabled:a(f).length===0||!a(X),loading:a($),onClick:We},{default:r(()=>[...e[9]||(e[9]=[c(" 대여 신청 ",-1)])]),_:1},8,["disabled","loading"])])]),a(K)?(v(),g("div",ht,[n(B,{indeterminate:"",color:"primary"})])):a(ue).length>0?(v(),g("div",yt,[n(M,{class:"book-list-row"},{default:r(()=>[(v(!0),g(F,null,Ce(a(ue),(s,ge)=>(v(),Q(H,{key:`group-${ge}`,cols:"12",sm:"6",class:"book-list-col"},{default:r(()=>[n(I,{book:ce(s),center:a(_),"registered-books":[ce(s)],"is-registered":!0,"show-action":!1,selectable:!0,selected:de(s),status:Ue(s),"show-status-flags":!0,disabled:Pe(s),"hide-overdue-status":!0,"show-rent-button":!0,"show-location":!0,locations:s.locations,"show-quantity":s.totalCount>1,"available-count":s.availableCount,"total-count":s.totalCount,onSelect:()=>ze(s),onRent:()=>Ie(s)},null,8,["book","center","registered-books","selected","status","disabled","locations","show-quantity","available-count","total-count","onSelect","onRent"])]),_:2},1024))),128))]),_:1})])):(v(),g("div",Ct,[n(C,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:r(()=>[c(d(a(R)?"mdi-book-search-outline":"mdi-book-off-outline"),1)]),_:1}),a(R)?(v(),g("p",xt,[e[10]||(e[10]=c(" '",-1)),l("strong",null,d(a(R)),1),e[11]||(e[11]=c("'에 대한 검색 결과가 없습니다. ",-1))])):(v(),g("p",Bt," 등록된 도서가 없습니다. "))]))])])]),_:1}),n(ae,{modelValue:a(z),"onUpdate:modelValue":e[4]||(e[4]=s=>L(z)?z.value=s:null),location:"right",temporary:"",width:a(ne),class:"side-navigation"},{default:r(()=>[l("div",Rt,[n(te)])]),_:1},8,["modelValue","width"]),n(ke,{modelValue:a(V),"onUpdate:modelValue":e[5]||(e[5]=s=>L(V)?V.value=s:null),"max-width":"450",persistent:""},{default:r(()=>[n(we,{class:"label-select-card"},{default:r(()=>[n(be,{class:"label-select-title"},{default:r(()=>[...e[12]||(e[12]=[c(" 대여할 도서 선택 ",-1)])]),_:1}),n(_e,{class:"label-select-content"},{default:r(()=>[a(m)?(v(),g("div",Dt,[l("div",Nt,[a(m).image?(v(),g("img",{key:0,src:a(m).image,alt:a(m).title,class:"book-thumbnail"},null,8,Vt)):U("",!0),l("div",Lt,[l("div",St,d(a(m).title),1),l("div",$t,d(a(m).author),1)])])])):U("",!0),l("div",qt,[l("div",Et," 대여 가능한 도서 ("+d(a(ve).length)+"권) ",1),(v(!0),g(F,null,Ce(a(ve),s=>(v(),g("div",{key:s.id,class:Ze(["label-option",{selected:a(p)===s.labelNumber}]),onClick:ge=>Ge(s)},[l("div",Ut,[l("div",Pt,[n(C,{size:"small",class:"mr-1"},{default:r(()=>[...e[13]||(e[13]=[c(" mdi-label ",-1)])]),_:1}),c(" "+d(s.labelNumber||"라벨없음"),1)]),l("div",zt,[n(C,{size:"small",class:"mr-1"},{default:r(()=>[...e[14]||(e[14]=[c(" mdi-map-marker ",-1)])]),_:1}),c(" "+d(a(Be)(s.location)||"위치없음"),1)])]),a(p)===s.labelNumber?(v(),Q(C,{key:0,color:"primary"},{default:r(()=>[...e[15]||(e[15]=[c(" mdi-check-circle ",-1)])]),_:1})):U("",!0)],10,At))),128))])]),_:1}),n(pe,{class:"label-select-actions"},{default:r(()=>[n(fe),n(u,{variant:"text",onClick:me},{default:r(()=>[...e[16]||(e[16]=[c(" 취소 ",-1)])]),_:1}),n(u,{color:"primary",variant:"flat",disabled:!a(p),onClick:Te},{default:r(()=>[...e[17]||(e[17]=[c(" 선택 완료 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(ke,{modelValue:a(q),"onUpdate:modelValue":e[6]||(e[6]=s=>L(q)?q.value=s:null),"max-width":"500",persistent:""},{default:r(()=>[n(we,{class:"rent-confirm-card"},{default:r(()=>[n(be,{class:"rent-confirm-title"},{default:r(()=>[...e[18]||(e[18]=[c(" 대여 확인 ",-1)])]),_:1}),n(_e,{class:"rent-confirm-content"},{default:r(()=>[e[25]||(e[25]=l("div",{class:"rent-confirm-info mb-4"},[l("p",null,"아래 정보를 확인 후 대여해주세요.")],-1)),a(h)?(v(),g("div",Gt,[l("div",Tt,[a(h).image?(v(),g("img",{key:0,src:a(h).image,alt:a(h).title,class:"book-thumbnail"},null,8,It)):U("",!0),l("div",Mt,[l("div",Ft,d(a(h).title),1),l("div",Wt,d(a(h).author),1)])])])):U("",!0),l("div",Ot,[l("div",jt,[n(C,{size:"small",class:"mr-2"},{default:r(()=>[...e[19]||(e[19]=[c(" mdi-label ",-1)])]),_:1}),e[20]||(e[20]=l("span",{class:"detail-label"},"라벨번호:",-1)),l("span",Xt,d(a(p)),1)]),l("div",Ht,[n(C,{size:"small",class:"mr-2"},{default:r(()=>[...e[21]||(e[21]=[c(" mdi-map-marker ",-1)])]),_:1}),e[23]||(e[23]=l("span",{class:"detail-label"},"위치:",-1)),l("span",Qt,d(a(Be)(a(x))),1),a(Le)?(v(),Q(u,{key:0,variant:"text",size:"small",color:"primary",class:"ml-2",onClick:Me},{default:r(()=>[...e[22]||(e[22]=[c(" 위치 보기 ",-1)])]),_:1})):U("",!0)])]),n(Oe,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:r(()=>[...e[24]||(e[24]=[c(" 위치와 라벨번호를 확인 후 해당 도서를 가져가주세요. ",-1)])]),_:1})]),_:1}),n(pe,{class:"rent-confirm-actions"},{default:r(()=>[n(fe),n(u,{variant:"text",onClick:Z},{default:r(()=>[...e[26]||(e[26]=[c(" 취소 ",-1)])]),_:1}),n(u,{color:"primary",variant:"flat",loading:a($),onClick:Fe},{default:r(()=>[...e[27]||(e[27]=[c(" 대여하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(je,{modelValue:a(j),"onUpdate:modelValue":e[7]||(e[7]=s=>L(j)?j.value=s:null),center:a(_),location:a(x),"label-number":a(p)},null,8,["modelValue","center","location","label-number"])]),_:1})}}},na=He(Jt,[["__scopeId","data-v-9c9ce745"]]);export{na as default};
