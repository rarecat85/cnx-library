const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BPJYhxNG.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as X,k as g,r as J,g as O,O as T,H as b,L as y,G as w,T as A,I as h,P as i,M as c,J as v,K as B,S as F,U as V,W as Z,a as _,ai as K,_ as ee,al as W,am as P,an as j,ao as q,aq as te,ar as se,as as re,at as oe}from"./BPJYhxNG.js";import{g as U,h as Y}from"./Cc9NgCqJ.js";const ne={key:0,class:"book-card-header"},ae={class:"book-card-inner"},le={class:"book-image-wrapper"},ie={class:"book-card-content"},ue={class:"book-title mb-2"},de={class:"book-info text-body-2 mb-1"},ce={class:"book-info book-info-publisher text-body-2"},fe={key:1,class:"book-action-area book-action-area-admin"},be={class:"admin-info-text text-body-2"},me={key:2,class:"book-action-area"},ke={key:3,class:"book-action-area book-action-area-admin"},ye={class:"admin-info-text text-body-2"},we={key:4,class:"book-action-area book-action-area-mypage"},ve={key:5,class:"book-action-area"},ge={key:0,class:"rented-text text-body-2"},he={key:1,class:"requested-status-text text-body-2"},Be={key:0,class:"registered-text text-body-2"},Re={key:1,class:"requested-text text-body-2"},De={key:0,class:"admin-info-text text-body-2 requested-badge"},xe={key:1,class:"admin-info-text text-body-2"},Ae={__name:"BookCard",props:{book:{type:Object,required:!0},center:{type:String,required:!0},registeredBooks:{type:Array,default:()=>[]},isRegistered:{type:Boolean,default:!1},showAction:{type:Boolean,default:!0},selectable:{type:Boolean,default:!1},selected:{type:Boolean,default:!1},status:{type:String,default:null},showStatusFlags:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},actionButtonText:{type:String,default:""},registeredMessage:{type:String,default:""},requestedBooks:{type:Array,default:()=>[]},requestedMessage:{type:String,default:""},hideOverdueStatus:{type:Boolean,default:!1},showReturnDate:{type:Boolean,default:!1},returnDate:{type:[Date,Object,String],default:null},showRentButton:{type:Boolean,default:!1},renterInfo:{type:String,default:""},requesterInfo:{type:String,default:""},showAdminRentButton:{type:Boolean,default:!1},showAdminReturnButton:{type:Boolean,default:!1},allowRegisterRequested:{type:Boolean,default:!1}},emits:["register","select","return","rent","adminRent","adminReturn"],setup(o,{emit:E}){const t=o,u=E,m=g(()=>t.book.cover||t.book.image||"/placeholder-book.png"),D=g(()=>{if(t.isRegistered)return!0;const l=t.book.isbn13||t.book.isbn||"";return l?t.registeredBooks.some(e=>{const x=e.isbn13||e.isbn||e.id||"",S=l.toString().trim(),R=x.toString().trim();return S===R&&e.center===t.center}):!1}),z=g(()=>{const l=t.book.isbn13||t.book.isbn||"";return l?t.requestedBooks.some(e=>{const x=e.isbn13||e.isbn||"",S=l.toString().trim(),R=x.toString().trim();return S===R&&e.center===t.center}):!1}),p=J(!1),G=async()=>{if(!p.value)try{p.value=!0,u("register",t.book)}finally{setTimeout(()=>{p.value=!1},1e3)}},L=g(()=>{if(t.book.registeredAt){const l=t.book.registeredAt?.toDate?.()||new Date(t.book.registeredAt),e=new Date;return e.setMonth(e.getMonth()-1),l>=e}return!1}),I=g(()=>t.status?t.status:null),M=g(()=>{const l=I.value;return t.hideOverdueStatus&&l==="overdue"?"대여중":{new:"NEW",rented:"대여중",overdue:"연체중",requested:"대여신청"}[l]||""}),H=g(()=>{const l=I.value;return t.hideOverdueStatus&&l==="overdue"?"info":{new:"primary",rented:"info",overdue:"error",requested:"warning"}[l]||"primary"}),$=g(()=>I.value==="rented"||I.value==="overdue"),N=g(()=>I.value==="requested"),s=()=>{t.selectable&&!t.disabled&&u("select",t.book,!t.selected)},n=()=>{u("return",t.book)},a=()=>{u("rent",t.book)},r=()=>{u("adminRent",t.book)},f=()=>{u("adminReturn",t.book)},d=g(()=>{if(!t.returnDate)return"";const l=t.returnDate?.toDate?.()||new Date(t.returnDate),e=l.getFullYear(),x=String(l.getMonth()+1).padStart(2,"0"),S=String(l.getDate()).padStart(2,"0");return`${e}.${x}.${S}`}),k=g(()=>t.returnDate?(t.returnDate?.toDate?.()||new Date(t.returnDate))<new Date:!1);return(l,e)=>{const x=O("v-chip"),S=O("v-img"),R=O("v-icon"),C=O("v-btn"),Q=O("v-card");return b(),T(Q,{class:V(["book-card",{"book-card-selected":o.selectable&&o.selected,"book-card-disabled":o.disabled}]),elevation:"0",onClick:e[0]||(e[0]=qe=>o.selectable?s():null)},{default:y(()=>[o.showStatusFlags&&(i(M)||i(L))?(b(),w("div",ne,[i(L)?(b(),T(x,{key:0,color:"primary",size:"x-small",variant:"flat",class:"status-chip"},{default:y(()=>[...e[1]||(e[1]=[c(" NEW ",-1)])]),_:1})):A("",!0),i(M)?(b(),T(x,{key:1,color:i(H),size:"x-small",variant:"flat",class:"status-chip"},{default:y(()=>[c(v(i(M)),1)]),_:1},8,["color"])):A("",!0)])):A("",!0),h("div",ae,[h("div",le,[B(S,{src:i(m),alt:o.book.title,height:"100%",cover:"",class:"book-image"},null,8,["src","alt"])]),h("div",ie,[h("div",ue,v(o.book.title),1),h("div",de,[e[2]||(e[2]=h("strong",null,"저자:",-1)),c(" "+v(o.book.author),1)]),h("div",ce,[e[3]||(e[3]=h("strong",null,"출판사:",-1)),c(" "+v(o.book.publisher),1)])])]),o.showAdminRentButton&&i(N)&&o.requesterInfo?(b(),w("div",fe,[h("div",be,[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[4]||(e[4]=[c(" mdi-account-clock ",-1)])]),_:1}),c(" "+v(o.requesterInfo),1)]),B(C,{color:"primary",size:"small",class:"admin-rent-btn mt-2",onClick:F(r,["stop"])},{default:y(()=>[...e[5]||(e[5]=[c(" 대여 처리 ",-1)])]),_:1})])):o.showAdminRentButton&&!i($)&&!i(N)?(b(),w("div",me,[B(C,{color:"primary",size:"small",class:"admin-rent-btn",onClick:F(r,["stop"])},{default:y(()=>[...e[6]||(e[6]=[c(" 대여 처리 ",-1)])]),_:1})])):o.renterInfo&&i($)?(b(),w("div",ke,[h("div",ye,[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[7]||(e[7]=[c(" mdi-account ",-1)])]),_:1}),c(" "+v(o.renterInfo),1)]),o.returnDate?(b(),w("div",{key:0,class:V(["return-date-text text-body-2",{"return-date-overdue":i(k)}])},[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[8]||(e[8]=[c(" mdi-calendar-clock ",-1)])]),_:1}),c(" 반납예정일: "+v(i(d)),1)],2)):A("",!0),o.showAdminReturnButton?(b(),T(C,{key:1,color:"primary",size:"small",class:"admin-return-btn mt-2",onClick:F(f,["stop"])},{default:y(()=>[...e[9]||(e[9]=[c(" 반납 처리 ",-1)])]),_:1})):A("",!0)])):A("",!0),o.showReturnDate&&o.returnDate?(b(),w("div",we,[B(C,{color:"primary",size:"small",class:"return-btn",onClick:F(n,["stop"])},{default:y(()=>[...e[10]||(e[10]=[c(" 반납하기 ",-1)])]),_:1}),h("div",{class:V(["return-date-text text-body-2",{"return-date-overdue":i(k)}])},[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[11]||(e[11]=[c(" mdi-calendar-clock ",-1)])]),_:1}),c(" 반납예정일: "+v(i(d)),1)],2)])):o.showRentButton?(b(),w("div",ve,[i($)?(b(),w("div",ge," 대여중인 도서입니다. ")):i(N)?(b(),w("div",he," 신청중인 도서입니다. ")):(b(),T(C,{key:2,color:"primary",size:"small",class:"rent-btn",onClick:F(a,["stop"])},{default:y(()=>[...e[12]||(e[12]=[c(" 대여 신청 ",-1)])]),_:1}))])):o.showAction?(b(),w("div",{key:6,class:V(["book-action-area",{"book-action-area-admin":(o.requesterInfo||i(z)&&o.allowRegisterRequested)&&!i(D)}])},[i(D)?(b(),w("div",Be,v(o.registeredMessage||`${o.center}에 등록된 도서입니다.`),1)):i(z)&&!o.allowRegisterRequested?(b(),w("div",Re,v(o.requestedMessage||`${o.center}에 이미 신청된 도서입니다.`),1)):(b(),w(Z,{key:2},[i(z)&&o.allowRegisterRequested?(b(),w("div",De,[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[13]||(e[13]=[c(" mdi-book-clock ",-1)])]),_:1}),e[14]||(e[14]=c(" 신청된 도서 ",-1))])):o.requesterInfo?(b(),w("div",xe,[B(R,{size:"small",class:"mr-1"},{default:y(()=>[...e[15]||(e[15]=[c(" mdi-account-clock ",-1)])]),_:1}),c(" "+v(o.requesterInfo),1)])):A("",!0),B(C,{color:"primary",size:"small",loading:i(p),disabled:i(p),class:V(["register-btn",{"mt-2":o.requesterInfo||i(z)&&o.allowRegisterRequested}]),onClick:F(G,["stop"])},{default:y(()=>[c(v(o.actionButtonText||`${o.center}에 등록하기`),1)]),_:1},8,["loading","disabled","class"])],64))],2)):A("",!0)]),_:1},8,["class"])}}},Se=X(Ae,[["__scopeId","data-v-497fe37f"]]),Ee=()=>{const{$firebaseFirestore:o,$firebaseApp:E}=_(),t=o,u=J(!1),m=J(null),D=(s,n)=>`${s}_${n}`,z=async(s,n=1,a=20)=>{if(!t||!E)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const r=U(E),d=await Y(r,"searchAladinBooks")({query:s,start:n,display:a});if(d.data.success)return d.data.data;throw new Error(d.data.error||"도서 검색에 실패했습니다.")}catch(r){throw console.error("도서 검색 오류:",r),m.value=r.message||"도서 검색에 실패했습니다.",r}finally{u.value=!1}},p=async(s,n,a)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const r=s.isbn13||s.isbn||"";if(!r)throw new Error("ISBN 정보가 없습니다.");const f=D(r,n),d=W(t,"books",f);if((await P(d)).exists())throw new Error("이미 해당 센터에 등록된 도서입니다.");const l={isbn:r,isbn13:s.isbn13||"",isbn10:s.isbn||"",title:s.title||"",author:s.author||"",publisher:s.publisher||"",pubdate:s.pubDate||s.pubdate||"",description:s.description||"",image:s.cover||s.image||"",link:s.link||"",center:n,status:"available",registeredBy:a,registeredAt:q(),updatedAt:q()};return await j(d,l),{success:!0,book:l,bookId:f}}catch(r){throw console.error("도서 등록 오류:",r),m.value=r.message||"도서 등록에 실패했습니다.",r}finally{u.value=!1}},G=async(s=null)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const n=te(t,"books");let a;s?a=se(n,re("center","==",s)):a=n;const r=await oe(a),f=[];return r.forEach(d=>{f.push({id:d.id,...d.data()})}),f.sort((d,k)=>{const l=d.registeredAt?.toDate?.()||new Date(0);return(k.registeredAt?.toDate?.()||new Date(0))-l}),f}catch(n){throw console.error("도서 목록 조회 오류:",n),m.value=n.message||"도서 목록 조회에 실패했습니다.",n}finally{u.value=!1}},L=async(s=10)=>{if(!t||!E)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const n=U(E),r=await Y(n,"getAladinBestsellers")({display:s});if(r.data.success)return r.data.data;throw new Error(r.data.error||"베스트셀러 조회에 실패했습니다.")}catch(n){throw console.error("베스트셀러 조회 오류:",n),m.value=n.message||"베스트셀러 조회에 실패했습니다.",n}finally{u.value=!1}},I=async(s,n,a)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const r=D(s,n),f=W(t,"books",r),d=await P(f);if(!d.exists())throw new Error("도서를 찾을 수 없습니다.");const k=d.data();if(k.status==="rented"&&k.rentedBy)throw new Error("이미 대여 중인 도서입니다.");const l=new Date,e=new Date(l);return e.setDate(e.getDate()+7),await j(f,{status:"rented",rentedBy:a,rentedAt:q(),expectedReturnDate:e,updatedAt:q()},{merge:!0}),{success:!0}}catch(r){throw console.error("도서 대여 오류:",r),m.value=r.message||"도서 대여에 실패했습니다.",r}finally{u.value=!1}},M=async(s,n)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const a=D(s,n),r=W(t,"books",a),f=await P(r);if(!f.exists())throw new Error("도서를 찾을 수 없습니다.");if(f.data().status!=="rented")throw new Error("대여 중이 아닌 도서입니다.");return await j(r,{status:"available",rentedBy:null,rentedAt:null,expectedReturnDate:null,returnedAt:q(),updatedAt:q()},{merge:!0}),{success:!0}}catch(a){throw console.error("도서 반납 오류:",a),m.value=a.message||"도서 반납에 실패했습니다.",a}finally{u.value=!1}},H=async(s,n)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const{deleteDoc:a}=await ee(async()=>{const{deleteDoc:d}=await import("./BPJYhxNG.js").then(k=>k.aB);return{deleteDoc:d}},__vite__mapDeps([0,1]),import.meta.url),r=D(s,n),f=W(t,"books",r);return await a(f),{success:!0}}catch(a){throw console.error("도서 삭제 오류:",a),m.value=a.message||"도서 삭제에 실패했습니다.",a}finally{u.value=!1}},$=async(s,n,a)=>{if(!t)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,m.value=null;const r=D(s,n),f=W(t,"books",r),d=await P(f);if(!d.exists())throw new Error("도서를 찾을 수 없습니다.");const k=d.data();if(k.status==="rented"&&k.rentedBy)throw new Error("이미 대여 중인 도서입니다.");if(k.status==="requested"&&k.requestedBy)throw new Error("이미 대여 신청된 도서입니다.");return await j(f,{status:"requested",requestedBy:a,requestedAt:q(),updatedAt:q()},{merge:!0}),{success:!0}}catch(r){throw console.error("도서 대여 신청 오류:",r),m.value=r.message||"도서 대여 신청에 실패했습니다.",r}finally{u.value=!1}},N=s=>{if(!s||s.status==="deleted")return null;if(s.status==="requested"&&s.requestedBy)return"requested";if(s.status==="rented"&&s.rentedAt){const n=s.rentedAt?.toDate?.()||new Date(s.rentedAt),a=new Date(n);return a.setDate(a.getDate()+7),new Date>a?"overdue":"rented"}return null};return{loading:K(u),error:K(m),createBookId:D,searchBooks:z,registerBook:p,getBooksByCenter:G,getBestsellers:L,rentBook:I,requestRent:$,returnBook:M,deleteBook:H,calculateBookStatus:N}};export{Se as _,Ee as u};
