const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./D3YUa0Cc.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as Q,c as Z,g as W,h as Y}from"./CRJr_llW.js";import{F as ee,a as oe,u as te,Z as re,r as S,o as se,_ as x,O as ae,L as D,g as L,H as P,K as b,I as m,G as z,S as ie,P as U,M as T,J as ne}from"./D3YUa0Cc.js";import{_ as ce,a as le}from"./CJEW9Xdq.js";import{u as ue}from"./BLOrbh-U.js";const H=Object.freeze(Object.defineProperty({__proto__:null,FunctionsError:Q,connectFunctionsEmulator:Z,getFunctions:W,httpsCallable:Y},Symbol.toStringTag,{value:"Module"})),de={key:0,class:"text-center py-8"},fe={key:1,class:"text-center"},me={key:2,class:"text-center"},pe={class:"error-text mb-6"},ve={class:"logo-bottom text-center mt-6"},ge={class:"logo-with-credit"},ye={__name:"verify-email",setup(_e){const{$firebaseAuth:G,$firebaseFirestore:J,$firebaseApp:M}=oe(),B=te(),X=re(),d=S(!0),A=S(!1),w=S(!1),f=S(""),R=X.query.mode,q=X.query.oobCode;se(async()=>{if(!R||!q){w.value=!0,f.value="잘못된 인증 링크입니다.",d.value=!1;return}if(R==="resetPassword"){await B.push({path:"/reset-password",query:{mode:R,oobCode:q}});return}if(R!=="verifyEmail"){w.value=!0,f.value="지원하지 않는 인증 모드입니다.",d.value=!1;return}try{const{applyActionCode:g,checkActionCode:s}=await x(async()=>{const{applyActionCode:c,checkActionCode:h}=await import("./D3YUa0Cc.js").then(t=>t.aE);return{applyActionCode:c,checkActionCode:h}},__vite__mapDeps([0,1]),import.meta.url),{collection:E,query:y,where:_,getDocs:F,doc:p,getDoc:N,setDoc:j,serverTimestamp:k}=await x(async()=>{const{collection:c,query:h,where:t,getDocs:o,doc:i,getDoc:n,setDoc:l,serverTimestamp:C}=await import("./D3YUa0Cc.js").then(V=>V.aF);return{collection:c,query:h,where:t,getDocs:o,doc:i,getDoc:n,setDoc:l,serverTimestamp:C}},__vite__mapDeps([0,1]),import.meta.url),I=G,u=J;if(!I||!u)throw new Error("Firebase가 초기화되지 않았습니다.");let e=null,v=null;try{v=await s(I,q),e=v.data.email,console.log("actionCodeInfo:",v),console.log("이메일 추출:",e),!e&&v.data&&(e=v.data.email,console.log("actionCodeInfo.data에서 이메일 재확인:",e))}catch(c){if(c.code==="auth/invalid-action-code")console.log("checkActionCode가 invalid-action-code로 실패, applyActionCode 시도");else throw c}let r=null,a=null;if(e)try{const c=E(u,"users"),h=y(c,_("email","==",e)),t=await F(h);if(t.empty)console.warn("Firestore에서 사용자를 찾을 수 없습니다:",e);else{const o=t.docs[0];r=p(u,"users",o.id),a=o.data(),console.log("Firestore 사용자 데이터:",a),console.log("emailVerified 값:",a?.emailVerified,"타입:",typeof a?.emailVerified)}}catch(c){console.error("Firestore 쿼리 오류:",c)}try{await g(I,q);const{getAuth:c}=await x(async()=>{const{getAuth:o}=await import("./D3YUa0Cc.js").then(i=>i.aE);return{getAuth:o}},__vite__mapDeps([0,1]),import.meta.url),t=c().currentUser;if(!r){if(t&&t.uid)try{r=p(u,"users",t.uid);const o=await N(r);o.exists()?(a=o.data(),e=e||t.email||a.email,console.log("현재 사용자 UID로 찾은 사용자:",a)):r=null}catch(o){console.error("UID로 사용자 찾기 오류:",o),r=null}if(!r&&e)try{const o=E(u,"users"),i=y(o,_("email","==",e)),n=await F(i);if(!n.empty){const l=n.docs[0];r=p(u,"users",l.id),a=l.data(),console.log("이메일로 찾은 사용자:",a)}}catch(o){console.error("재시도 Firestore 쿼리 오류:",o)}if(!r&&!e&&v&&v.data&&v.data.email){e=v.data.email;try{const o=E(u,"users"),i=y(o,_("email","==",e)),n=await F(i);if(!n.empty){const l=n.docs[0];r=p(u,"users",l.id),a=l.data(),console.log("actionCodeInfo에서 이메일로 찾은 사용자:",a)}}catch(o){console.error("actionCodeInfo 이메일로 Firestore 쿼리 오류:",o)}}if(!r&&t&&t.email){e=e||t.email;try{const o=E(u,"users"),i=y(o,_("email","==",e)),n=await F(i);if(!n.empty){const l=n.docs[0];r=p(u,"users",l.id),a=l.data(),console.log("현재 사용자 이메일로 찾은 사용자:",a)}}catch(o){console.error("현재 사용자 이메일로 Firestore 쿼리 오류:",o)}}}if(r)try{await j(r,{emailVerified:!0,emailVerifiedAt:k(),updatedAt:k()},{merge:!0}),console.log("Firestore 업데이트 완료. email:",e,"uid:",t?.uid)}catch(o){if(console.error("Firestore 업데이트 오류:",o),o.code==="permission-denied"&&e){console.log("권한 오류로 Functions를 통해 업데이트 시도:",e);try{const{getFunctions:i,httpsCallable:n}=await x(async()=>{const{getFunctions:O,httpsCallable:K}=await Promise.resolve().then(()=>H);return{getFunctions:O,httpsCallable:K}},void 0,import.meta.url),l=i(M),V=await n(l,"updateEmailVerificationStatus")({email:e});V.data.success?console.log("Functions를 통해 Firestore 업데이트 완료:",e):console.error("Functions 업데이트 실패:",V.data.error)}catch(i){console.error("Functions 호출 오류:",i)}}}else if(e){console.log("userRef를 찾지 못했지만 이메일이 있으므로 Functions를 통해 업데이트 시도:",e);try{const{getFunctions:o,httpsCallable:i}=await x(async()=>{const{getFunctions:V,httpsCallable:O}=await Promise.resolve().then(()=>H);return{getFunctions:V,httpsCallable:O}},void 0,import.meta.url),n=o(M),C=await i(n,"updateEmailVerificationStatus")({email:e});if(C.data.success)console.log("Functions를 통해 Firestore 업데이트 완료:",e);else{console.error("Functions 업데이트 실패:",C.data.error),w.value=!0,f.value=C.data.error||"이메일 인증 상태 업데이트에 실패했습니다.",d.value=!1;return}}catch(o){console.error("Functions 호출 오류:",o),w.value=!0,f.value="이메일 인증 상태 업데이트에 실패했습니다. 관리자에게 문의해주세요.",d.value=!1;return}}else{console.error("userRef와 이메일을 모두 찾을 수 없어서 Firestore 업데이트를 할 수 없습니다."),console.error("currentUser:",t),console.error("actionCodeInfo:",v),w.value=!0,f.value="인증은 완료되었지만 사용자 정보를 찾을 수 없어 업데이트에 실패했습니다. 관리자에게 문의해주세요.",d.value=!1;return}A.value=!0,d.value=!1}catch(c){if(console.log("applyActionCode 에러:",c.code,c.message),console.log("userData.emailVerified:",a?.emailVerified),c.code==="auth/invalid-action-code"){if(!e&&!r){console.log("이메일과 userRef를 모두 찾을 수 없어서 현재 로그인된 사용자 확인 시도");try{const t=I.currentUser;if(t&&t.email){console.log("auth.currentUser 발견:",t.email),e=t.email;try{const o=E(u,"users"),i=y(o,_("email","==",e)),n=await F(i);if(n.empty)r=p(u,"users",t.uid),a=null,console.log("Firestore에 사용자 정보가 없어서 UID로 생성:",t.uid);else{const l=n.docs[0];r=p(u,"users",l.id),a=l.data(),console.log("auth.currentUser로 찾은 Firestore 데이터:",a)}}catch(o){console.error("Firestore 쿼리 오류:",o)}}}catch(t){console.error("현재 사용자 확인 오류:",t)}}if(!e&&!r){console.warn("이메일과 userRef를 모두 찾을 수 없지만, 이미 인증된 상태로 간주"),A.value=!0,d.value=!1;return}if(!r&&e){console.log("userRef가 없어서 다시 찾기 시도:",e);try{const t=E(u,"users"),o=y(t,_("email","==",e)),i=await F(o);if(!i.empty){const n=i.docs[0];r=p(u,"users",n.id),a=n.data(),console.log("재시도로 찾은 사용자 데이터:",a)}}catch(t){console.error("재시도 Firestore 쿼리 오류:",t)}}const h=a&&a.emailVerified===!0;if(console.log("isEmailVerified:",h,"userData.emailVerified:",a?.emailVerified),h)w.value=!0,f.value="이미 이메일 인증이 완료된 계정입니다.",d.value=!1;else if(r){console.log("Firestore 업데이트 시도 중... userRef:",r);try{await j(r,{emailVerified:!0,emailVerifiedAt:k(),updatedAt:k()},{merge:!0}),console.log("Firestore 업데이트 완료 (invalid-action-code):",e),A.value=!0,d.value=!1}catch(t){throw console.error("Firestore 업데이트 오류:",t),new Error("Firestore 업데이트에 실패했습니다.")}}else console.warn("Firestore에서 사용자를 찾을 수 없지만, 이미 인증된 상태로 간주:",e),A.value=!0,d.value=!1}else throw c.code==="auth/expired-action-code",c}}catch(g){console.error("이메일 인증 오류:",g),w.value=!0,d.value=!1,g.code==="auth/expired-action-code"?f.value="인증 링크가 만료되었습니다. 새로운 인증 링크를 요청해주세요.":g.code==="auth/invalid-action-code"?f.value="이미 인증된 이메일이거나 유효하지 않은 인증 링크입니다.":g.code==="auth/user-disabled"?f.value="비활성화된 계정입니다.":g.code==="auth/user-not-found"?f.value="사용자를 찾을 수 없습니다.":f.value=g.message||"이메일 인증에 실패했습니다."}});const $=()=>{B.push("/login")};return ue({title:"이메일 인증 - CNX Library",link:[{rel:"preconnect",href:"https://fonts.googleapis.com"},{rel:"preconnect",href:"https://fonts.gstatic.com",crossorigin:""},{rel:"stylesheet",href:"https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"}]}),(g,s)=>{const E=L("v-progress-circular"),y=L("v-icon"),_=L("v-btn"),F=le,p=ce,N=L("v-app");return P(),ae(N,null,{default:D(()=>[b(p,null,{default:D(()=>[s[9]||(s[9]=m("div",{class:"text-center mb-8"},[m("h1",{class:"login-title mb-2"}," CNX Library "),m("p",{class:"login-subtitle"}," 이메일 인증 ")],-1)),U(d)?(P(),z("div",de,[b(E,{indeterminate:"",color:"primary",size:"64",class:"mb-4"}),s[0]||(s[0]=m("p",{class:"verifying-text"}," 이메일 인증을 처리하는 중입니다... ",-1))])):U(A)?(P(),z("div",fe,[b(y,{color:"success",size:"64",class:"mb-4"},{default:D(()=>[...s[1]||(s[1]=[T(" mdi-check-circle ",-1)])]),_:1}),s[3]||(s[3]=m("h2",{class:"success-title mb-4"}," 이메일 인증이 완료되었습니다! ",-1)),s[4]||(s[4]=m("p",{class:"success-text mb-6"}," 이제 로그인하여 CNX Library를 이용하실 수 있습니다. ",-1)),b(_,{block:"",size:"large",class:"login-btn",elevation:"2",onClick:$},{default:D(()=>[...s[2]||(s[2]=[T(" 로그인하기 ",-1)])]),_:1})])):U(w)?(P(),z("div",me,[b(y,{color:"error",size:"64",class:"mb-4"},{default:D(()=>[...s[5]||(s[5]=[T(" mdi-alert-circle ",-1)])]),_:1}),s[7]||(s[7]=m("h2",{class:"error-title mb-4"}," 인증에 실패했습니다 ",-1)),m("p",pe,ne(U(f)),1),b(_,{block:"",size:"large",class:"login-btn",elevation:"2",onClick:$},{default:D(()=>[...s[6]||(s[6]=[T(" 로그인 페이지로 이동 ",-1)])]),_:1})])):ie("",!0),m("div",ve,[m("div",ge,[b(F),s[8]||(s[8]=m("span",{class:"credit-text"},"© rarecat",-1))])])]),_:1})]),_:1})}}},be=ee(ye,[["__scopeId","data-v-022cfbda"]]);export{be as default};
