const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ES9emHaY.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as Ke,N as Ye,a as Ze,D as et,r as b,k as N,o as De,e as tt,_ as Ve,O as Y,L as n,g as y,H as c,K as s,P as o,I as a,J as d,Q as L,G as v,M as i,W as z,X as me,T as x,U as ot}from"./ES9emHaY.js";import{h as at,_ as lt,a as st}from"./ctd37_3a.js";import{g as nt,C as it,_ as rt,c as Ne}from"./soG2X86W.js";import{_ as ut}from"./BE83yxxI.js";import{u as ct,f as be}from"./ZgMz0SKc.js";import{u as dt}from"./WvfOeGZd.js";import{u as vt}from"./eEf3qI-Q.js";import"./7PxgnCfE.js";const mt={class:"books-page"},bt={class:"center-header mb-6"},ft={class:"center-header-inner"},_t={class:"page-title mb-0"},pt={class:"registered-books-section"},kt={class:"registered-books-header mb-0"},gt={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},yt={class:"text-body-1"},wt={class:"d-flex align-center registered-search-group"},ht={class:"d-flex align-center justify-space-between flex-wrap gap-4 mt-4"},Ct={class:"text-body-2 text-medium-emphasis"},xt={key:0,class:"text-center py-8 mt-6"},Rt={key:1,class:"registered-books-grid mt-6"},Bt={key:2,class:"text-center py-8 mt-6 text-medium-emphasis empty-state"},Dt={key:0},Vt={key:1},Nt={class:"drawer-content"},Lt={key:0,class:"book-info-preview mb-4"},St={class:"book-info-preview-inner"},Et=["src","alt"],qt={class:"book-meta"},At={class:"book-title"},$t={class:"book-author"},Ut={class:"label-select-list"},zt={class:"label-select-header mb-2"},Mt=["onClick"],Gt={class:"label-info"},Pt={class:"label-number"},It={class:"label-location"},Ot={key:0,class:"rent-book-card"},Tt={class:"rent-book-card-inner"},Ft=["src","alt"],Wt={key:1,class:"rent-book-thumbnail-placeholder"},Xt={class:"rent-book-meta"},jt={class:"rent-book-title"},Ht={key:0,class:"rent-book-author"},Qt={key:1,class:"rent-book-publisher"},Jt={class:"rent-book-details"},Kt={class:"detail-item"},Yt={class:"detail-item"},Zt={class:"rent-confirm-info mb-4"},eo={key:0,class:"text-caption text-grey mt-1"},to={class:"multi-rent-book-list"},oo={class:"rent-book-card-inner"},ao=["src","alt"],lo={key:1,class:"rent-book-thumbnail-placeholder"},so={class:"rent-book-meta"},no={class:"rent-book-title"},io={key:0,class:"rent-book-author"},ro={key:1,class:"rent-book-publisher"},uo={class:"rent-book-details"},co={class:"detail-item"},vo={class:"detail-item"},q=5,mo={__name:"index",setup(bo){const{user:C}=dt(),{getBooksByCenter:Le,calculateBookStatus:M,rentBook:fe,requestRent:_e,checkAlreadyRentedSameIsbn:pe}=ct(),{alert:w}=Ye(),{$firebaseFirestore:Se}=Ze(),W=Se,G=et("navigationDrawer",()=>!1),ke=b(280),ge=[...it],_=b(""),Z=b(""),X=b([]),ee=b(!1),D=b(""),P=b("date"),Ee=[{title:"등록일순",value:"date"},{title:"제목순",value:"title"}],p=b([]),S=b(!1),V=b(0),E=b(!1),f=b(null),k=b(""),R=b(""),g=b(null),I=b(!1),A=b(!1),O=b(!1),j=b(!1),H=b(!1),qe=N(()=>at(_.value));De(()=>{const t=()=>{ke.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),tt(()=>{window.removeEventListener("resize",t)})});const Ae=async()=>{if(!C.value||!W)return"";try{const{doc:t,getDoc:e}=await Ve(async()=>{const{doc:m,getDoc:B}=await import("./ES9emHaY.js").then(T=>T.aE);return{doc:m,getDoc:B}},__vite__mapDeps([0,1]),import.meta.url),u=t(W,"users",C.value.uid),r=await e(u);if(r.exists())return r.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};De(async()=>{const t=await Ae();Z.value=t,_.value=t?nt(t):ge[0],await Promise.all([U(),te()])});const te=async()=>{if(!C.value||!W){V.value=0;return}try{const{collection:t,query:e,where:u,getDocs:r}=await Ve(async()=>{const{collection:F,query:h,where:le,getDocs:se}=await import("./ES9emHaY.js").then(ne=>ne.aE);return{collection:F,query:h,where:le,getDocs:se}},__vite__mapDeps([0,1]),import.meta.url),m=t(W,"books"),B=e(m,u("rentedBy","==",C.value.uid)),T=await r(B);let J=0;T.forEach(F=>{const h=F.data();(h.status==="rented"||h.status==="overdue")&&J++}),V.value=J}catch(t){console.error("대여중인 도서 수 로드 오류:",t),V.value=0}},Q=N(()=>V.value<q),$=N(()=>q-V.value),$e=async()=>{p.value=[],await U()},U=async()=>{try{ee.value=!0;const t=await Le(_.value);X.value=t}catch(t){console.error("등록된 도서 로드 오류:",t),X.value=[]}finally{ee.value=!1}},Ue=()=>{},ye=N(()=>{const t=new Map;for(const e of X.value){const u=e.isbn13||e.isbn||e.id;t.has(u)||t.set(u,{isbn:u,title:e.title,author:e.author,publisher:e.publisher,image:e.image,copies:[],totalCount:0,availableCount:0,locations:[]});const r=t.get(u);r.copies.push(e),r.totalCount++,M(e)||(r.availableCount++,e.location&&!r.locations.includes(e.location)&&r.locations.push(e.location))}for(const e of t.values())e.copies.sort((u,r)=>{const m=u.labelNumber||"",B=r.labelNumber||"";return m.localeCompare(B,"ko")});return Array.from(t.values())}),we=N(()=>{let t=[...ye.value];if(D.value.trim()){const e=D.value.toLowerCase();t=t.filter(u=>{const r=(u.title||"").toLowerCase(),m=(u.author||"").toLowerCase(),B=(u.publisher||"").toLowerCase();return r.includes(e)||m.includes(e)||B.includes(e)})}return P.value==="title"?t.sort((e,u)=>{const r=(e.title||"").toLowerCase(),m=(u.title||"").toLowerCase();return r.localeCompare(m,"ko")}):P.value==="date"&&t.sort((e,u)=>{const r=e.copies[0]?.registeredAt?.toDate?.()||new Date(0);return(u.copies[0]?.registeredAt?.toDate?.()||new Date(0))-r}),t}),ze=N(()=>X.value.length),Me=N(()=>ye.value.length),he=t=>t.copies[0]||{title:t.title,author:t.author,publisher:t.publisher,image:t.image,isbn:t.isbn},Ge=t=>t.availableCount===0?t.copies.some(u=>M(u)==="requested")?"requested":"rented":null,Pe=t=>t.availableCount===0,Ce=t=>p.value.some(e=>e.isbn===t.isbn),xe=N(()=>f.value?f.value.copies.filter(t=>!M(t)):[]),Ie=async t=>{if(Ce(t)){p.value=p.value.filter(r=>r.isbn!==t.isbn);return}if(!Q.value){await w(`${q}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(p.value.length>=$.value){await w(`현재 ${$.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}if(t.availableCount===0){await w("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await pe(C.value.uid,t.isbn,_.value);if(e){await w(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const u=t.copies.filter(r=>!M(r));if(u.length===1){const r=u[0];p.value.push({isbn:t.isbn,labelNumber:r.labelNumber,location:r.location,book:r})}else f.value=t,k.value="",R.value="",I.value=!0,E.value=!0},Oe=t=>{k.value=t.labelNumber,R.value=t.location,g.value=t},Re=()=>{E.value=!1,f.value=null,k.value="",R.value="",g.value=null,I.value=!1},Te=()=>{!f.value||!k.value||(I.value?(p.value.push({isbn:f.value.isbn,labelNumber:k.value,location:R.value,book:g.value}),Re()):(E.value=!1,A.value=!0))},Fe=async t=>{if(!C.value||!t)return;if(!Q.value){await w(`${q}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(t.availableCount===0){await w("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await pe(C.value.uid,t.isbn,_.value);if(e){await w(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const u=t.copies.filter(r=>!M(r));if(u.length===1){const r=u[0];f.value=t,k.value=r.labelNumber,R.value=r.location,g.value=r,I.value=!1,A.value=!0}else f.value=t,k.value="",R.value="",g.value=null,I.value=!1,E.value=!0},oe=()=>{A.value=!1,f.value=null,k.value="",R.value="",g.value=null},We=()=>{H.value=!0},Xe=async()=>{if(!f.value||!k.value||!g.value)return;const t=Ne(Z.value,_.value);try{S.value=!0,t?(await fe(k.value,_.value,C.value.uid,f.value.isbn),await Promise.all([U(),te()]),oe(),await w("도서 대여가 완료되었습니다.",{type:"success"})):(await _e(k.value,_.value,C.value.uid,f.value.isbn),await U(),oe(),await w(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(e){console.error("대여 처리 오류:",e),await w(e.message||"대여 처리에 실패했습니다.",{type:"error"})}finally{S.value=!1}},je=async()=>{if(p.value.length===0||!C.value)return;const t=Ne(Z.value,_.value);if(t){if(!Q.value){await w(`${q}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(p.value.length>$.value){await w(`현재 ${$.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}}j.value=t,O.value=!0},ae=()=>{O.value=!1},He=async()=>{try{S.value=!0;const t=p.value.length;if(j.value){for(const e of p.value)await fe(e.labelNumber,_.value,C.value.uid,e.isbn);await Promise.all([U(),te()]),ae(),await w(`${t}권의 도서 대여가 완료되었습니다.`,{type:"success"})}else{for(const e of p.value)await _e(e.labelNumber,_.value,C.value.uid,e.isbn);await U(),ae(),await w(`${t}권의 도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"})}p.value=[]}catch(t){console.error("대여 신청 오류:",t),await w(t.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{S.value=!1}};return vt({title:"도서 대여 - CNX Library",meta:[{name:"description",content:"센터별 도서 대여 신청"}]}),(t,e)=>{const u=y("v-select"),r=y("v-text-field"),m=y("v-btn"),B=y("v-progress-circular"),T=lt,J=y("v-col"),F=y("v-row"),h=y("v-icon"),le=rt,se=ut,ne=y("v-navigation-drawer"),ie=y("v-card-title"),re=y("v-card-text"),ue=y("v-spacer"),ce=y("v-card-actions"),de=y("v-card"),ve=y("v-dialog"),Be=y("v-alert"),Qe=st,Je=y("v-app");return c(),Y(Je,null,{default:n(()=>[s(le,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[3]||(e[3]=l=>G.value=!o(G))},{default:n(()=>[a("div",mt,[a("div",bt,[a("div",ft,[a("h1",_t,d(o(_))+" 도서 대여 ",1),s(u,{modelValue:o(_),"onUpdate:modelValue":[e[0]||(e[0]=l=>L(_)?_.value=l:null),$e],items:ge,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),a("div",pt,[a("div",kt,[a("div",gt,[a("div",yt,[e[9]||(e[9]=i(" 총 ",-1)),a("strong",null,d(o(ze)),1),i("권 ("+d(o(Me))+"종) ",1)])]),a("div",wt,[s(r,{modelValue:o(D),"onUpdate:modelValue":[e[1]||(e[1]=l=>L(D)?D.value=l:null),Ue],label:"도서 검색",placeholder:"도서명 또는 ISBN-13으로 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"registered-search-input"},null,8,["modelValue"]),s(u,{modelValue:o(P),"onUpdate:modelValue":e[2]||(e[2]=l=>L(P)?P.value=l:null),items:Ee,label:"정렬",variant:"outlined",density:"comfortable","hide-details":"",class:"sort-select"},null,8,["modelValue"])]),a("div",ht,[a("div",Ct,[o(V)>=q?(c(),v(z,{key:0},[i(d(q)+"권 대여중 (반납 후 대여 가능) ")],64)):o(p).length>0?(c(),v(z,{key:1},[i(d(o(p).length)+"권 선택됨 ("+d(o(V))+"권 대여중, "+d(o($))+"권 추가 가능) ",1)],64)):(c(),v(z,{key:2},[i(" 대여할 도서를 선택하세요 ("+d(o(V))+"권 대여중, "+d(o($))+"권 추가 가능) ",1)],64))]),s(m,{class:"rent-request-btn",variant:"flat",size:"small",disabled:o(p).length===0||!o(Q),loading:o(S),onClick:je},{default:n(()=>[...e[10]||(e[10]=[i(" 대여 신청 ",-1)])]),_:1},8,["disabled","loading"])])]),o(ee)?(c(),v("div",xt,[s(B,{indeterminate:"",color:"primary"})])):o(we).length>0?(c(),v("div",Rt,[s(F,{class:"book-list-row"},{default:n(()=>[(c(!0),v(z,null,me(o(we),(l,K)=>(c(),Y(J,{key:`group-${K}`,cols:"12",sm:"6",class:"book-list-col"},{default:n(()=>[s(T,{book:he(l),center:o(_),"registered-books":[he(l)],"is-registered":!0,"show-action":!1,selectable:!0,selected:Ce(l),status:Ge(l),"show-status-flags":!0,disabled:Pe(l),"hide-overdue-status":!0,"show-rent-button":!0,"show-quantity":l.totalCount>1,"available-count":l.availableCount,"total-count":l.totalCount,onSelect:()=>Ie(l),onRent:()=>Fe(l)},null,8,["book","center","registered-books","selected","status","disabled","show-quantity","available-count","total-count","onSelect","onRent"])]),_:2},1024))),128))]),_:1})])):(c(),v("div",Bt,[s(h,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>[i(d(o(D)?"mdi-book-search-outline":"mdi-book-off-outline"),1)]),_:1}),o(D)?(c(),v("p",Dt,[e[11]||(e[11]=i(" '",-1)),a("strong",null,d(o(D)),1),e[12]||(e[12]=i("'에 대한 검색 결과가 없습니다. ",-1))])):(c(),v("p",Vt," 등록된 도서가 없습니다. "))]))])])]),_:1}),s(ne,{modelValue:o(G),"onUpdate:modelValue":e[4]||(e[4]=l=>L(G)?G.value=l:null),location:"right",temporary:"",width:o(ke),class:"side-navigation"},{default:n(()=>[a("div",Nt,[s(se)])]),_:1},8,["modelValue","width"]),s(ve,{modelValue:o(E),"onUpdate:modelValue":e[5]||(e[5]=l=>L(E)?E.value=l:null),"max-width":"450",persistent:""},{default:n(()=>[s(de,{class:"label-select-card"},{default:n(()=>[s(ie,{class:"label-select-title"},{default:n(()=>[...e[13]||(e[13]=[i(" 대여할 도서 선택 ",-1)])]),_:1}),s(re,{class:"label-select-content"},{default:n(()=>[o(f)?(c(),v("div",Lt,[a("div",St,[o(f).image?(c(),v("img",{key:0,src:o(f).image,alt:o(f).title,class:"book-thumbnail"},null,8,Et)):x("",!0),a("div",qt,[a("div",At,d(o(f).title),1),a("div",$t,d(o(f).author),1)])])])):x("",!0),a("div",Ut,[a("div",zt," 대여 가능한 도서 ("+d(o(xe).length)+"권) ",1),(c(!0),v(z,null,me(o(xe),l=>(c(),v("div",{key:l.id,class:ot(["label-option",{selected:o(k)===l.labelNumber}]),onClick:K=>Oe(l)},[a("div",Gt,[a("div",Pt,[s(h,{size:"small",class:"mr-1"},{default:n(()=>[...e[14]||(e[14]=[i(" mdi-label ",-1)])]),_:1}),i(" "+d(l.labelNumber||"라벨없음"),1)]),a("div",It,[s(h,{size:"small",class:"mr-1"},{default:n(()=>[...e[15]||(e[15]=[i(" mdi-map-marker ",-1)])]),_:1}),i(" "+d(o(be)(l.location)||"위치없음"),1)])]),o(k)===l.labelNumber?(c(),Y(h,{key:0,color:"primary"},{default:n(()=>[...e[16]||(e[16]=[i(" mdi-check-circle ",-1)])]),_:1})):x("",!0)],10,Mt))),128))])]),_:1}),s(ce,{class:"label-select-actions"},{default:n(()=>[s(ue),s(m,{variant:"text",onClick:Re},{default:n(()=>[...e[17]||(e[17]=[i(" 취소 ",-1)])]),_:1}),s(m,{color:"primary",variant:"flat",disabled:!o(k),onClick:Te},{default:n(()=>[...e[18]||(e[18]=[i(" 선택 완료 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ve,{modelValue:o(A),"onUpdate:modelValue":e[6]||(e[6]=l=>L(A)?A.value=l:null),"max-width":"500",persistent:""},{default:n(()=>[s(de,{class:"rent-confirm-card"},{default:n(()=>[s(ie,{class:"rent-confirm-title"},{default:n(()=>[...e[19]||(e[19]=[i(" 대여 확인 ",-1)])]),_:1}),s(re,{class:"rent-confirm-content"},{default:n(()=>[e[27]||(e[27]=a("div",{class:"rent-confirm-info mb-4"},[a("p",null,"아래 정보를 확인 후 대여해주세요.")],-1)),o(g)?(c(),v("div",Ot,[a("div",Tt,[o(g).image?(c(),v("img",{key:0,src:o(g).image,alt:o(g).title,class:"rent-book-thumbnail"},null,8,Ft)):(c(),v("div",Wt,[...e[20]||(e[20]=[a("span",null,"NO IMAGE",-1)])])),a("div",Xt,[a("div",jt,d(o(g).title),1),o(g).author?(c(),v("div",Ht,[e[21]||(e[21]=a("strong",null,"저자:",-1)),i(" "+d(o(g).author),1)])):x("",!0),o(g).publisher?(c(),v("div",Qt,[e[22]||(e[22]=a("strong",null,"출판사:",-1)),i(" "+d(o(g).publisher),1)])):x("",!0),a("div",Jt,[a("span",Kt,[s(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[23]||(e[23]=[i("mdi-label",-1)])]),_:1}),i(" "+d(o(k)),1)]),a("span",Yt,[s(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[24]||(e[24]=[i("mdi-map-marker",-1)])]),_:1}),i(" "+d(o(be)(o(R)))+" ",1),o(qe)?(c(),Y(m,{key:0,variant:"text",size:"x-small",color:"primary",class:"location-btn",onClick:We},{default:n(()=>[...e[25]||(e[25]=[i(" 위치 보기 ",-1)])]),_:1})):x("",!0)])])])])])):x("",!0),s(Be,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:n(()=>[...e[26]||(e[26]=[i(" 위치와 라벨번호를 확인 후 해당 도서를 가져가주세요. ",-1)])]),_:1})]),_:1}),s(ce,{class:"rent-confirm-actions"},{default:n(()=>[s(ue),s(m,{variant:"text",onClick:oe},{default:n(()=>[...e[28]||(e[28]=[i(" 취소 ",-1)])]),_:1}),s(m,{color:"primary",variant:"flat",loading:o(S),onClick:Xe},{default:n(()=>[...e[29]||(e[29]=[i(" 대여하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(ve,{modelValue:o(O),"onUpdate:modelValue":e[7]||(e[7]=l=>L(O)?O.value=l:null),"max-width":"500",persistent:""},{default:n(()=>[s(de,{class:"rent-confirm-card"},{default:n(()=>[s(ie,{class:"rent-confirm-title"},{default:n(()=>[...e[30]||(e[30]=[i(" 대여 확인 ",-1)])]),_:1}),s(re,{class:"rent-confirm-content"},{default:n(()=>[a("div",Zt,[e[31]||(e[31]=a("p",null,"아래 도서들을 대여하시겠습니까?",-1)),o(j)?x("",!0):(c(),v("p",eo," 관리자 승인 후 대여가 완료됩니다. "))]),a("div",to,[(c(!0),v(z,null,me(o(p),(l,K)=>(c(),v("div",{key:K,class:"rent-book-card"},[a("div",oo,[l.book?.image?(c(),v("img",{key:0,src:l.book.image,alt:l.book?.title,class:"rent-book-thumbnail"},null,8,ao)):(c(),v("div",lo,[...e[32]||(e[32]=[a("span",null,"NO IMAGE",-1)])])),a("div",so,[a("div",no,d(l.book?.title),1),l.book?.author?(c(),v("div",io,[e[33]||(e[33]=a("strong",null,"저자:",-1)),i(" "+d(l.book.author),1)])):x("",!0),l.book?.publisher?(c(),v("div",ro,[e[34]||(e[34]=a("strong",null,"출판사:",-1)),i(" "+d(l.book.publisher),1)])):x("",!0),a("div",uo,[a("span",co,[s(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[35]||(e[35]=[i("mdi-label",-1)])]),_:1}),i(" "+d(l.labelNumber),1)]),a("span",vo,[s(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[36]||(e[36]=[i("mdi-map-marker",-1)])]),_:1}),i(" "+d(o(be)(l.location)),1)])])])])]))),128))]),s(Be,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:n(()=>[...e[37]||(e[37]=[i(" 위치와 라벨번호를 확인 후 해당 도서를 가져가주세요. ",-1)])]),_:1})]),_:1}),s(ce,{class:"rent-confirm-actions"},{default:n(()=>[s(ue),s(m,{variant:"text",onClick:ae},{default:n(()=>[...e[38]||(e[38]=[i(" 취소 ",-1)])]),_:1}),s(m,{color:"primary",variant:"flat",loading:o(S),onClick:He},{default:n(()=>[i(d(o(j)?"대여하기":"대여 신청"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(Qe,{modelValue:o(H),"onUpdate:modelValue":e[8]||(e[8]=l=>L(H)?H.value=l:null),center:o(_),location:o(R),"label-number":o(k)},null,8,["modelValue","center","location","label-number"])]),_:1})}}},Co=Ke(mo,[["__scopeId","data-v-7a8f252d"]]);export{Co as default};
