const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CAuc9lqb.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as Ke,N as Ye,a as Ze,D as et,r as m,k as V,o as De,e as tt,_ as Ve,O as Y,L as n,g,H as c,K as o,P as a,I as l,J as d,Q as N,G as f,M as r,W as z,X as me,T as q,U as at}from"./CAuc9lqb.js";import{h as lt,_ as ot,a as st}from"./B-5cDlJ2.js";import{g as nt,C as it,_ as rt,c as Ne}from"./Cm829SSU.js";import{_ as ut}from"./BSzBsZaF.js";import{u as ct,f as fe}from"./DsWdme2O.js";import{u as dt}from"./BjEzwikH.js";import{u as vt}from"./D8EVFUzP.js";import"./TGHEgYJv.js";const mt={class:"books-page"},ft={class:"center-header mb-6"},bt={class:"center-header-inner"},_t={class:"page-title mb-0"},pt={class:"registered-books-section"},kt={class:"registered-books-header mb-0"},gt={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},wt={class:"text-body-1"},yt={class:"d-flex align-center registered-search-group"},ht={class:"d-flex align-center justify-space-between flex-wrap gap-4 mt-4"},Ct={class:"text-body-2 text-medium-emphasis"},xt={key:0,class:"text-center py-8 mt-6"},Rt={key:1,class:"registered-books-grid mt-6"},Bt={key:2,class:"text-center py-8 mt-6 text-medium-emphasis empty-state"},Dt={key:0},Vt={key:1},Nt={class:"drawer-content"},Lt={key:0,class:"book-info-preview mb-4"},St={class:"book-info-preview-inner"},qt=["src","alt"],Et={class:"book-meta"},$t={class:"book-title"},At={class:"book-author"},Ut={class:"label-select-list"},zt={class:"label-select-header mb-2"},Mt=["onClick"],Pt={class:"label-info"},Gt={class:"label-number"},It={class:"label-location"},Tt={key:0,class:"book-info-preview mb-4"},Ft={class:"book-info-preview-inner"},Ot=["src","alt"],Wt={class:"book-meta"},Xt={class:"book-title"},jt={class:"book-author"},Ht={class:"rent-details"},Qt={class:"detail-item"},Jt={class:"detail-value"},Kt={class:"detail-item"},Yt={class:"detail-value"},Zt={class:"rent-confirm-info mb-4"},ea={key:0,class:"text-caption text-grey mt-1"},ta={class:"multi-rent-book-list"},aa={class:"multi-rent-book-info"},la=["src","alt"],oa={key:1,class:"multi-rent-thumbnail-placeholder"},sa={class:"multi-rent-meta"},na={class:"multi-rent-title"},ia={class:"multi-rent-details"},ra={class:"detail-item"},ua={class:"detail-item"},E=5,ca={__name:"index",setup(da){const{user:C}=dt(),{getBooksByCenter:Le,calculateBookStatus:M,rentBook:be,requestRent:_e,checkAlreadyRentedSameIsbn:pe}=ct(),{alert:w}=Ye(),{$firebaseFirestore:Se}=Ze(),W=Se,P=et("navigationDrawer",()=>!1),ke=m(280),ge=[...it],_=m(""),Z=m(""),X=m([]),ee=m(!1),B=m(""),G=m("date"),qe=[{title:"등록일순",value:"date"},{title:"제목순",value:"title"}],p=m([]),L=m(!1),D=m(0),S=m(!1),b=m(null),k=m(""),x=m(""),y=m(null),I=m(!1),$=m(!1),T=m(!1),j=m(!1),H=m(!1),Ee=V(()=>lt(_.value));De(()=>{const t=()=>{ke.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),tt(()=>{window.removeEventListener("resize",t)})});const $e=async()=>{if(!C.value||!W)return"";try{const{doc:t,getDoc:e}=await Ve(async()=>{const{doc:v,getDoc:R}=await import("./CAuc9lqb.js").then(F=>F.aE);return{doc:v,getDoc:R}},__vite__mapDeps([0,1]),import.meta.url),u=t(W,"users",C.value.uid),i=await e(u);if(i.exists())return i.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};De(async()=>{const t=await $e();Z.value=t,_.value=t?nt(t):ge[0],await Promise.all([U(),te()])});const te=async()=>{if(!C.value||!W){D.value=0;return}try{const{collection:t,query:e,where:u,getDocs:i}=await Ve(async()=>{const{collection:O,query:h,where:oe,getDocs:se}=await import("./CAuc9lqb.js").then(ne=>ne.aE);return{collection:O,query:h,where:oe,getDocs:se}},__vite__mapDeps([0,1]),import.meta.url),v=t(W,"books"),R=e(v,u("rentedBy","==",C.value.uid)),F=await i(R);let J=0;F.forEach(O=>{const h=O.data();(h.status==="rented"||h.status==="overdue")&&J++}),D.value=J}catch(t){console.error("대여중인 도서 수 로드 오류:",t),D.value=0}},Q=V(()=>D.value<E),A=V(()=>E-D.value),Ae=async()=>{p.value=[],await U()},U=async()=>{try{ee.value=!0;const t=await Le(_.value);X.value=t}catch(t){console.error("등록된 도서 로드 오류:",t),X.value=[]}finally{ee.value=!1}},Ue=()=>{},we=V(()=>{const t=new Map;for(const e of X.value){const u=e.isbn13||e.isbn||e.id;t.has(u)||t.set(u,{isbn:u,title:e.title,author:e.author,publisher:e.publisher,image:e.image,copies:[],totalCount:0,availableCount:0,locations:[]});const i=t.get(u);i.copies.push(e),i.totalCount++,M(e)||(i.availableCount++,e.location&&!i.locations.includes(e.location)&&i.locations.push(e.location))}for(const e of t.values())e.copies.sort((u,i)=>{const v=u.labelNumber||"",R=i.labelNumber||"";return v.localeCompare(R,"ko")});return Array.from(t.values())}),ye=V(()=>{let t=[...we.value];if(B.value.trim()){const e=B.value.toLowerCase();t=t.filter(u=>{const i=(u.title||"").toLowerCase(),v=(u.author||"").toLowerCase(),R=(u.publisher||"").toLowerCase();return i.includes(e)||v.includes(e)||R.includes(e)})}return G.value==="title"?t.sort((e,u)=>{const i=(e.title||"").toLowerCase(),v=(u.title||"").toLowerCase();return i.localeCompare(v,"ko")}):G.value==="date"&&t.sort((e,u)=>{const i=e.copies[0]?.registeredAt?.toDate?.()||new Date(0);return(u.copies[0]?.registeredAt?.toDate?.()||new Date(0))-i}),t}),ze=V(()=>X.value.length),Me=V(()=>we.value.length),he=t=>t.copies[0]||{title:t.title,author:t.author,publisher:t.publisher,image:t.image,isbn:t.isbn},Pe=t=>t.availableCount===0?t.copies.some(u=>M(u)==="requested")?"requested":"rented":null,Ge=t=>t.availableCount===0,Ce=t=>p.value.some(e=>e.isbn===t.isbn),xe=V(()=>b.value?b.value.copies.filter(t=>!M(t)):[]),Ie=async t=>{if(Ce(t)){p.value=p.value.filter(i=>i.isbn!==t.isbn);return}if(!Q.value){await w(`${E}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(p.value.length>=A.value){await w(`현재 ${A.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}if(t.availableCount===0){await w("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await pe(C.value.uid,t.isbn,_.value);if(e){await w(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const u=t.copies.filter(i=>!M(i));if(u.length===1){const i=u[0];p.value.push({isbn:t.isbn,labelNumber:i.labelNumber,location:i.location,book:i})}else b.value=t,k.value="",x.value="",I.value=!0,S.value=!0},Te=t=>{k.value=t.labelNumber,x.value=t.location,y.value=t},Re=()=>{S.value=!1,b.value=null,k.value="",x.value="",y.value=null,I.value=!1},Fe=()=>{!b.value||!k.value||(I.value?(p.value.push({isbn:b.value.isbn,labelNumber:k.value,location:x.value,book:y.value}),Re()):(S.value=!1,$.value=!0))},Oe=async t=>{if(!C.value||!t)return;if(!Q.value){await w(`${E}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(t.availableCount===0){await w("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const e=await pe(C.value.uid,t.isbn,_.value);if(e){await w(`이미 같은 도서를 대여중입니다.
(라벨번호: ${e.labelNumber||"-"})`,{type:"warning"});return}const u=t.copies.filter(i=>!M(i));if(u.length===1){const i=u[0];b.value=t,k.value=i.labelNumber,x.value=i.location,y.value=i,I.value=!1,$.value=!0}else b.value=t,k.value="",x.value="",y.value=null,I.value=!1,S.value=!0},ae=()=>{$.value=!1,b.value=null,k.value="",x.value="",y.value=null},We=()=>{H.value=!0},Xe=async()=>{if(!b.value||!k.value||!y.value)return;const t=Ne(Z.value,_.value);try{L.value=!0,t?(await be(k.value,_.value,C.value.uid,b.value.isbn),await Promise.all([U(),te()]),ae(),await w("도서 대여가 완료되었습니다.",{type:"success"})):(await _e(k.value,_.value,C.value.uid,b.value.isbn),await U(),ae(),await w(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(e){console.error("대여 처리 오류:",e),await w(e.message||"대여 처리에 실패했습니다.",{type:"error"})}finally{L.value=!1}},je=async()=>{if(p.value.length===0||!C.value)return;const t=Ne(Z.value,_.value);if(t){if(!Q.value){await w(`${E}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(p.value.length>A.value){await w(`현재 ${A.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}}j.value=t,T.value=!0},le=()=>{T.value=!1},He=async()=>{try{L.value=!0;const t=p.value.length;if(j.value){for(const e of p.value)await be(e.labelNumber,_.value,C.value.uid,e.isbn);await Promise.all([U(),te()]),le(),await w(`${t}권의 도서 대여가 완료되었습니다.`,{type:"success"})}else{for(const e of p.value)await _e(e.labelNumber,_.value,C.value.uid,e.isbn);await U(),le(),await w(`${t}권의 도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"})}p.value=[]}catch(t){console.error("대여 신청 오류:",t),await w(t.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{L.value=!1}};return vt({title:"도서 대여 - CNX Library",meta:[{name:"description",content:"센터별 도서 대여 신청"}]}),(t,e)=>{const u=g("v-select"),i=g("v-text-field"),v=g("v-btn"),R=g("v-progress-circular"),F=ot,J=g("v-col"),O=g("v-row"),h=g("v-icon"),oe=rt,se=ut,ne=g("v-navigation-drawer"),ie=g("v-card-title"),re=g("v-card-text"),ue=g("v-spacer"),ce=g("v-card-actions"),de=g("v-card"),ve=g("v-dialog"),Be=g("v-alert"),Qe=st,Je=g("v-app");return c(),Y(Je,null,{default:n(()=>[o(oe,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[3]||(e[3]=s=>P.value=!a(P))},{default:n(()=>[l("div",mt,[l("div",ft,[l("div",bt,[l("h1",_t,d(a(_))+" 도서 대여 ",1),o(u,{modelValue:a(_),"onUpdate:modelValue":[e[0]||(e[0]=s=>N(_)?_.value=s:null),Ae],items:ge,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),l("div",pt,[l("div",kt,[l("div",gt,[l("div",wt,[e[9]||(e[9]=r(" 총 ",-1)),l("strong",null,d(a(ze)),1),r("권 ("+d(a(Me))+"종) ",1)])]),l("div",yt,[o(i,{modelValue:a(B),"onUpdate:modelValue":[e[1]||(e[1]=s=>N(B)?B.value=s:null),Ue],label:"도서 검색",placeholder:"도서명 또는 ISBN-13으로 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"registered-search-input"},null,8,["modelValue"]),o(u,{modelValue:a(G),"onUpdate:modelValue":e[2]||(e[2]=s=>N(G)?G.value=s:null),items:qe,label:"정렬",variant:"outlined",density:"comfortable","hide-details":"",class:"sort-select"},null,8,["modelValue"])]),l("div",ht,[l("div",Ct,[a(D)>=E?(c(),f(z,{key:0},[r(d(E)+"권 대여중 (반납 후 대여 가능) ")],64)):a(p).length>0?(c(),f(z,{key:1},[r(d(a(p).length)+"권 선택됨 ("+d(a(D))+"권 대여중, "+d(a(A))+"권 추가 가능) ",1)],64)):(c(),f(z,{key:2},[r(" 대여할 도서를 선택하세요 ("+d(a(D))+"권 대여중, "+d(a(A))+"권 추가 가능) ",1)],64))]),o(v,{class:"rent-request-btn",variant:"flat",size:"small",disabled:a(p).length===0||!a(Q),loading:a(L),onClick:je},{default:n(()=>[...e[10]||(e[10]=[r(" 대여 신청 ",-1)])]),_:1},8,["disabled","loading"])])]),a(ee)?(c(),f("div",xt,[o(R,{indeterminate:"",color:"primary"})])):a(ye).length>0?(c(),f("div",Rt,[o(O,{class:"book-list-row"},{default:n(()=>[(c(!0),f(z,null,me(a(ye),(s,K)=>(c(),Y(J,{key:`group-${K}`,cols:"12",sm:"6",class:"book-list-col"},{default:n(()=>[o(F,{book:he(s),center:a(_),"registered-books":[he(s)],"is-registered":!0,"show-action":!1,selectable:!0,selected:Ce(s),status:Pe(s),"show-status-flags":!0,disabled:Ge(s),"hide-overdue-status":!0,"show-rent-button":!0,"show-location":!0,locations:s.locations,"show-quantity":s.totalCount>1,"available-count":s.availableCount,"total-count":s.totalCount,onSelect:()=>Ie(s),onRent:()=>Oe(s)},null,8,["book","center","registered-books","selected","status","disabled","locations","show-quantity","available-count","total-count","onSelect","onRent"])]),_:2},1024))),128))]),_:1})])):(c(),f("div",Bt,[o(h,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>[r(d(a(B)?"mdi-book-search-outline":"mdi-book-off-outline"),1)]),_:1}),a(B)?(c(),f("p",Dt,[e[11]||(e[11]=r(" '",-1)),l("strong",null,d(a(B)),1),e[12]||(e[12]=r("'에 대한 검색 결과가 없습니다. ",-1))])):(c(),f("p",Vt," 등록된 도서가 없습니다. "))]))])])]),_:1}),o(ne,{modelValue:a(P),"onUpdate:modelValue":e[4]||(e[4]=s=>N(P)?P.value=s:null),location:"right",temporary:"",width:a(ke),class:"side-navigation"},{default:n(()=>[l("div",Nt,[o(se)])]),_:1},8,["modelValue","width"]),o(ve,{modelValue:a(S),"onUpdate:modelValue":e[5]||(e[5]=s=>N(S)?S.value=s:null),"max-width":"450",persistent:""},{default:n(()=>[o(de,{class:"label-select-card"},{default:n(()=>[o(ie,{class:"label-select-title"},{default:n(()=>[...e[13]||(e[13]=[r(" 대여할 도서 선택 ",-1)])]),_:1}),o(re,{class:"label-select-content"},{default:n(()=>[a(b)?(c(),f("div",Lt,[l("div",St,[a(b).image?(c(),f("img",{key:0,src:a(b).image,alt:a(b).title,class:"book-thumbnail"},null,8,qt)):q("",!0),l("div",Et,[l("div",$t,d(a(b).title),1),l("div",At,d(a(b).author),1)])])])):q("",!0),l("div",Ut,[l("div",zt," 대여 가능한 도서 ("+d(a(xe).length)+"권) ",1),(c(!0),f(z,null,me(a(xe),s=>(c(),f("div",{key:s.id,class:at(["label-option",{selected:a(k)===s.labelNumber}]),onClick:K=>Te(s)},[l("div",Pt,[l("div",Gt,[o(h,{size:"small",class:"mr-1"},{default:n(()=>[...e[14]||(e[14]=[r(" mdi-label ",-1)])]),_:1}),r(" "+d(s.labelNumber||"라벨없음"),1)]),l("div",It,[o(h,{size:"small",class:"mr-1"},{default:n(()=>[...e[15]||(e[15]=[r(" mdi-map-marker ",-1)])]),_:1}),r(" "+d(a(fe)(s.location)||"위치없음"),1)])]),a(k)===s.labelNumber?(c(),Y(h,{key:0,color:"primary"},{default:n(()=>[...e[16]||(e[16]=[r(" mdi-check-circle ",-1)])]),_:1})):q("",!0)],10,Mt))),128))])]),_:1}),o(ce,{class:"label-select-actions"},{default:n(()=>[o(ue),o(v,{variant:"text",onClick:Re},{default:n(()=>[...e[17]||(e[17]=[r(" 취소 ",-1)])]),_:1}),o(v,{color:"primary",variant:"flat",disabled:!a(k),onClick:Fe},{default:n(()=>[...e[18]||(e[18]=[r(" 선택 완료 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(ve,{modelValue:a($),"onUpdate:modelValue":e[6]||(e[6]=s=>N($)?$.value=s:null),"max-width":"500",persistent:""},{default:n(()=>[o(de,{class:"rent-confirm-card"},{default:n(()=>[o(ie,{class:"rent-confirm-title"},{default:n(()=>[...e[19]||(e[19]=[r(" 대여 확인 ",-1)])]),_:1}),o(re,{class:"rent-confirm-content"},{default:n(()=>[e[26]||(e[26]=l("div",{class:"rent-confirm-info mb-4"},[l("p",null,"아래 정보를 확인 후 대여해주세요.")],-1)),a(y)?(c(),f("div",Tt,[l("div",Ft,[a(y).image?(c(),f("img",{key:0,src:a(y).image,alt:a(y).title,class:"book-thumbnail"},null,8,Ot)):q("",!0),l("div",Wt,[l("div",Xt,d(a(y).title),1),l("div",jt,d(a(y).author),1)])])])):q("",!0),l("div",Ht,[l("div",Qt,[o(h,{size:"small",class:"mr-2"},{default:n(()=>[...e[20]||(e[20]=[r(" mdi-label ",-1)])]),_:1}),e[21]||(e[21]=l("span",{class:"detail-label"},"라벨번호:",-1)),l("span",Jt,d(a(k)),1)]),l("div",Kt,[o(h,{size:"small",class:"mr-2"},{default:n(()=>[...e[22]||(e[22]=[r(" mdi-map-marker ",-1)])]),_:1}),e[24]||(e[24]=l("span",{class:"detail-label"},"위치:",-1)),l("span",Yt,d(a(fe)(a(x))),1),a(Ee)?(c(),Y(v,{key:0,variant:"text",size:"small",color:"primary",class:"ml-2",onClick:We},{default:n(()=>[...e[23]||(e[23]=[r(" 위치 보기 ",-1)])]),_:1})):q("",!0)])]),o(Be,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:n(()=>[...e[25]||(e[25]=[r(" 위치와 라벨번호를 확인 후 해당 도서를 가져가주세요. ",-1)])]),_:1})]),_:1}),o(ce,{class:"rent-confirm-actions"},{default:n(()=>[o(ue),o(v,{variant:"text",onClick:ae},{default:n(()=>[...e[27]||(e[27]=[r(" 취소 ",-1)])]),_:1}),o(v,{color:"primary",variant:"flat",loading:a(L),onClick:Xe},{default:n(()=>[...e[28]||(e[28]=[r(" 대여하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(ve,{modelValue:a(T),"onUpdate:modelValue":e[7]||(e[7]=s=>N(T)?T.value=s:null),"max-width":"500",persistent:""},{default:n(()=>[o(de,{class:"rent-confirm-card"},{default:n(()=>[o(ie,{class:"rent-confirm-title"},{default:n(()=>[...e[29]||(e[29]=[r(" 대여 확인 ",-1)])]),_:1}),o(re,{class:"rent-confirm-content"},{default:n(()=>[l("div",Zt,[e[30]||(e[30]=l("p",null,"아래 도서들을 대여하시겠습니까?",-1)),a(j)?q("",!0):(c(),f("p",ea," 관리자 승인 후 대여가 완료됩니다. "))]),l("div",ta,[(c(!0),f(z,null,me(a(p),(s,K)=>(c(),f("div",{key:K,class:"multi-rent-book-item"},[l("div",aa,[s.book?.image?(c(),f("img",{key:0,src:s.book.image,alt:s.book.title,class:"multi-rent-thumbnail"},null,8,la)):(c(),f("div",oa,[...e[31]||(e[31]=[l("span",null,"NO IMAGE",-1)])])),l("div",sa,[l("div",na,d(s.book?.title),1),l("div",ia,[l("span",ra,[o(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[32]||(e[32]=[r("mdi-label",-1)])]),_:1}),r(" "+d(s.labelNumber),1)]),l("span",ua,[o(h,{size:"x-small",class:"mr-1"},{default:n(()=>[...e[33]||(e[33]=[r("mdi-map-marker",-1)])]),_:1}),r(" "+d(a(fe)(s.location)),1)])])])])]))),128))]),o(Be,{type:"info",variant:"tonal",density:"compact",class:"mt-4"},{default:n(()=>[...e[34]||(e[34]=[r(" 위치와 라벨번호를 확인 후 해당 도서를 가져가주세요. ",-1)])]),_:1})]),_:1}),o(ce,{class:"rent-confirm-actions"},{default:n(()=>[o(ue),o(v,{variant:"text",onClick:le},{default:n(()=>[...e[35]||(e[35]=[r(" 취소 ",-1)])]),_:1}),o(v,{color:"primary",variant:"flat",loading:a(L),onClick:He},{default:n(()=>[r(d(a(j)?"대여하기":"대여 신청"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(Qe,{modelValue:a(H),"onUpdate:modelValue":e[8]||(e[8]=s=>N(H)?H.value=s:null),center:a(_),location:a(x),"label-number":a(k)},null,8,["modelValue","center","location","label-number"])]),_:1})}}},wa=Ke(ca,[["__scopeId","data-v-43c27834"]]);export{wa as default};
