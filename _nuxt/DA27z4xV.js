const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Bb-IZLVQ.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as Q,c as Z,g as W,h as Y}from"./DU0bEG_V.js";import{F as ee,a as oe,u as te,Z as re,r as k,o as se,_ as x,O as ae,L as D,g as I,H as S,K as F,I as m,G as O,S as ie,P as L,M as P,J as ne}from"./Bb-IZLVQ.js";import{_ as ce,a as le}from"./Bi71xubJ.js";import{u as ue}from"./D0YV89OB.js";const j=Object.freeze(Object.defineProperty({__proto__:null,FunctionsError:Q,connectFunctionsEmulator:Z,getFunctions:W,httpsCallable:Y},Symbol.toStringTag,{value:"Module"})),de={key:0,class:"text-center py-8"},fe={key:1,class:"text-center"},me={key:2,class:"text-center"},pe={class:"error-text mb-6",style:{"white-space":"pre-line"}},ve={class:"logo-bottom text-center mt-6"},ye={class:"logo-with-credit"},_e={__name:"verify-email",setup(ge){const{$firebaseAuth:H,$firebaseFirestore:G,$firebaseApp:z}=oe(),M=te(),B=re(),f=k(!0),U=k(!1),y=k(!1),d=k(""),A=B.query.mode,R=B.query.oobCode;se(async()=>{if(!A||!R){y.value=!0,d.value="잘못된 인증 링크입니다.",f.value=!1;return}if(A==="resetPassword"){await M.push({path:"/reset-password",query:{mode:A,oobCode:R}});return}if(A!=="verifyEmail"){y.value=!0,d.value="지원하지 않는 인증 모드입니다.",f.value=!1;return}try{const{applyActionCode:_,checkActionCode:r}=await x(async()=>{const{applyActionCode:c,checkActionCode:w}=await import("./Bb-IZLVQ.js").then(t=>t.aE);return{applyActionCode:c,checkActionCode:w}},__vite__mapDeps([0,1]),import.meta.url),{collection:E,query:g,where:h,getDocs:b,doc:p,getDoc:T,setDoc:J,serverTimestamp:$}=await x(async()=>{const{collection:c,query:w,where:t,getDocs:e,doc:i,getDoc:n,setDoc:l,serverTimestamp:C}=await import("./Bb-IZLVQ.js").then(V=>V.aF);return{collection:c,query:w,where:t,getDocs:e,doc:i,getDoc:n,setDoc:l,serverTimestamp:C}},__vite__mapDeps([0,1]),import.meta.url),q=H,u=G;if(!q||!u)throw new Error("Firebase가 초기화되지 않았습니다.");let o=null,v=null;try{v=await r(q,R),o=v.data.email,console.log("actionCodeInfo:",v),console.log("이메일 추출:",o),!o&&v.data&&(o=v.data.email,console.log("actionCodeInfo.data에서 이메일 재확인:",o))}catch(c){if(c.code==="auth/invalid-action-code")console.log("checkActionCode가 invalid-action-code로 실패, applyActionCode 시도");else throw c}let a=null,s=null;if(o)try{const c=E(u,"users"),w=g(c,h("email","==",o)),t=await b(w);if(t.empty)console.warn("Firestore에서 사용자를 찾을 수 없습니다:",o);else{const e=t.docs[0];a=p(u,"users",e.id),s=e.data(),console.log("Firestore 사용자 데이터:",s),console.log("emailVerified 값:",s?.emailVerified,"타입:",typeof s?.emailVerified)}}catch(c){console.error("Firestore 쿼리 오류:",c)}try{await _(q,R);const{getAuth:c}=await x(async()=>{const{getAuth:e}=await import("./Bb-IZLVQ.js").then(i=>i.aE);return{getAuth:e}},__vite__mapDeps([0,1]),import.meta.url),t=c().currentUser;if(!a){if(t&&t.uid)try{a=p(u,"users",t.uid);const e=await T(a);e.exists()?(s=e.data(),o=o||t.email||s.email,console.log("현재 사용자 UID로 찾은 사용자:",s)):a=null}catch(e){console.error("UID로 사용자 찾기 오류:",e),a=null}if(!a&&o)try{const e=E(u,"users"),i=g(e,h("email","==",o)),n=await b(i);if(!n.empty){const l=n.docs[0];a=p(u,"users",l.id),s=l.data(),console.log("이메일로 찾은 사용자:",s)}}catch(e){console.error("재시도 Firestore 쿼리 오류:",e)}if(!a&&!o&&v&&v.data&&v.data.email){o=v.data.email;try{const e=E(u,"users"),i=g(e,h("email","==",o)),n=await b(i);if(!n.empty){const l=n.docs[0];a=p(u,"users",l.id),s=l.data(),console.log("actionCodeInfo에서 이메일로 찾은 사용자:",s)}}catch(e){console.error("actionCodeInfo 이메일로 Firestore 쿼리 오류:",e)}}if(!a&&t&&t.email){o=o||t.email;try{const e=E(u,"users"),i=g(e,h("email","==",o)),n=await b(i);if(!n.empty){const l=n.docs[0];a=p(u,"users",l.id),s=l.data(),console.log("현재 사용자 이메일로 찾은 사용자:",s)}}catch(e){console.error("현재 사용자 이메일로 Firestore 쿼리 오류:",e)}}}if(a)try{await J(a,{emailVerified:!0,emailVerifiedAt:$(),updatedAt:$()},{merge:!0}),console.log("Firestore 업데이트 완료. email:",o,"uid:",t?.uid)}catch(e){if(console.error("Firestore 업데이트 오류:",e),e.code==="permission-denied"&&o){console.log("권한 오류로 Functions를 통해 업데이트 시도:",o);try{const{getFunctions:i,httpsCallable:n}=await x(async()=>{const{getFunctions:N,httpsCallable:K}=await Promise.resolve().then(()=>j);return{getFunctions:N,httpsCallable:K}},void 0,import.meta.url),l=i(z),V=await n(l,"updateEmailVerificationStatus")({email:o});V.data.success?console.log("Functions를 통해 Firestore 업데이트 완료:",o):console.error("Functions 업데이트 실패:",V.data.error)}catch(i){console.error("Functions 호출 오류:",i)}}}else if(o){console.log("userRef를 찾지 못했지만 이메일이 있으므로 Functions를 통해 업데이트 시도:",o);try{const{getFunctions:e,httpsCallable:i}=await x(async()=>{const{getFunctions:V,httpsCallable:N}=await Promise.resolve().then(()=>j);return{getFunctions:V,httpsCallable:N}},void 0,import.meta.url),n=e(z),C=await i(n,"updateEmailVerificationStatus")({email:o});if(C.data.success)console.log("Functions를 통해 Firestore 업데이트 완료:",o);else{console.error("Functions 업데이트 실패:",C.data.error),y.value=!0,d.value=C.data.error||"이메일 인증 상태 업데이트에 실패했습니다.",f.value=!1;return}}catch(e){console.error("Functions 호출 오류:",e),y.value=!0,d.value="이메일 인증 상태 업데이트에 실패했습니다. 관리자에게 문의해주세요.",f.value=!1;return}}else{console.error("userRef와 이메일을 모두 찾을 수 없어서 Firestore 업데이트를 할 수 없습니다."),console.error("currentUser:",t),console.error("actionCodeInfo:",v),y.value=!0,d.value="인증은 완료되었지만 사용자 정보를 찾을 수 없어 업데이트에 실패했습니다. 관리자에게 문의해주세요.",f.value=!1;return}U.value=!0,f.value=!1}catch(c){if(console.log("applyActionCode 에러:",c.code,c.message),console.log("userData.emailVerified:",s?.emailVerified),c.code==="auth/invalid-action-code"){if(!o&&!a){console.log("이메일과 userRef를 모두 찾을 수 없어서 현재 로그인된 사용자 확인 시도");try{const t=q.currentUser;if(t&&t.email){console.log("auth.currentUser 발견:",t.email),o=t.email;try{const e=E(u,"users"),i=g(e,h("email","==",o)),n=await b(i);if(n.empty)a=p(u,"users",t.uid),s=null,console.log("Firestore에 사용자 정보가 없어서 UID로 생성:",t.uid);else{const l=n.docs[0];a=p(u,"users",l.id),s=l.data(),console.log("auth.currentUser로 찾은 Firestore 데이터:",s)}}catch(e){console.error("Firestore 쿼리 오류:",e)}}}catch(t){console.error("현재 사용자 확인 오류:",t)}}if(!o&&!a){console.warn("이메일과 userRef를 모두 찾을 수 없지만, 이미 인증된 상태로 간주"),U.value=!0,f.value=!1;return}if(!a&&o){console.log("userRef가 없어서 다시 찾기 시도:",o);try{const t=E(u,"users"),e=g(t,h("email","==",o)),i=await b(e);if(!i.empty){const n=i.docs[0];a=p(u,"users",n.id),s=n.data(),console.log("재시도로 찾은 사용자 데이터:",s)}}catch(t){console.error("재시도 Firestore 쿼리 오류:",t)}}const w=s&&s.emailVerified===!0;console.log("isEmailVerified:",w,"userData.emailVerified:",s?.emailVerified),w?(y.value=!0,d.value="이미 이메일 인증이 완료된 계정입니다.",f.value=!1):(y.value=!0,d.value=`이 인증 링크는 더 이상 유효하지 않습니다.

새로운 인증 메일이 발송되었을 수 있습니다.
받은 메일함에서 가장 최근 인증 메일을 확인해주세요.`,f.value=!1)}else throw c.code==="auth/expired-action-code",c}}catch(_){console.error("이메일 인증 오류:",_),y.value=!0,f.value=!1,_.code==="auth/expired-action-code"?d.value="인증 링크가 만료되었습니다. 새로운 인증 링크를 요청해주세요.":_.code==="auth/invalid-action-code"?d.value="이미 인증된 이메일이거나 유효하지 않은 인증 링크입니다.":_.code==="auth/user-disabled"?d.value="비활성화된 계정입니다.":_.code==="auth/user-not-found"?d.value="사용자를 찾을 수 없습니다.":d.value=_.message||"이메일 인증에 실패했습니다."}});const X=()=>{M.push("/login")};return ue({title:"이메일 인증 - CNX Library",link:[{rel:"preconnect",href:"https://fonts.googleapis.com"},{rel:"preconnect",href:"https://fonts.gstatic.com",crossorigin:""},{rel:"stylesheet",href:"https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"}]}),(_,r)=>{const E=I("v-progress-circular"),g=I("v-icon"),h=I("v-btn"),b=le,p=ce,T=I("v-app");return S(),ae(T,null,{default:D(()=>[F(p,null,{default:D(()=>[r[9]||(r[9]=m("div",{class:"text-center mb-8"},[m("h1",{class:"login-title mb-2"}," CNX Library "),m("p",{class:"login-subtitle"}," 이메일 인증 ")],-1)),L(f)?(S(),O("div",de,[F(E,{indeterminate:"",color:"primary",size:"64",class:"mb-4"}),r[0]||(r[0]=m("p",{class:"verifying-text"}," 이메일 인증을 처리하는 중입니다... ",-1))])):L(U)?(S(),O("div",fe,[F(g,{color:"success",size:"64",class:"mb-4"},{default:D(()=>[...r[1]||(r[1]=[P(" mdi-check-circle ",-1)])]),_:1}),r[3]||(r[3]=m("h2",{class:"success-title mb-4"}," 이메일 인증이 완료되었습니다! ",-1)),r[4]||(r[4]=m("p",{class:"success-text mb-6"}," 이제 로그인하여 CNX Library를 이용하실 수 있습니다. ",-1)),F(h,{block:"",size:"large",class:"login-btn",elevation:"2",onClick:X},{default:D(()=>[...r[2]||(r[2]=[P(" 로그인하기 ",-1)])]),_:1})])):L(y)?(S(),O("div",me,[F(g,{color:"error",size:"64",class:"mb-4"},{default:D(()=>[...r[5]||(r[5]=[P(" mdi-alert-circle ",-1)])]),_:1}),r[7]||(r[7]=m("h2",{class:"error-title mb-4"}," 인증에 실패했습니다 ",-1)),m("p",pe,ne(L(d)),1),F(h,{block:"",size:"large",class:"login-btn",elevation:"2",onClick:X},{default:D(()=>[...r[6]||(r[6]=[P(" 로그인 페이지로 이동 ",-1)])]),_:1})])):ie("",!0),m("div",ve,[m("div",ye,[F(b),r[8]||(r[8]=m("span",{class:"credit-text"},"© rarecat",-1))])])]),_:1})]),_:1})}}},Fe=ee(_e,[["__scopeId","data-v-bb23d436"]]);export{Fe as default};
