import{g as S,h as _}from"./m4DGENux.js";import{a as ee,r as L,a0 as O,a1 as y,a2 as T,a3 as v,a4 as h,a5 as A,a6 as E,a7 as k,a8 as q,a9 as I,aa as B,ab as R}from"./BOqZQSkp.js";const M=["경제경영","교양사상","국내소설","국내수필","마케팅","심리학","외국도서","외국소설","외국수필","외국어","인문학","자기계발","전공서적","회계학"],te={강남센터:"1",용산센터:"2"},re=[{value:"구매칸",text:"구매칸",type:"special"},{value:"기부칸",text:"기부칸",type:"special"},...Array.from({length:16},(d,w)=>({value:String(w+1),text:`${w+1}번 칸`,type:"number"}))],ae=()=>re.map(d=>({title:d.text,value:d.value})),ne=(d,w,c)=>{const u=te[w]||"1",l=String(c).padStart(4,"0");return`${d}_${u}${l}`},ce=d=>{if(!d||!d.includes("_"))return null;const[w,c]=d.split("_");return!c||c.length!==5?null:{category:w,centerCode:c.charAt(0),fourDigits:c.substring(1)}},C=d=>d?d==="구매칸"||d==="기부칸"?d:`${d}번 칸`:"",ie=d=>{if(!d||d.length===0)return"없음";const w=[...new Set(d)];return w.length===1?C(w[0]):w.length===2?w.map(C).join(", "):`${C(w[0])} 외 ${w.length-1}곳`},ue=()=>{const{$firebaseFirestore:d,$firebaseApp:w}=ee(),c=d,u=L(!1),l=L(null),g=(t,o)=>`${t}_${o}`,$=(t,o)=>`${t}_${o}`,x=async(t,o)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=g(t,o),r=y(c,"books",e);return(await v(r)).exists()}catch(e){throw console.error("라벨번호 중복 체크 오류:",e),e}},D=async(t,o,e)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{const r=q(c,"books"),s=I(r,B("center","==",e),B("isbn","==",o),B("rentedBy","==",t)),a=await R(s);for(const n of a.docs){const i=n.data();if(i.status==="rented"||F(i)==="overdue")return{id:n.id,...i}}return null}catch(r){throw console.error("ISBN 대여 체크 오류:",r),r}},P=async t=>{const o=[...M];if(!c)return console.warn("Firebase가 초기화되지 않았습니다. 기본 카테고리만 반환합니다."),o.sort((e,r)=>e.localeCompare(r,"ko"));try{const e=q(c,"categories"),r=I(e,B("center","==",t));(await R(r)).forEach(a=>{const n=a.data();n.name&&!o.includes(n.name)&&o.push(n.name)})}catch(e){console.error("추가 카테고리 조회 오류 (기본 카테고리는 사용 가능):",e)}return o.sort((e,r)=>e.localeCompare(r,"ko")),o},G=async(t,o)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=o.trim();if(!e)throw new Error("카테고리명을 입력해주세요.");if(M.includes(e))return{success:!0,message:"기본 카테고리입니다."};const r=`${t}_${e}`,s=y(c,"categories",r);return(await v(s)).exists()?{success:!0,message:"이미 존재하는 카테고리입니다."}:(await A(s,{center:t,name:e,createdAt:h()}),{success:!0})}catch(e){throw console.error("카테고리 추가 오류:",e),e}},W=async(t,o=1,e=20)=>{if(!c||!w)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const r=S(w),a=await _(r,"searchNaverBooks")({query:t,start:o,display:e});if(a.data.success)return a.data.data;throw new Error(a.data.error||"도서 검색에 실패했습니다.")}catch(r){throw console.error("도서 검색 오류:",r),l.value=r.message||"도서 검색에 실패했습니다.",r}finally{u.value=!1}},j=async(t=10)=>{if(!c||!w)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const o=S(w),r=await _(o,"getAladinBestsellers")({display:t});if(r.data.success)return r.data.data;throw new Error(r.data.error||"베스트셀러 조회에 실패했습니다.")}catch(o){throw console.error("베스트셀러 조회 오류:",o),l.value=o.message||"베스트셀러 조회에 실패했습니다.",o}finally{u.value=!1}},U=async(t,o,e,r,s,a="구매칸")=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const n=t.isbn13||t.isbn||"";if(!n)throw new Error("ISBN 정보가 없습니다.");if(!s)throw new Error("라벨번호를 입력해주세요.");if(!r)throw new Error("카테고리를 선택해주세요.");if(await x(s,o))throw new Error("이미 사용중인 라벨번호입니다.");const f=g(s,o),b=y(c,"books",f),p={isbn:n,isbn13:t.isbn13||"",isbn10:t.isbn||"",title:t.title||"",author:t.author||"",publisher:t.publisher||"",pubdate:t.pubDate||t.pubdate||"",description:t.description||"",image:t.cover||t.image||"",link:t.link||"",center:o,category:r,labelNumber:s,location:a,status:"available",registeredBy:e,registeredAt:h(),updatedAt:h()};return await A(b,p),{success:!0,book:p,bookId:f}}catch(n){throw console.error("도서 등록 오류:",n),l.value=n.message||"도서 등록에 실패했습니다.",n}finally{u.value=!1}},z=async(t,o,e)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const r=t.isbn13||t.isbn||"";if(!r)throw new Error("ISBN 정보가 없습니다.");const s=$(r,o),a=y(c,"books",s);if((await v(a)).exists())throw new Error("이미 해당 센터에 등록된 도서입니다.");const i={isbn:r,isbn13:t.isbn13||"",isbn10:t.isbn||"",title:t.title||"",author:t.author||"",publisher:t.publisher||"",pubdate:t.pubDate||t.pubdate||"",description:t.description||"",image:t.cover||t.image||"",link:t.link||"",center:o,status:"available",registeredBy:e,registeredAt:h(),updatedAt:h()};return await A(a,i),{success:!0,book:i,bookId:s}}catch(r){throw console.error("도서 등록 오류:",r),l.value=r.message||"도서 등록에 실패했습니다.",r}finally{u.value=!1}},N=async(t=null)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const o=q(c,"books");let e;t?e=I(o,B("center","==",t)):e=o;const r=await R(e),s=[];return r.forEach(a=>{s.push({id:a.id,...a.data()})}),s.sort((a,n)=>{const i=a.registeredAt?.toDate?.()||new Date(0);return(n.registeredAt?.toDate?.()||new Date(0))-i}),s}catch(o){throw console.error("도서 목록 조회 오류:",o),l.value=o.message||"도서 목록 조회에 실패했습니다.",o}finally{u.value=!1}},H=async t=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const o=await N(t),e=new Map;for(const s of o){const a=s.isbn13||s.isbn||s.id;e.has(a)||e.set(a,{isbn:a,title:s.title,author:s.author,publisher:s.publisher,image:s.image,copies:[],totalCount:0,availableCount:0,locations:[]});const n=e.get(a);n.copies.push(s),n.totalCount++;const i=F(s);(!i||i==="available")&&(n.availableCount++,s.location&&!n.locations.includes(s.location)&&n.locations.push(s.location))}const r=Array.from(e.values());return r.sort((s,a)=>{const n=s.copies[0]?.registeredAt?.toDate?.()||new Date(0);return(a.copies[0]?.registeredAt?.toDate?.()||new Date(0))-n}),r}catch(o){throw console.error("그룹핑된 도서 목록 조회 오류:",o),l.value=o.message||"도서 목록 조회에 실패했습니다.",o}finally{u.value=!1}},J=async(t,o)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=q(c,"books"),r=I(e,B("center","==",o),B("isbn","==",t)),s=await R(r),a=[];return s.forEach(n=>{a.push({id:n.id,...n.data()})}),a.sort((n,i)=>{const f=n.labelNumber||"",b=i.labelNumber||"";return f.localeCompare(b,"ko")}),a}catch(e){throw console.error("도서 복사본 조회 오류:",e),e}},K=async(t,o,e,r=null)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const s=g(t,o),a=y(c,"books",s),n=await v(a);if(!n.exists())throw new Error("도서를 찾을 수 없습니다.");const i=n.data(),f=r||i.isbn;if(f){const m=await D(e,f,o);if(m)throw new Error(`이미 같은 도서를 대여중입니다. (라벨번호: ${m.labelNumber||m.id})`)}if(i.status==="rented"&&i.rentedBy)throw new Error("이미 대여 중인 도서입니다.");if(i.status==="requested"&&i.requestedBy&&i.requestedBy!==e)throw new Error("다른 사용자가 대여 신청한 도서입니다.");const b=new Date,p=new Date(b);return p.setDate(p.getDate()+7),await E(a,{status:"rented",rentedBy:e,rentedAt:h(),expectedReturnDate:p,requestedBy:k(),requestedAt:k(),updatedAt:h()}),{success:!0}}catch(s){throw console.error("도서 대여 오류:",s),l.value=s.message||"도서 대여에 실패했습니다.",s}finally{u.value=!1}},Q=async(t,o,e,r=null)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const s=g(t,o),a=y(c,"books",s),n=await v(a);if(!n.exists())throw new Error("도서를 찾을 수 없습니다.");const i=n.data(),f=r||i.isbn;if(f){const b=await D(e,f,o);if(b)throw new Error(`이미 같은 도서를 대여중입니다. (라벨번호: ${b.labelNumber||b.id})`)}if(i.status==="rented"&&i.rentedBy)throw new Error("이미 대여 중인 도서입니다.");if(i.status==="requested"&&i.requestedBy)throw new Error("이미 대여 신청된 도서입니다.");return await E(a,{status:"requested",requestedBy:e,requestedAt:h(),updatedAt:h()}),{success:!0}}catch(s){throw console.error("도서 대여 신청 오류:",s),l.value=s.message||"도서 대여 신청에 실패했습니다.",s}finally{u.value=!1}},V=async(t,o,e)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const r=g(t,o),s=y(c,"books",r),a=await v(s);if(!a.exists())throw new Error("도서를 찾을 수 없습니다.");const n=a.data();if(n.status!=="requested"||n.requestedBy!==e)throw new Error("취소할 수 있는 대여 신청이 아닙니다.");return await E(s,{status:"available",requestedBy:k(),requestedAt:k(),updatedAt:h()}),{success:!0}}catch(r){throw console.error("대여 신청 취소 오류:",r),l.value=r.message||"대여 신청 취소에 실패했습니다.",r}finally{u.value=!1}},X=async(t,o)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const e=g(t,o),r=y(c,"books",e),s=await v(r);if(!s.exists())throw new Error("도서를 찾을 수 없습니다.");if(s.data().status!=="rented")throw new Error("대여 중이 아닌 도서입니다.");return await E(r,{status:"available",rentedBy:k(),rentedAt:k(),expectedReturnDate:k(),returnedAt:h(),updatedAt:h()}),{success:!0}}catch(e){throw console.error("도서 반납 오류:",e),l.value=e.message||"도서 반납에 실패했습니다.",e}finally{u.value=!1}},Y=async(t,o,e)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const r=g(t,o),s=y(c,"books",r),a=await v(s);if(!a.exists())throw new Error("도서를 찾을 수 없습니다.");const n=a.data(),i=e.labelNumber||t;if(i!==t){if(await x(i,o))throw new Error("이미 사용중인 라벨번호입니다.");const b=g(i,o),p=y(c,"books",b),m={...n,category:e.category||n.category,labelNumber:i,location:e.location||n.location,updatedAt:h()};return await A(p,m),await T(s),{success:!0,newBookId:b}}else{const f={updatedAt:h()};return e.category&&(f.category=e.category),e.location&&(f.location=e.location),await E(s,f),{success:!0}}}catch(r){throw console.error("도서 정보 수정 오류:",r),l.value=r.message||"도서 정보 수정에 실패했습니다.",r}finally{u.value=!1}},Z=async(t,o)=>{if(!c)throw new Error("Firebase가 초기화되지 않았습니다.");try{u.value=!0,l.value=null;const e=g(t,o),r=y(c,"books",e);return await T(r),{success:!0}}catch(e){throw console.error("도서 삭제 오류:",e),l.value=e.message||"도서 삭제에 실패했습니다.",e}finally{u.value=!1}},F=t=>{if(!t||t.status==="deleted")return null;if(t.status==="requested"&&t.requestedBy)return"requested";if(t.status==="rented"&&t.rentedAt){const o=t.rentedAt?.toDate?.()||new Date(t.rentedAt),e=new Date(o);return e.setDate(e.getDate()+7),new Date>e?"overdue":"rented"}return null};return{loading:O(u),error:O(l),createBookId:g,createBookIdByIsbn:$,checkLabelNumberExists:x,checkAlreadyRentedSameIsbn:D,getCategories:P,addCategory:G,searchBooks:W,getBestsellers:j,registerBook:z,registerBookWithLabel:U,getBooksByCenter:N,getGroupedBooks:H,getBookCopies:J,rentBook:K,requestRent:Q,cancelRentRequest:V,returnBook:X,updateBookInfo:Y,deleteBook:Z,calculateBookStatus:F}};export{te as C,ie as a,ne as c,C as f,ae as g,ce as p,ue as u};
