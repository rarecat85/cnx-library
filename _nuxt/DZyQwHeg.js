import{u as me,f as ye,D as ne}from"./yWPze8eg.js";import{F as be,k as re,r as H,o as ve,e as pe,Y as ke,n as Be,g as j,O as Ee,H as D,L as I,K as C,I as E,M as R,G as P,U as ie,P as M,R as Ae,J as le,Q as xe,a as qe,aj as ce,ak as v,ar as ue,al as A,ap as y,ao as Y,as as z,at as N,au as J,av as U,aw as k,ax as O}from"./H8Z8LE6b.js";import{g as de,h as fe}from"./9l_XyyT8.js";import{c as _e}from"./C-xtXPWq.js";const he={1:{x:1.5,y:1,width:14,height:13},2:{x:16,y:1,width:14,height:13},3:{x:51,y:1,width:18,height:13},4:{x:69,y:1,width:15,height:27},5:{x:1.5,y:77,width:13,height:12},6:{x:15,y:77,width:14,height:12},7:{x:29,y:77,width:12,height:12},8:{x:41,y:77,width:14,height:12},9:{x:69,y:77,width:15,height:12},구매칸:{x:1.5,y:28,width:13,height:24},기부칸:{x:69,y:54,width:15,height:10}},we={10:{x:1,y:1,width:18,height:12},11:{x:19,y:1,width:18,height:12},12:{x:37,y:1,width:18,height:12},13:{x:55,y:1,width:18,height:12},14:{x:7,y:17,width:14,height:18},15:{x:7,y:38,width:14,height:16},16:{x:7,y:57,width:14,height:16}},se={},oe={},Ie=(w,m)=>{if(!w||!m)return null;if(w==="용산센터"){if(he[m])return{imagePath:"/images/shelves/yongsan-shelf-1.png",area:he[m]};if(we[m])return{imagePath:"/images/shelves/yongsan-shelf-2.png",area:we[m]}}if(w==="강남센터"){if(se[m])return{imagePath:"/images/shelves/gangnam-shelf-1.png",area:se[m]};if(oe[m])return{imagePath:"/images/shelves/gangnam-shelf-2.png",area:oe[m]}}return null},Re=w=>w==="용산센터"?!0:w==="강남센터"?Object.keys(se).length>0||Object.keys(oe).length>0:!1,Ne={class:"location-guide-header"},Fe={class:"location-guide-content"},Se={key:0,class:"shelf-image-container"},De=["src","alt"],Ce={key:1,class:"no-image-message"},Le={class:"location-info-text"},$e={key:2,class:"location-confirm-text"},Ve={key:3,class:"location-confirm-text"},Ge={class:"location-guide-actions"},Pe={__name:"LocationGuidePopup",props:{modelValue:{type:Boolean,default:!1},center:{type:String,required:!0},location:{type:String,required:!0},labelNumber:{type:String,default:""},mode:{type:String,default:"rent",validator:w=>["rent","return","info"].includes(w)}},emits:["update:modelValue"],setup(w,{emit:m}){const n=w,d=m,{loadLocationMapping:f,loadShelfImages:b}=me(),x=re({get:()=>n.modelValue,set:g=>d("update:modelValue",g)}),F=H(!1),B=H(null),Q=H(!1);ve(()=>{const g=()=>{F.value=window.innerWidth<600};g(),window.addEventListener("resize",g),pe(()=>{window.removeEventListener("resize",g)})}),ke(()=>[n.center,n.location,n.modelValue],async([g,c,p])=>{p&&g&&c&&await K(g,c)},{immediate:!0});const K=async(g,c)=>{try{Q.value=!1;const q=(await f())[g]?.[c];if(q){const V=(await b()).find(G=>G.id===q);B.value=V?.url||null}else B.value=null}catch(p){console.warn("Firestore 이미지 로드 실패, 기본 이미지 사용:",p),B.value=null}finally{Q.value=!0}},L=Be().app.baseURL||"/",T=re(()=>{if(B.value)return{imagePath:B.value,area:null};if(!Re(n.center))return null;const g=Ie(n.center,n.location);if(g){const c=L.endsWith("/")?L.slice(0,-1):L;return{...g,imagePath:`${c}${g.imagePath}`}}return null}),X=re(()=>ye(n.location)),$=()=>{x.value=!1};return(g,c)=>{const p=j("v-icon"),q=j("v-btn"),W=j("v-card"),V=j("v-dialog");return D(),Ee(V,{modelValue:M(x),"onUpdate:modelValue":c[0]||(c[0]=G=>xe(x)?x.value=G:null),"max-width":"600",fullscreen:M(F)},{default:I(()=>[C(W,{class:"location-guide-card"},{default:I(()=>[E("div",Ne,[c[2]||(c[2]=E("div",{class:"location-guide-title"}," 도서 위치 안내 ",-1)),C(q,{icon:"",variant:"text",size:"small",onClick:$},{default:I(()=>[C(p,null,{default:I(()=>[...c[1]||(c[1]=[R("mdi-close",-1)])]),_:1})]),_:1})]),E("div",Fe,[M(T)?(D(),P("div",Se,[E("img",{src:M(T).imagePath,alt:`${w.center} 서가 이미지`,class:"shelf-image"},null,8,De)])):(D(),P("div",Ce,[C(p,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:I(()=>[...c[3]||(c[3]=[R(" mdi-image-off-outline ",-1)])]),_:1}),c[4]||(c[4]=E("p",null,"위치 안내 이미지가 준비되지 않았습니다.",-1))])),E("div",Le,[C(p,{size:"small",class:"mr-1"},{default:I(()=>[...c[5]||(c[5]=[R(" mdi-map-marker ",-1)])]),_:1}),w.labelNumber?(D(),P(Ae,{key:0},[c[6]||(c[6]=R(' "',-1)),E("strong",null,le(w.labelNumber),1),c[7]||(c[7]=R('" 도서는 ',-1))],64)):ie("",!0),E("strong",null,le(M(X)),1),c[8]||(c[8]=R("에 있습니다. ",-1))]),w.labelNumber&&w.mode==="rent"?(D(),P("div",$e," 위치와 라벨번호를 확인 후 대여해주세요. ")):w.labelNumber&&w.mode==="return"?(D(),P("div",Ve," 위치와 라벨번호를 확인 후 반납해주세요. ")):ie("",!0)]),E("div",Ge,[C(q,{color:"primary",variant:"flat",block:"",onClick:$},{default:I(()=>[...c[9]||(c[9]=[R(" 확인 ",-1)])]),_:1})])]),_:1})]),_:1},8,["modelValue","fullscreen"])}}},He=be(Pe,[["__scopeId","data-v-74815432"]]),Qe=()=>{const{$firebaseFirestore:w,$firebaseApp:m}=qe(),n=w,d=H(!1),f=H(null),b=(t,r)=>`${t}_${r}`,x=(t,r)=>`${t}_${r}`,F=async(t,r)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=b(t,r),s=v(n,"books",e);return(await A(s)).exists()}catch(e){throw console.error("라벨번호 중복 체크 오류:",e),e}},B=async(t,r,e)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{const s=J(n,"books"),o=U(s,k("center","==",e),k("isbn","==",r),k("rentedBy","==",t)),i=await O(o);for(const h of i.docs){const l=h.data();if(l.status==="rented"||Z(l)==="overdue")return{id:h.id,type:"rented",...l}}const a=U(s,k("center","==",e),k("isbn","==",r),k("requestedBy","==",t)),u=await O(a);for(const h of u.docs){const l=h.data();if(l.status==="requested")return{id:h.id,type:"requested",...l}}return null}catch(s){throw console.error("ISBN 대여 체크 오류:",s),s}},Q=async t=>{let r=[...ne];if(!n)return console.warn("Firebase가 초기화되지 않았습니다. 기본 카테고리만 반환합니다."),r.sort((e,s)=>e.localeCompare(s,"ko"));try{const e=J(n,"categories"),s=U(e,k("center","==",t));(await O(s)).forEach(i=>{const a=i.data();a.name&&!r.includes(a.name)&&r.push(a.name)});try{const i=v(n,"settings","categories"),a=await A(i);if(a.exists()){const h=a.data().items||{};r=r.filter(l=>h[l]?h[l].includes(t):!0)}}catch(i){console.warn("카테고리 설정 조회 실패 (기본 동작 유지):",i)}}catch(e){console.error("추가 카테고리 조회 오류 (기본 카테고리는 사용 가능):",e)}return r.sort((e,s)=>e.localeCompare(s,"ko")),r},K=async(t,r)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=r.trim();if(!e)throw new Error("카테고리명을 입력해주세요.");if(ne.includes(e))return{success:!0,message:"기본 카테고리입니다."};const s=`${t}_${e}`,o=v(n,"categories",s);return(await A(o)).exists()?{success:!0,message:"이미 존재하는 카테고리입니다."}:(await Y(o,{center:t,name:e,createdAt:y()}),{success:!0})}catch(e){throw console.error("카테고리 추가 오류:",e),e}},ae=async(t,r=1,e=20)=>{if(!n||!m)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const s=_e(t);if(!s.trim())return{items:[],total:0};const o=de(m),a=await fe(o,"searchNaverBooks")({query:s,start:r,display:e});if(a.data.success)return a.data.data;throw new Error(a.data.error||"도서 검색에 실패했습니다.")}catch(s){throw console.error("도서 검색 오류:",s),f.value=s.message||"도서 검색에 실패했습니다.",s}finally{d.value=!1}},L=async(t=10)=>{if(!n||!m)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const r=de(m),s=await fe(r,"getAladinBestsellers")({display:t});if(s.data.success)return s.data.data;throw new Error(s.data.error||"베스트셀러 조회에 실패했습니다.")}catch(r){throw console.error("베스트셀러 조회 오류:",r),f.value=r.message||"베스트셀러 조회에 실패했습니다.",r}finally{d.value=!1}},T=async(t,r,e,s,o,i="구매칸")=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const a=t.isbn13||t.isbn||"";if(!a)throw new Error("ISBN 정보가 없습니다.");if(!o)throw new Error("라벨번호를 입력해주세요.");if(!s)throw new Error("카테고리를 선택해주세요.");if(await F(o,r))throw new Error("이미 사용중인 라벨번호입니다.");const h=b(o,r),l=v(n,"books",h),_={isbn:a,isbn13:t.isbn13||"",isbn10:t.isbn||"",title:t.title||"",author:t.author||"",publisher:t.publisher||"",pubdate:t.pubDate||t.pubdate||"",description:t.description||"",image:t.cover||t.image||"",link:t.link||"",center:r,category:s,labelNumber:o,location:i,status:"available",registeredBy:e,registeredAt:y(),updatedAt:y()};return await Y(l,_),{success:!0,book:_,bookId:h}}catch(a){throw console.error("도서 등록 오류:",a),f.value=a.message||"도서 등록에 실패했습니다.",a}finally{d.value=!1}},X=async(t,r,e)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const s=t.isbn13||t.isbn||"";if(!s)throw new Error("ISBN 정보가 없습니다.");const o=x(s,r),i=v(n,"books",o);if((await A(i)).exists())throw new Error("이미 해당 센터에 등록된 도서입니다.");const u={isbn:s,isbn13:t.isbn13||"",isbn10:t.isbn||"",title:t.title||"",author:t.author||"",publisher:t.publisher||"",pubdate:t.pubDate||t.pubdate||"",description:t.description||"",image:t.cover||t.image||"",link:t.link||"",center:r,status:"available",registeredBy:e,registeredAt:y(),updatedAt:y()};return await Y(i,u),{success:!0,book:u,bookId:o}}catch(s){throw console.error("도서 등록 오류:",s),f.value=s.message||"도서 등록에 실패했습니다.",s}finally{d.value=!1}},$=async(t=null)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const r=J(n,"books");let e;t?e=U(r,k("center","==",t)):e=r;const s=await O(e),o=[];return s.forEach(i=>{o.push({id:i.id,...i.data()})}),o.sort((i,a)=>{const u=i.registeredAt?.toDate?.()||new Date(0);return(a.registeredAt?.toDate?.()||new Date(0))-u}),o}catch(r){throw console.error("도서 목록 조회 오류:",r),f.value=r.message||"도서 목록 조회에 실패했습니다.",r}finally{d.value=!1}},g=async t=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const r=await $(t),e=new Map;for(const o of r){const i=o.isbn13||o.isbn||o.id;e.has(i)||e.set(i,{isbn:i,title:o.title,author:o.author,publisher:o.publisher,image:o.image,copies:[],totalCount:0,availableCount:0,locations:[]});const a=e.get(i);a.copies.push(o),a.totalCount++;const u=Z(o);(!u||u==="available")&&(a.availableCount++,o.location&&!a.locations.includes(o.location)&&a.locations.push(o.location))}const s=Array.from(e.values());return s.sort((o,i)=>{const a=o.copies[0]?.registeredAt?.toDate?.()||new Date(0);return(i.copies[0]?.registeredAt?.toDate?.()||new Date(0))-a}),s}catch(r){throw console.error("그룹핑된 도서 목록 조회 오류:",r),f.value=r.message||"도서 목록 조회에 실패했습니다.",r}finally{d.value=!1}},c=async(t,r)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{const e=J(n,"books"),s=U(e,k("center","==",r),k("isbn","==",t)),o=await O(s),i=[];return o.forEach(a=>{i.push({id:a.id,...a.data()})}),i.sort((a,u)=>{const h=a.labelNumber||"",l=u.labelNumber||"";return h.localeCompare(l,"ko")}),i}catch(e){throw console.error("도서 복사본 조회 오류:",e),e}},p=async(t,r,e,s=null,o="user",i="")=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const a=b(t,r),u=v(n,"books",a),h=await A(u);if(!h.exists())throw new Error("도서를 찾을 수 없습니다.");const l=h.data(),_=s||l.isbn;if(_){const S=await B(e,_,r);if(S)throw S.type==="requested"?new Error(`이미 같은 도서를 대여 신청중입니다. (라벨번호: ${S.labelNumber||S.id})`):new Error(`이미 같은 도서를 대여중입니다. (라벨번호: ${S.labelNumber||S.id})`)}if(l.status==="rented"&&l.rentedBy)throw new Error("이미 대여 중인 도서입니다.");if(l.status==="requested"&&l.requestedBy&&l.requestedBy!==e)throw new Error("다른 사용자가 대여 신청한 도서입니다.");const ee=new Date,te=new Date(ee);return te.setDate(te.getDate()+7),await z(u,{status:"rented",rentedBy:e,rentedByType:o,rentedByEmail:i,rentedAt:y(),expectedReturnDate:te,requestedBy:N(),requestedAt:N(),updatedAt:y()}),{success:!0}}catch(a){throw console.error("도서 대여 오류:",a),f.value=a.message||"도서 대여에 실패했습니다.",a}finally{d.value=!1}},q=async(t,r,e,s=null)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const o=b(t,r),i=v(n,"books",o),a=await A(i);if(!a.exists())throw new Error("도서를 찾을 수 없습니다.");const u=a.data(),h=s||u.isbn;if(h){const l=await B(e,h,r);if(l)throw l.type==="requested"?new Error(`이미 같은 도서를 대여 신청중입니다. (라벨번호: ${l.labelNumber||l.id})`):new Error(`이미 같은 도서를 대여중입니다. (라벨번호: ${l.labelNumber||l.id})`)}if(u.status==="rented"&&u.rentedBy)throw new Error("이미 대여 중인 도서입니다.");if(u.status==="requested"&&u.requestedBy)throw new Error("이미 대여 신청된 도서입니다.");return await z(i,{status:"requested",requestedBy:e,requestedAt:y(),updatedAt:y()}),{success:!0}}catch(o){throw console.error("도서 대여 신청 오류:",o),f.value=o.message||"도서 대여 신청에 실패했습니다.",o}finally{d.value=!1}},W=async(t,r,e)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const s=b(t,r),o=v(n,"books",s),i=await A(o);if(!i.exists())throw new Error("도서를 찾을 수 없습니다.");const a=i.data();if(a.status!=="requested"||a.requestedBy!==e)throw new Error("취소할 수 있는 대여 신청이 아닙니다.");return await z(o,{status:"available",requestedBy:N(),requestedAt:N(),updatedAt:y()}),{success:!0}}catch(s){throw console.error("대여 신청 취소 오류:",s),f.value=s.message||"대여 신청 취소에 실패했습니다.",s}finally{d.value=!1}},V=async(t,r)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const e=b(t,r),s=v(n,"books",e),o=await A(s);if(!o.exists())throw new Error("도서를 찾을 수 없습니다.");if(o.data().status!=="rented")throw new Error("대여 중이 아닌 도서입니다.");return await z(s,{status:"available",rentedBy:N(),rentedAt:N(),expectedReturnDate:N(),returnedAt:y(),updatedAt:y()}),{success:!0}}catch(e){throw console.error("도서 반납 오류:",e),f.value=e.message||"도서 반납에 실패했습니다.",e}finally{d.value=!1}},G=async(t,r,e)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const s=b(t,r),o=v(n,"books",s),i=await A(o);if(!i.exists())throw new Error("도서를 찾을 수 없습니다.");const a=i.data(),u=e.labelNumber||t;if(u!==t){if(await F(u,r))throw new Error("이미 사용중인 라벨번호입니다.");const l=b(u,r),_=v(n,"books",l),ee={...a,category:e.category||a.category,labelNumber:u,location:e.location||a.location,updatedAt:y()};return await Y(_,ee),await ue(o),{success:!0,newBookId:l}}else{const h={updatedAt:y()};return e.category&&(h.category=e.category),e.location&&(h.location=e.location),await z(o,h),{success:!0}}}catch(s){throw console.error("도서 정보 수정 오류:",s),f.value=s.message||"도서 정보 수정에 실패했습니다.",s}finally{d.value=!1}},ge=async(t,r)=>{if(!n)throw new Error("Firebase가 초기화되지 않았습니다.");try{d.value=!0,f.value=null;const e=b(t,r),s=v(n,"books",e);return await ue(s),{success:!0}}catch(e){throw console.error("도서 삭제 오류:",e),f.value=e.message||"도서 삭제에 실패했습니다.",e}finally{d.value=!1}},Z=t=>{if(!t||t.status==="deleted")return null;if(t.status==="requested"&&t.requestedBy)return"requested";if(t.status==="rented"&&t.rentedAt){const r=t.rentedAt?.toDate?.()||new Date(t.rentedAt),e=new Date(r);return e.setDate(e.getDate()+7),new Date>e?"overdue":"rented"}return null};return{loading:ce(d),error:ce(f),createBookId:b,createBookIdByIsbn:x,checkLabelNumberExists:F,checkAlreadyRentedSameIsbn:B,getCategories:Q,addCategory:K,searchBooks:ae,getBestsellers:L,registerBook:X,registerBookWithLabel:T,getBooksByCenter:$,getGroupedBooks:g,getBookCopies:c,rentBook:p,requestRent:q,cancelRentRequest:W,returnBook:V,updateBookInfo:G,deleteBook:ge,calculateBookStatus:Z}};export{He as _,Re as h,Qe as u};
