const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CwIB7HyG.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as ke,N as Ae,a as Re,D as Be,r as x,k as qe,o as oe,e as Ee,Y as Ce,_ as L,O as S,L as b,g as C,H as v,K as h,P as r,I as d,M as B,G as D,Q as re,T as W,J as P,W as Z,X as ee}from"./CwIB7HyG.js";import{_ as Ne}from"./dK42HwtM.js";import{g as Le,C as $e,_ as Ie}from"./Dpaynyfl.js";import{_ as Se}from"./D9ndqd8O.js";import{u as Te}from"./xmrXBxtb.js";import{u as Ve}from"./CNFoeud_.js";import{u as He}from"./MI6WMmTQ.js";import"./ByLYD2Od.js";const Pe={class:"mypage"},Oe={class:"page-header mb-6"},Fe={class:"page-header-inner"},ze={class:"rental-section mb-8"},Me={class:"section-header-with-filter mb-4"},We={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},je={class:"text-body-1"},Ue={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},Qe={key:0,class:"text-center py-8"},Xe={key:1,class:"rental-books-grid"},Ye={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},Ge={class:"requested-section mb-8"},Je={key:0,class:"text-center py-8"},Ke={key:1,class:"requested-books-grid"},Ze={class:"requested-book-item"},et={class:"requested-book-actions"},tt={class:"requested-info"},st={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},at={class:"history-section"},nt={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},ot={class:"text-body-1"},rt={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},lt={key:0,class:"text-center py-8"},it={key:1,class:"history-books-grid"},ct={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},dt={class:"drawer-content"},ut={__name:"index",setup(mt){const{user:y}=Te(),{cancelRentRequest:le}=Ve(),{confirm:O,alert:q}=Ae(),{$firebaseFirestore:ie}=Re(),w=ie,T=Be("navigationDrawer",()=>!1),te=x(280),se=[...$e],N=x(""),F=x([]),j=x(!1),$=x([]),U=x(!1),Q=x(null),z=qe(()=>N.value?F.value.filter(t=>t.center===N.value):F.value),I=x([]),X=x(!1),g=x([]),k=x([]),Y=x(!1),V=x(!1);oe(()=>{const t=()=>{te.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Ee(()=>{window.removeEventListener("resize",t)})}),Ce(N,()=>{g.value=[]});const ce=async()=>{if(!y.value||!w)return"";try{const{doc:t,getDoc:e}=await L(async()=>{const{doc:m,getDoc:_}=await import("./CwIB7HyG.js").then(f=>f.aE);return{doc:m,getDoc:_}},__vite__mapDeps([0,1]),import.meta.url),n=t(w,"users",y.value.uid),u=await e(n);if(u.exists())return u.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};oe(async()=>{const t=await ce();N.value=t?Le(t):se[0],await Promise.all([G(),de(),M()])});const de=async()=>{if(!(!y.value||!w))try{U.value=!0;const{collection:t,query:e,where:n,getDocs:u}=await L(async()=>{const{collection:l,query:o,where:s,getDocs:i}=await import("./CwIB7HyG.js").then(p=>p.aE);return{collection:l,query:o,where:s,getDocs:i}},__vite__mapDeps([0,1]),import.meta.url),m=t(w,"books"),_=e(m,n("requestedBy","==",y.value.uid),n("status","==","requested")),f=await u(_),c=[];f.forEach(l=>{c.push({id:l.id,...l.data()})}),c.sort((l,o)=>{const s=l.requestedAt?.toDate?.()||new Date(0);return(o.requestedAt?.toDate?.()||new Date(0))-s}),$.value=c}catch(t){console.error("신청 도서 로드 오류:",t),$.value=[]}finally{U.value=!1}},G=async()=>{if(!(!y.value||!w))try{j.value=!0;const{collection:t,query:e,where:n,getDocs:u}=await L(async()=>{const{collection:l,query:o,where:s,getDocs:i}=await import("./CwIB7HyG.js").then(p=>p.aE);return{collection:l,query:o,where:s,getDocs:i}},__vite__mapDeps([0,1]),import.meta.url),m=t(w,"books"),_=e(m,n("rentedBy","==",y.value.uid)),f=await u(_),c=[];f.forEach(l=>{const o=l.data();o.rentedAt&&c.push({id:l.id,...o})}),c.sort((l,o)=>{const s=l.rentedAt?.toDate?.()||new Date(0);return(o.rentedAt?.toDate?.()||new Date(0))-s}),F.value=c}catch(t){console.error("대여 도서 로드 오류:",t),F.value=[]}finally{j.value=!1}},M=async()=>{if(!(!y.value||!w))try{X.value=!0;const{collection:t,query:e,where:n,getDocs:u}=await L(async()=>{const{collection:o,query:s,where:i,getDocs:p}=await import("./CwIB7HyG.js").then(a=>a.aE);return{collection:o,query:s,where:i,getDocs:p}},__vite__mapDeps([0,1]),import.meta.url),m=t(w,"rentalHistory"),_=e(m,n("userId","==",y.value.uid)),f=await u(_),c=new Map;f.forEach(o=>{const s=o.data(),i=s.isbn13||s.isbn||"";if(!i){const p=s.bookId;c.has(p)||c.set(p,{id:o.id,...s});return}if(!c.has(i))c.set(i,{id:o.id,...s});else{const a=c.get(i).returnedAt?.toDate?.()||new Date(0);(s.returnedAt?.toDate?.()||new Date(0))>a&&c.set(i,{id:o.id,...s})}});const l=Array.from(c.values());l.sort((o,s)=>{const i=o.returnedAt?.toDate?.()||new Date(0);return(s.returnedAt?.toDate?.()||new Date(0))-i}),I.value=l}catch(t){console.error("대여 이력 로드 오류:",t),I.value=[]}finally{X.value=!1}},ue=t=>{if(!t)return"";const e=t?.toDate?.()||new Date(t),n=e.getFullYear(),u=String(e.getMonth()+1).padStart(2,"0"),m=String(e.getDate()).padStart(2,"0");return`${n}.${u}.${m} 신청`},me=t=>{if(!t.rentedAt)return null;const e=t.rentedAt?.toDate?.()||new Date(t.rentedAt),n=new Date(e);return n.setDate(n.getDate()+7),n},ae=t=>g.value.some(e=>e.id===t.id),ve=(t,e)=>{e?ae(t)||g.value.push(t):g.value=g.value.filter(n=>n.id!==t.id)},ne=t=>k.value.some(e=>e.id===t.id),pe=(t,e)=>{e?ne(t)||k.value.push(t):k.value=k.value.filter(n=>n.id!==t.id)},ye=async t=>{if(!(!y.value||!t)&&await O(`"${t.title}" 대여 신청을 취소하시겠습니까?`))try{Q.value=t.id;const e=t.labelNumber||t.id.split("_")[0];await le(e,t.center,y.value.uid),$.value=$.value.filter(n=>n.id!==t.id),await q("대여 신청이 취소되었습니다.",{type:"success"})}catch(e){console.error("신청 취소 오류:",e),await q(e.message||"신청 취소에 실패했습니다.",{type:"error"})}finally{Q.value=null}},_e=async()=>{if(k.value.length===0||!y.value)return;const t=k.value.map(e=>e.title).join(", ");if(await O(`다음 도서들을 읽은 책 목록에서 삭제하시겠습니까?

${t}`))try{Y.value=!0;const{doc:e,deleteDoc:n}=await L(async()=>{const{doc:u,deleteDoc:m}=await import("./CwIB7HyG.js").then(_=>_.aE);return{doc:u,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url);for(const u of k.value)await n(e(w,"rentalHistory",u.id));await M(),await q(`${k.value.length}권이 읽은 책 목록에서 삭제되었습니다.`,{type:"success"}),k.value=[]}catch(e){console.error("이력 삭제 오류:",e),await q("삭제에 실패했습니다.",{type:"error"})}finally{Y.value=!1}},fe=async()=>{if(g.value.length===0||!y.value)return;const t=g.value.map(e=>`${e.title} (${e.labelNumber||"-"})`).join(`
`);if(await O(`다음 도서들을 반납하시겠습니까?

${t}`))try{V.value=!0;const{doc:e,updateDoc:n,collection:u,addDoc:m,query:_,where:f,getDocs:c,serverTimestamp:l,deleteField:o}=await L(async()=>{const{doc:s,updateDoc:i,collection:p,addDoc:a,query:A,where:R,getDocs:E,serverTimestamp:H,deleteField:J}=await import("./CwIB7HyG.js").then(K=>K.aE);return{doc:s,updateDoc:i,collection:p,addDoc:a,query:A,where:R,getDocs:E,serverTimestamp:H,deleteField:J}},__vite__mapDeps([0,1]),import.meta.url);for(const s of g.value){const i=e(w,"books",s.id);await n(i,{status:"available",rentedBy:o(),rentedAt:o(),expectedReturnDate:o()});const p=u(w,"rentalHistory"),a=s.isbn13||s.isbn||"",A=_(p,f("userId","==",y.value.uid),f("isbn13","==",a)),R=await c(A);if(R.empty)await m(p,{bookId:s.id,labelNumber:s.labelNumber||"",isbn13:s.isbn13||"",isbn:s.isbn||"",title:s.title||"",author:s.author||"",publisher:s.publisher||"",cover:s.cover||s.image||"",center:s.center||"",userId:y.value.uid,rentedAt:s.rentedAt,returnedAt:l(),rentCount:1});else{const E=R.docs[0],H=E.data();await n(e(w,"rentalHistory",E.id),{rentedAt:s.rentedAt,returnedAt:l(),rentCount:(H.rentCount||1)+1})}}await Promise.all([G(),M()]),await q(`${g.value.length}권의 도서가 반납되었습니다.`,{type:"success"}),g.value=[]}catch(e){console.error("반납 처리 오류:",e),await q("반납 처리에 실패했습니다.",{type:"error"})}finally{V.value=!1}},he=async t=>{if(!(!y.value||!t)&&await O(`"${t.title}"을(를) 반납하시겠습니까?
라벨번호: ${t.labelNumber||"-"}`))try{V.value=!0;const{doc:e,updateDoc:n,collection:u,addDoc:m,query:_,where:f,getDocs:c,serverTimestamp:l,deleteField:o}=await L(async()=>{const{doc:R,updateDoc:E,collection:H,addDoc:J,query:K,where:we,getDocs:ge,serverTimestamp:be,deleteField:De}=await import("./CwIB7HyG.js").then(xe=>xe.aE);return{doc:R,updateDoc:E,collection:H,addDoc:J,query:K,where:we,getDocs:ge,serverTimestamp:be,deleteField:De}},__vite__mapDeps([0,1]),import.meta.url),s=e(w,"books",t.id);await n(s,{status:"available",rentedBy:o(),rentedAt:o(),expectedReturnDate:o()});const i=u(w,"rentalHistory"),p=t.isbn13||t.isbn||"",a=_(i,f("userId","==",y.value.uid),f("isbn13","==",p)),A=await c(a);if(A.empty)await m(i,{bookId:t.id,labelNumber:t.labelNumber||"",isbn13:t.isbn13||"",isbn:t.isbn||"",title:t.title||"",author:t.author||"",publisher:t.publisher||"",cover:t.cover||t.image||"",center:t.center||"",userId:y.value.uid,rentedAt:t.rentedAt,returnedAt:l(),rentCount:1});else{const R=A.docs[0],E=R.data();await n(e(w,"rentalHistory",R.id),{rentedAt:t.rentedAt,returnedAt:l(),rentCount:(E.rentCount||1)+1})}await Promise.all([G(),M()]),g.value=g.value.filter(R=>R.id!==t.id),await q("도서가 반납되었습니다.",{type:"success"})}catch(e){console.error("반납 처리 오류:",e),await q("반납 처리에 실패했습니다.",{type:"error"})}finally{V.value=!1}};return He({title:"마이페이지 - CNX Library",meta:[{name:"description",content:"내 대여 목록 및 읽은 책 이력"}]}),(t,e)=>{const n=C("v-btn"),u=C("v-select"),m=C("v-progress-circular"),_=Ne,f=C("v-col"),c=C("v-row"),l=C("v-icon"),o=Ie,s=Se,i=C("v-navigation-drawer"),p=C("v-app");return v(),S(p,null,{default:b(()=>[h(o,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[1]||(e[1]=a=>T.value=!r(T))},{default:b(()=>[d("div",Pe,[d("div",Oe,[d("div",Fe,[e[4]||(e[4]=d("h1",{class:"page-title mb-0"}," 마이페이지 ",-1)),h(n,{class:"edit-profile-btn",variant:"flat",size:"small",to:"/mypage/edit"},{default:b(()=>[...e[3]||(e[3]=[B(" 정보수정 ",-1)])]),_:1})])]),d("div",ze,[d("div",Me,[e[5]||(e[5]=d("h2",{class:"section-title"}," 내 대여 목록 ",-1)),h(u,{modelValue:r(N),"onUpdate:modelValue":e[0]||(e[0]=a=>re(N)?N.value=a:null),items:se,variant:"outlined",density:"comfortable","hide-details":"",class:"center-filter-select"},null,8,["modelValue"])]),d("div",We,[d("div",je,[e[6]||(e[6]=B(" 총 ",-1)),d("strong",null,P(r(z).length),1),e[7]||(e[7]=B("권 대여중 ",-1)),r(g).length>0?(v(),D("span",Ue," ("+P(r(g).length)+"권 선택됨) ",1)):W("",!0)]),r(z).length>0?(v(),S(n,{key:0,class:"return-btn",variant:"flat",size:"small",disabled:r(g).length===0,loading:r(V),onClick:fe},{default:b(()=>[...e[8]||(e[8]=[B(" 반납하기 ",-1)])]),_:1},8,["disabled","loading"])):W("",!0)]),r(j)?(v(),D("div",Qe,[h(m,{indeterminate:"",color:"primary"})])):r(z).length>0?(v(),D("div",Xe,[h(c,{class:"book-list-row"},{default:b(()=>[(v(!0),D(Z,null,ee(r(z),(a,A)=>(v(),S(f,{key:`rented-${A}`,cols:"12",sm:"6",class:"book-list-col"},{default:b(()=>[h(_,{book:a,center:a.center||"","show-action":!1,selectable:!0,selected:ae(a),"show-status-flags":!1,"show-return-date":!0,"return-date":me(a),"show-label-number":!0,"label-number":a.labelNumber,"show-location":!0,location:a.location,onSelect:ve,onReturn:he},null,8,["book","center","selected","return-date","label-number","location"])]),_:2},1024))),128))]),_:1})])):(v(),D("div",Ye," 현재 대여중인 도서가 없습니다. "))]),d("div",Ge,[e[11]||(e[11]=d("div",{class:"section-header mb-4"},[d("h2",{class:"section-title"}," 내가 신청한 책 ")],-1)),r(U)?(v(),D("div",Je,[h(m,{indeterminate:"",color:"primary"})])):r($).length>0?(v(),D("div",Ke,[h(c,{class:"book-list-row"},{default:b(()=>[(v(!0),D(Z,null,ee(r($),(a,A)=>(v(),S(f,{key:`requested-${A}`,cols:"12",sm:"6",class:"book-list-col"},{default:b(()=>[d("div",Ze,[h(_,{book:a,center:a.center||"","show-action":!1,selectable:!1,"show-status-flags":!1,"show-label-number":!!a.labelNumber,"label-number":a.labelNumber,"show-location":!!a.location,location:a.location},null,8,["book","center","show-label-number","label-number","show-location","location"]),d("div",et,[d("div",tt,[h(l,{size:"small",class:"mr-1"},{default:b(()=>[...e[9]||(e[9]=[B(" mdi-clock-outline ",-1)])]),_:1}),B(" "+P(ue(a.requestedAt)),1)]),h(n,{color:"error",variant:"outlined",size:"small",loading:r(Q)===a.id,onClick:R=>ye(a)},{default:b(()=>[...e[10]||(e[10]=[B(" 신청 취소 ",-1)])]),_:1},8,["loading","onClick"])])])]),_:2},1024))),128))]),_:1})])):(v(),D("div",st," 신청한 도서가 없습니다. "))]),d("div",at,[e[15]||(e[15]=d("div",{class:"section-header mb-4"},[d("h2",{class:"section-title"}," 읽은 책 목록 ")],-1)),d("div",nt,[d("div",ot,[e[12]||(e[12]=B(" 총 ",-1)),d("strong",null,P(r(I).length),1),e[13]||(e[13]=B("권 ",-1)),r(k).length>0?(v(),D("span",rt," ("+P(r(k).length)+"권 선택됨) ",1)):W("",!0)]),r(I).length>0?(v(),S(n,{key:0,class:"delete-history-btn",variant:"flat",size:"small",disabled:r(k).length===0,loading:r(Y),onClick:_e},{default:b(()=>[...e[14]||(e[14]=[B(" 삭제하기 ",-1)])]),_:1},8,["disabled","loading"])):W("",!0)]),r(X)?(v(),D("div",lt,[h(m,{indeterminate:"",color:"primary"})])):r(I).length>0?(v(),D("div",it,[h(c,{class:"book-list-row"},{default:b(()=>[(v(!0),D(Z,null,ee(r(I),(a,A)=>(v(),S(f,{key:`history-${a.id}`,cols:"12",sm:"6",class:"book-list-col"},{default:b(()=>[h(_,{book:a,center:a.center||"","show-action":!1,selectable:!0,selected:ne(a),"show-status-flags":!1,onSelect:pe},null,8,["book","center","selected"])]),_:2},1024))),128))]),_:1})])):(v(),D("div",ct," 아직 읽은 책이 없습니다. "))])])]),_:1}),h(i,{modelValue:r(T),"onUpdate:modelValue":e[2]||(e[2]=a=>re(T)?T.value=a:null),location:"right",temporary:"",width:r(te),class:"side-navigation"},{default:b(()=>[d("div",dt,[h(s)])]),_:1},8,["modelValue","width"])]),_:1})}}},bt=ke(ut,[["__scopeId","data-v-03029775"]]);export{bt as default};
