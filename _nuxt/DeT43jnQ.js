const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Dw84HrPm.js","./entry.yfGVSS21.css"])))=>i.map(i=>d[i]);
import{F as De,N as xe,a as Ce,r as g,k as B,o as ne,e as Re,_ as N,O as X,L as v,g as p,H as x,K as l,P as a,I as s,Q as I,$ as Ee,M as h,G as W,U as Le,J as D,R as Pe,S as Ae}from"./Dw84HrPm.js";import{g as j,C as le,_ as Se,W as Te}from"./BmY9MuGI.js";import{u as Ue,_ as Be}from"./Co5Ttkt1.js";import{u as re}from"./DjMHYbGS.js";import{u as Ne}from"./DaFGRQh7.js";import"./Doj8Tdqm.js";const Ie={class:"pending-users-page"},Oe={class:"center-header mb-6"},$e={class:"center-header-inner"},qe={class:"search-section mb-6"},ze={class:"search-row"},We={class:"pending-users-section"},Fe={class:"section-header mb-4"},Qe={class:"text-body-2 text-medium-emphasis"},Ke={key:0,class:"text-center py-6"},Me={class:"user-card"},He={class:"user-card-header"},Ge={class:"user-card-content"},Je={class:"user-name"},Xe={class:"user-info text-body-2"},je={class:"user-info text-body-2"},Ye={class:"user-info text-body-2"},Ze={class:"user-card-action"},et={key:2,class:"text-center py-6 text-medium-emphasis empty-state"},tt={key:3,class:"pagination-wrapper mt-6"},at={class:"register-dialog-title text-h6"},ot={class:"register-dialog-content"},st={class:"text-body-2 text-medium-emphasis"},nt={class:"register-dialog-actions"},lt={class:"drawer-content"},Y=10,rt={__name:"pending",setup(it){const{confirm:ie,alert:C}=xe(),{$firebaseFirestore:ce}=Ce(),_=ce,{user:Z}=re(),{drawer:A,drawerWidth:ee}=Ue(),S=g([]),F=g(!1),te=g({}),R=g(""),E=g(le[0]),ae=le,ue=Te,L=g(1),P=g(!1),V=g(!1),O=g(null),Q=g(!1),K=g(null),n=g({email:"",name:"",workplace:""}),u=g({email:"",name:"",workplace:""}),$=B(()=>{let t=[...S.value];if(R.value){const e=R.value.toLowerCase().trim();t=t.filter(d=>{const r=(d.name||"").toLowerCase(),i=(d.email||"").toLowerCase();return r.includes(e)||i.includes(e)})}return E.value&&(t=t.filter(e=>e.center===E.value)),t}),oe=B(()=>Math.ceil($.value.length/Y)),de=B(()=>{const t=(L.value-1)*Y,e=t+Y;return $.value.slice(t,e)}),me=B(()=>n.value.workplace?j(n.value.workplace):"-"),ve=B(()=>n.value.email&&n.value.name&&n.value.workplace&&!u.value.email&&!u.value.name&&!u.value.workplace),M=t=>te.value[t]||0;ne(()=>{const t=()=>{ee.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Re(()=>{window.removeEventListener("resize",t)})});const pe=async()=>{if(!Z.value||!_)return"";try{const{doc:t,getDoc:e}=await N(async()=>{const{doc:i,getDoc:w}=await import("./Dw84HrPm.js").then(c=>c.b2);return{doc:i,getDoc:w}},__vite__mapDeps([0,1]),import.meta.url),d=t(_,"users",Z.value.uid),r=await e(d);if(r.exists())return r.data().workplace||""}catch(t){console.error("사용자 근무지 정보 조회 오류:",t)}return""};ne(async()=>{const t=await pe();E.value=t?j(t):ae[0],await H()});const H=async()=>{if(_)try{F.value=!0;const{collection:t,getDocs:e,query:d,where:r}=await N(async()=>{const{collection:c,getDocs:f,query:y,where:k}=await import("./Dw84HrPm.js").then(m=>m.b2);return{collection:c,getDocs:f,query:y,where:k}},__vite__mapDeps([0,1]),import.meta.url),i=t(_,"pendingUsers"),w=await e(i);S.value=w.docs.map(c=>({id:c.id,...c.data()})),await _e()}catch(t){console.error("임시 회원 목록 로드 오류:",t),S.value=[]}finally{F.value=!1}},_e=async()=>{if(!(!_||S.value.length===0))try{const{collection:t,query:e,where:d,getDocs:r}=await N(async()=>{const{collection:c,query:f,where:y,getDocs:k}=await import("./Dw84HrPm.js").then(m=>m.b2);return{collection:c,query:f,where:y,getDocs:k}},__vite__mapDeps([0,1]),import.meta.url),i=t(_,"books"),w={};for(const c of S.value){const f=e(i,d("rentedBy","==",c.id),d("rentedByType","==","pending")),y=await r(f);let k=0;y.forEach(m=>{const b=m.data();(b.status==="rented"||b.status==="overdue")&&k++}),w[c.id]=k}te.value=w}catch(t){console.error("대여 권수 조회 오류:",t)}},fe=()=>{L.value=1},ge=()=>{R.value="",L.value=1},we=()=>{V.value=!1,O.value=null,n.value={email:"",name:"",workplace:""},u.value={email:"",name:"",workplace:""},P.value=!0},ye=t=>{V.value=!0,O.value=t.id,n.value={email:t.email,name:t.name,workplace:t.workplace},u.value={email:"",name:"",workplace:""},P.value=!0},se=()=>{P.value=!1,V.value=!1,O.value=null,n.value={email:"",name:"",workplace:""},u.value={email:"",name:"",workplace:""}},ke=t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),he=async()=>{if(_){if(u.value={email:"",name:"",workplace:""},!n.value.email){u.value.email="이메일을 입력해주세요.";return}if(!ke(n.value.email)){u.value.email="유효한 이메일 형식이 아닙니다.";return}if(!n.value.name){u.value.name="이름을 입력해주세요.";return}if(!n.value.workplace){u.value.workplace="근무지를 선택해주세요.";return}try{Q.value=!0;const{collection:t,query:e,where:d,getDocs:r,doc:i,setDoc:w,updateDoc:c,serverTimestamp:f}=await N(async()=>{const{collection:m,query:b,where:q,getDocs:T,doc:U,setDoc:z,updateDoc:G,serverTimestamp:J}=await import("./Dw84HrPm.js").then(o=>o.b2);return{collection:m,query:b,where:q,getDocs:T,doc:U,setDoc:z,updateDoc:G,serverTimestamp:J}},__vite__mapDeps([0,1]),import.meta.url),{user:y}=re();if(!V.value){const m=t(_,"users"),b=e(m,d("email","==",n.value.email));if(!(await r(b)).empty){u.value.email="이미 가입된 회원의 이메일입니다.";return}const T=t(_,"pendingUsers"),U=e(T,d("email","==",n.value.email));if(!(await r(U)).empty){u.value.email="이미 등록된 임시 회원 이메일입니다.";return}}const k=j(n.value.workplace);if(V.value){const m=i(_,"pendingUsers",O.value);await c(m,{name:n.value.name,workplace:n.value.workplace,center:k,updatedAt:f()}),await C("임시 회원 정보가 수정되었습니다.",{type:"success"})}else{const m=t(_,"pendingUsers"),b=i(m);await w(b,{email:n.value.email,name:n.value.name,workplace:n.value.workplace,center:k,role:"pending",createdAt:f(),createdBy:y.value?.uid||"unknown",updatedAt:f()}),await C("임시 회원이 등록되었습니다.",{type:"success"})}se(),await H()}catch(t){console.error("임시 회원 저장 오류:",t),await C("저장에 실패했습니다.",{type:"error"})}finally{Q.value=!1}}},be=async t=>{if(!_)return;const e=M(t.id);if(e>0){await C(`대여중인 도서가 ${e}권 있어 삭제할 수 없습니다.
반납 처리 후 삭제해주세요.`,{type:"warning"});return}if(await ie(`"${t.name||t.email}"님을 삭제하시겠습니까?

이 작업은 되돌릴 수 없습니다.`))try{K.value=t.id;const{doc:r,deleteDoc:i}=await N(async()=>{const{doc:c,deleteDoc:f}=await import("./Dw84HrPm.js").then(y=>y.b2);return{doc:c,deleteDoc:f}},__vite__mapDeps([0,1]),import.meta.url),w=r(_,"pendingUsers",t.id);await i(w),await H(),await C("임시 회원이 삭제되었습니다.",{type:"success"})}catch(r){console.error("임시 회원 삭제 오류:",r),await C("삭제에 실패했습니다.",{type:"error"})}finally{K.value=null}};return Ne({title:"임시 회원 관리 - CNX Library",meta:[{name:"description",content:"임시 회원 등록 및 관리"}]}),(t,e)=>{const d=p("v-select"),r=p("v-text-field"),i=p("v-btn"),w=p("v-progress-circular"),c=p("v-chip"),f=p("v-col"),y=p("v-row"),k=p("v-icon"),m=p("v-pagination"),b=Se,q=p("v-spacer"),T=p("v-card"),U=p("v-dialog"),z=Be,G=p("v-navigation-drawer"),J=p("v-app");return x(),X(J,null,{default:v(()=>[l(b,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[3]||(e[3]=o=>A.value=!a(A))},{default:v(()=>[s("div",Ie,[s("div",Oe,[s("div",$e,[e[9]||(e[9]=s("h1",{class:"page-title mb-0"}," 임시 회원 관리 ",-1)),l(d,{modelValue:a(E),"onUpdate:modelValue":e[0]||(e[0]=o=>I(E)?E.value=o:null),items:a(ae),variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue","items"])])]),s("div",qe,[s("div",ze,[l(r,{modelValue:a(R),"onUpdate:modelValue":e[1]||(e[1]=o=>I(R)?R.value=o:null),label:"회원 검색 (이름 또는 이메일)","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"search-input",onKeyup:Ee(fe,["enter"]),"onClick:clear":ge},null,8,["modelValue"]),l(i,{color:"primary",size:"small",variant:"flat",class:"register-btn",onClick:we},{default:v(()=>[...e[10]||(e[10]=[h(" 임시 회원 등록 ",-1)])]),_:1})])]),s("div",We,[s("div",Fe,[e[11]||(e[11]=s("h2",{class:"section-title"}," 임시 회원 목록 ",-1)),s("div",Qe," 총 "+D(a($).length)+"명 ",1)]),a(F)?(x(),W("div",Ke,[l(w,{indeterminate:"",color:"primary"})])):a($).length>0?(x(),X(y,{key:1,class:"users-grid"},{default:v(()=>[(x(!0),W(Pe,null,Ae(a(de),o=>(x(),X(f,{key:o.id,cols:"12",sm:"6"},{default:v(()=>[s("div",Me,[s("div",He,[l(c,{color:"warning",size:"x-small",variant:"flat",class:"role-chip"},{default:v(()=>[...e[12]||(e[12]=[h(" 임시회원 ",-1)])]),_:1})]),s("div",Ge,[s("div",Je,D(o.name||"이름 없음"),1),s("div",Xe,[e[13]||(e[13]=s("strong",null,"이메일:",-1)),h(" "+D(o.email),1)]),s("div",je,[e[14]||(e[14]=s("strong",null,"근무지:",-1)),h(" "+D(o.workplace||"-"),1)]),s("div",Ye,[e[15]||(e[15]=s("strong",null,"현재 대여:",-1)),h(" "+D(M(o.id))+"권 ",1)])]),s("div",Ze,[l(i,{color:"primary",size:"small",class:"action-btn mb-2",onClick:Ve=>ye(o)},{default:v(()=>[...e[16]||(e[16]=[h(" 수정 ",-1)])]),_:1},8,["onClick"]),l(i,{size:"small",variant:"outlined",color:"error",class:"action-btn",loading:a(K)===o.id,disabled:M(o.id)>0,onClick:Ve=>be(o)},{default:v(()=>[...e[17]||(e[17]=[h(" 삭제 ",-1)])]),_:1},8,["loading","disabled","onClick"])])])]),_:2},1024))),128))]),_:1})):(x(),W("div",et,[l(k,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:v(()=>[...e[18]||(e[18]=[h(" mdi-account-off-outline ",-1)])]),_:1}),e[19]||(e[19]=s("p",null,"등록된 임시 회원이 없습니다.",-1))])),a(oe)>1?(x(),W("div",tt,[l(m,{modelValue:a(L),"onUpdate:modelValue":e[2]||(e[2]=o=>I(L)?L.value=o:null),length:a(oe),"total-visible":5,density:"comfortable",rounded:"circle"},null,8,["modelValue","length"])])):Le("",!0)])])]),_:1}),l(U,{modelValue:a(P),"onUpdate:modelValue":e[7]||(e[7]=o=>I(P)?P.value=o:null),"max-width":"450"},{default:v(()=>[l(T,{class:"register-dialog-card"},{default:v(()=>[s("div",at,D(a(V)?"임시 회원 정보 수정":"임시 회원 등록"),1),s("div",ot,[l(r,{modelValue:a(n).email,"onUpdate:modelValue":e[4]||(e[4]=o=>a(n).email=o),label:"이메일",variant:"outlined",density:"comfortable",placeholder:"example@email.com","error-messages":a(u).email,disabled:a(V),class:"mb-3"},null,8,["modelValue","error-messages","disabled"]),l(r,{modelValue:a(n).name,"onUpdate:modelValue":e[5]||(e[5]=o=>a(n).name=o),label:"이름",variant:"outlined",density:"comfortable","error-messages":a(u).name,class:"mb-3"},null,8,["modelValue","error-messages"]),l(d,{modelValue:a(n).workplace,"onUpdate:modelValue":e[6]||(e[6]=o=>a(n).workplace=o),items:a(ue),label:"근무지",variant:"outlined",density:"comfortable","error-messages":a(u).workplace,class:"mb-3"},null,8,["modelValue","items","error-messages"]),s("div",st,[e[20]||(e[20]=s("strong",null,"자동 배정 센터:",-1)),h(" "+D(a(me)),1)])]),s("div",nt,[l(q),l(i,{variant:"text",onClick:se},{default:v(()=>[...e[21]||(e[21]=[h(" 취소 ",-1)])]),_:1}),l(i,{color:"primary",variant:"flat",loading:a(Q),disabled:!a(ve),onClick:he},{default:v(()=>[h(D(a(V)?"수정":"등록"),1)]),_:1},8,["loading","disabled"])])]),_:1})]),_:1},8,["modelValue"]),l(G,{modelValue:a(A),"onUpdate:modelValue":e[8]||(e[8]=o=>I(A)?A.value=o:null),location:"right",temporary:"",width:a(ee),class:"side-navigation"},{default:v(()=>[s("div",lt,[l(z)])]),_:1},8,["modelValue","width"])]),_:1})}}},_t=De(rt,[["__scopeId","data-v-ec096e6c"]]);export{_t as default};
