const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ycURoG9Y.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as we,N as ge,a as De,D as be,r as b,k as ke,o as se,e as Ae,X as xe,_ as R,O as S,L as A,g as q,H as g,K as k,P as i,I as u,M as I,G as x,Q as oe,S as $,J as F,V as ae,W as ne}from"./ycURoG9Y.js";import{u as Be,_ as Ee}from"./Br6c7W23.js";import{_ as Re}from"./BZ9Li7wo.js";import{g as qe,C as Ie,_ as Le}from"./DYcgDTZD.js";import{_ as Ve}from"./CZWaGlT2.js";import{u as Ce}from"./D7she8QH.js";import{u as Te}from"./CRZ2QJAh.js";import"./XIEB4zfM.js";const He={class:"mypage"},Se={class:"page-header mb-6"},Pe={class:"page-header-inner"},Ne={class:"rental-section mb-8"},Oe={class:"section-header-with-filter mb-4"},$e={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},Fe={class:"text-body-1"},We={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},ze={key:0,class:"text-center py-8"},Me={key:1,class:"rental-books-grid"},je={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},Ue={class:"requested-section mb-8"},Qe={class:"history-section"},Xe={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},Ge={class:"text-body-1"},Je={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},Ke={key:0,class:"text-center py-8"},Ye={key:1,class:"history-books-grid"},Ze={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},et={class:"drawer-content"},tt={__name:"index",setup(st){const{user:f}=Ce();Be();const{confirm:W,alert:L}=ge(),{$firebaseFirestore:re}=De(),h=re,C=be("navigationDrawer",()=>!1),Y=b(280),Z=[...Ie],E=b(""),P=b([]),z=b(!1),M=b([]),j=b(!1),N=ke(()=>E.value?P.value.filter(e=>e.center===E.value):P.value),V=b([]),U=b(!1),w=b([]),D=b([]),Q=b(!1),T=b(!1);se(()=>{const e=()=>{Y.value=window.innerWidth>=769?360:280};e(),window.addEventListener("resize",e),Ae(()=>{window.removeEventListener("resize",e)})}),xe(E,()=>{w.value=[]});const ie=async()=>{if(!f.value||!h)return"";try{const{doc:e,getDoc:t}=await R(async()=>{const{doc:p,getDoc:_}=await import("./ycURoG9Y.js").then(y=>y.aE);return{doc:p,getDoc:_}},__vite__mapDeps([0,1]),import.meta.url),a=e(h,"users",f.value.uid),c=await t(a);if(c.exists())return c.data().workplace||""}catch(e){console.error("사용자 근무지 정보 가져오기 오류:",e)}return""};se(async()=>{const e=await ie();E.value=e?qe(e):Z[0],await Promise.all([X(),le(),O()])});const le=async()=>{if(!(!f.value||!h))try{j.value=!0;const{collection:e,query:t,where:a,getDocs:c,orderBy:p}=await R(async()=>{const{collection:o,query:s,where:r,getDocs:m,orderBy:n}=await import("./ycURoG9Y.js").then(v=>v.aE);return{collection:o,query:s,where:r,getDocs:m,orderBy:n}},__vite__mapDeps([0,1]),import.meta.url),_=e(h,"bookRequests"),y=t(_,a("requestedBy","==",f.value.uid),a("status","==","pending")),d=await c(y),l=[];d.forEach(o=>{l.push({id:o.id,...o.data()})}),l.sort((o,s)=>{const r=o.requestedAt?.toDate?.()||new Date(0);return(s.requestedAt?.toDate?.()||new Date(0))-r}),M.value=l}catch(e){console.error("신청 도서 로드 오류:",e),M.value=[]}finally{j.value=!1}},X=async()=>{if(!(!f.value||!h))try{z.value=!0;const{collection:e,query:t,where:a,getDocs:c}=await R(async()=>{const{collection:l,query:o,where:s,getDocs:r}=await import("./ycURoG9Y.js").then(m=>m.aE);return{collection:l,query:o,where:s,getDocs:r}},__vite__mapDeps([0,1]),import.meta.url),p=e(h,"books"),_=t(p,a("rentedBy","==",f.value.uid)),y=await c(_),d=[];y.forEach(l=>{const o=l.data();o.rentedAt&&d.push({id:l.id,...o})}),d.sort((l,o)=>{const s=l.rentedAt?.toDate?.()||new Date(0);return(o.rentedAt?.toDate?.()||new Date(0))-s}),P.value=d}catch(e){console.error("대여 도서 로드 오류:",e),P.value=[]}finally{z.value=!1}},O=async()=>{if(!(!f.value||!h))try{U.value=!0;const{collection:e,query:t,where:a,getDocs:c}=await R(async()=>{const{collection:o,query:s,where:r,getDocs:m}=await import("./ycURoG9Y.js").then(n=>n.aE);return{collection:o,query:s,where:r,getDocs:m}},__vite__mapDeps([0,1]),import.meta.url),p=e(h,"rentalHistory"),_=t(p,a("userId","==",f.value.uid)),y=await c(_),d=new Map;y.forEach(o=>{const s=o.data(),r=s.bookId;if(!d.has(r))d.set(r,{id:o.id,...s});else{const n=d.get(r).returnedAt?.toDate?.()||new Date(0);(s.returnedAt?.toDate?.()||new Date(0))>n&&d.set(r,{id:o.id,...s})}});const l=Array.from(d.values());l.sort((o,s)=>{const r=o.returnedAt?.toDate?.()||new Date(0);return(s.returnedAt?.toDate?.()||new Date(0))-r}),V.value=l}catch(e){console.error("대여 이력 로드 오류:",e),V.value=[]}finally{U.value=!1}},ce=e=>{if(!e.rentedAt)return null;const t=e.rentedAt?.toDate?.()||new Date(e.rentedAt),a=new Date(t);return a.setDate(a.getDate()+7),a},ee=e=>w.value.some(t=>t.id===e.id),de=(e,t)=>{t?ee(e)||w.value.push(e):w.value=w.value.filter(a=>a.id!==e.id)},te=e=>D.value.some(t=>t.id===e.id),ue=(e,t)=>{t?te(e)||D.value.push(e):D.value=D.value.filter(a=>a.id!==e.id)},me=async()=>{if(D.value.length===0||!f.value)return;const e=D.value.map(t=>t.title).join(", ");if(await W(`다음 도서들을 읽은 책 목록에서 삭제하시겠습니까?

${e}`))try{Q.value=!0;const{doc:t,deleteDoc:a}=await R(async()=>{const{doc:c,deleteDoc:p}=await import("./ycURoG9Y.js").then(_=>_.aE);return{doc:c,deleteDoc:p}},__vite__mapDeps([0,1]),import.meta.url);for(const c of D.value)await a(t(h,"rentalHistory",c.id));await O(),await L(`${D.value.length}권이 읽은 책 목록에서 삭제되었습니다.`,{type:"success"}),D.value=[]}catch(t){console.error("이력 삭제 오류:",t),await L("삭제에 실패했습니다.",{type:"error"})}finally{Q.value=!1}},ve=async()=>{if(w.value.length===0||!f.value)return;const e=w.value.map(t=>t.title).join(", ");if(await W(`다음 도서들을 반납하시겠습니까?

${e}`))try{T.value=!0;const{doc:t,updateDoc:a,collection:c,addDoc:p,query:_,where:y,getDocs:d,serverTimestamp:l,deleteField:o}=await R(async()=>{const{doc:s,updateDoc:r,collection:m,addDoc:n,query:v,where:B,getDocs:H,serverTimestamp:G,deleteField:J}=await import("./ycURoG9Y.js").then(K=>K.aE);return{doc:s,updateDoc:r,collection:m,addDoc:n,query:v,where:B,getDocs:H,serverTimestamp:G,deleteField:J}},__vite__mapDeps([0,1]),import.meta.url);for(const s of w.value){const r=t(h,"books",s.id);await a(r,{status:"available",rentedBy:o(),rentedAt:o()});const m=c(h,"rentalHistory"),n=_(m,y("userId","==",f.value.uid),y("bookId","==",s.id)),v=await d(n);if(v.empty)await p(m,{bookId:s.id,isbn13:s.isbn13||"",isbn:s.isbn||"",title:s.title||"",author:s.author||"",publisher:s.publisher||"",cover:s.cover||s.image||"",center:s.center||"",userId:f.value.uid,rentedAt:s.rentedAt,returnedAt:l(),rentCount:1});else{const B=v.docs[0],H=B.data();await a(t(h,"rentalHistory",B.id),{rentedAt:s.rentedAt,returnedAt:l(),rentCount:(H.rentCount||1)+1})}}await Promise.all([X(),O()]),await L(`${w.value.length}권의 도서가 반납되었습니다.`,{type:"success"}),w.value=[]}catch(t){console.error("반납 처리 오류:",t),await L("반납 처리에 실패했습니다.",{type:"error"})}finally{T.value=!1}},pe=async e=>{if(!(!f.value||!e)&&await W(`"${e.title}"을(를) 반납하시겠습니까?`))try{T.value=!0;const{doc:t,updateDoc:a,collection:c,addDoc:p,query:_,where:y,getDocs:d,serverTimestamp:l,deleteField:o}=await R(async()=>{const{doc:v,updateDoc:B,collection:H,addDoc:G,query:J,where:K,getDocs:_e,serverTimestamp:ye,deleteField:fe}=await import("./ycURoG9Y.js").then(he=>he.aE);return{doc:v,updateDoc:B,collection:H,addDoc:G,query:J,where:K,getDocs:_e,serverTimestamp:ye,deleteField:fe}},__vite__mapDeps([0,1]),import.meta.url),s=t(h,"books",e.id);await a(s,{status:"available",rentedBy:o(),rentedAt:o()});const r=c(h,"rentalHistory"),m=_(r,y("userId","==",f.value.uid),y("bookId","==",e.id)),n=await d(m);if(n.empty)await p(r,{bookId:e.id,isbn13:e.isbn13||"",isbn:e.isbn||"",title:e.title||"",author:e.author||"",publisher:e.publisher||"",cover:e.cover||e.image||"",center:e.center||"",userId:f.value.uid,rentedAt:e.rentedAt,returnedAt:l(),rentCount:1});else{const v=n.docs[0],B=v.data();await a(t(h,"rentalHistory",v.id),{rentedAt:e.rentedAt,returnedAt:l(),rentCount:(B.rentCount||1)+1})}await Promise.all([X(),O()]),w.value=w.value.filter(v=>v.id!==e.id),await L("도서가 반납되었습니다.",{type:"success"})}catch(t){console.error("반납 처리 오류:",t),await L("반납 처리에 실패했습니다.",{type:"error"})}finally{T.value=!1}};return Te({title:"마이페이지 - CNX Library",meta:[{name:"description",content:"내 대여 목록 및 읽은 책 이력"}]}),(e,t)=>{const a=q("v-btn"),c=q("v-select"),p=q("v-progress-circular"),_=Ee,y=q("v-col"),d=q("v-row"),l=Re,o=Le,s=Ve,r=q("v-navigation-drawer"),m=q("v-app");return g(),S(m,null,{default:A(()=>[k(o,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:t[1]||(t[1]=n=>C.value=!i(C))},{default:A(()=>[u("div",He,[u("div",Se,[u("div",Pe,[t[4]||(t[4]=u("h1",{class:"page-title mb-0"}," 마이페이지 ",-1)),k(a,{class:"edit-profile-btn",variant:"flat",size:"small",to:"/mypage/edit"},{default:A(()=>[...t[3]||(t[3]=[I(" 정보수정 ",-1)])]),_:1})])]),u("div",Ne,[u("div",Oe,[t[5]||(t[5]=u("h2",{class:"section-title"}," 내 대여 목록 ",-1)),k(c,{modelValue:i(E),"onUpdate:modelValue":t[0]||(t[0]=n=>oe(E)?E.value=n:null),items:Z,variant:"outlined",density:"comfortable","hide-details":"",class:"center-filter-select"},null,8,["modelValue"])]),u("div",$e,[u("div",Fe,[t[6]||(t[6]=I(" 총 ",-1)),u("strong",null,F(i(N).length),1),t[7]||(t[7]=I("권 대여중 ",-1)),i(w).length>0?(g(),x("span",We," ("+F(i(w).length)+"권 선택됨) ",1)):$("",!0)]),i(N).length>0?(g(),S(a,{key:0,class:"return-btn",variant:"flat",size:"small",disabled:i(w).length===0,loading:i(T),onClick:ve},{default:A(()=>[...t[8]||(t[8]=[I(" 반납하기 ",-1)])]),_:1},8,["disabled","loading"])):$("",!0)]),i(z)?(g(),x("div",ze,[k(p,{indeterminate:"",color:"primary"})])):i(N).length>0?(g(),x("div",Me,[k(d,{class:"book-list-row"},{default:A(()=>[(g(!0),x(ae,null,ne(i(N),(n,v)=>(g(),S(y,{key:`rented-${v}`,cols:"12",sm:"6",class:"book-list-col"},{default:A(()=>[k(_,{book:n,center:n.center||"","show-action":!1,selectable:!0,selected:ee(n),"show-status-flags":!1,"show-return-date":!0,"return-date":ce(n),onSelect:de,onReturn:pe},null,8,["book","center","selected","return-date"])]),_:2},1024))),128))]),_:1})])):(g(),x("div",je," 현재 대여중인 도서가 없습니다. "))]),u("div",Ue,[k(l,{books:i(M),center:"","registered-books":[],loading:i(j),title:"내가 신청한 책","empty-message":"신청한 도서가 없습니다.","nav-id":"my-requested","show-action":!1,"show-status-flags":!1},null,8,["books","loading"])]),u("div",Qe,[t[12]||(t[12]=u("div",{class:"section-header mb-4"},[u("h2",{class:"section-title"}," 읽은 책 목록 ")],-1)),u("div",Xe,[u("div",Ge,[t[9]||(t[9]=I(" 총 ",-1)),u("strong",null,F(i(V).length),1),t[10]||(t[10]=I("권 ",-1)),i(D).length>0?(g(),x("span",Je," ("+F(i(D).length)+"권 선택됨) ",1)):$("",!0)]),i(V).length>0?(g(),S(a,{key:0,class:"delete-history-btn",variant:"flat",size:"small",disabled:i(D).length===0,loading:i(Q),onClick:me},{default:A(()=>[...t[11]||(t[11]=[I(" 삭제하기 ",-1)])]),_:1},8,["disabled","loading"])):$("",!0)]),i(U)?(g(),x("div",Ke,[k(p,{indeterminate:"",color:"primary"})])):i(V).length>0?(g(),x("div",Ye,[k(d,{class:"book-list-row"},{default:A(()=>[(g(!0),x(ae,null,ne(i(V),(n,v)=>(g(),S(y,{key:`history-${n.id}`,cols:"12",sm:"6",class:"book-list-col"},{default:A(()=>[k(_,{book:n,center:n.center||"","show-action":!1,selectable:!0,selected:te(n),"show-status-flags":!1,onSelect:ue},null,8,["book","center","selected"])]),_:2},1024))),128))]),_:1})])):(g(),x("div",Ze," 아직 읽은 책이 없습니다. "))])])]),_:1}),k(r,{modelValue:i(C),"onUpdate:modelValue":t[2]||(t[2]=n=>oe(C)?C.value=n:null),location:"right",temporary:"",width:i(Y),class:"side-navigation"},{default:A(()=>[u("div",et,[k(s)])]),_:1},8,["modelValue","width"])]),_:1})}}},ut=we(tt,[["__scopeId","data-v-7a099970"]]);export{ut as default};
