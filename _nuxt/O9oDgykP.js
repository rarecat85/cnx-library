const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DZQbVoBJ.js","./entry.DNw42TVG.css"])))=>i.map(i=>d[i]);
import{F as xe,N as Be,a as Ae,D as Re,r as w,k as qe,o as ie,e as Ee,Y as Ce,_ as T,O as P,L as _,g as A,H as c,K as u,P as n,I as a,Q as Z,J as R,G as p,W,X as U,T as O,M as h}from"./DZQbVoBJ.js";import{_ as Le}from"./yEubE9j_.js";import{g as Ve,C as Ne,_ as Se}from"./BTy2CSBL.js";import{_ as Ie}from"./CjBnhG7u.js";import{u as $e,f as He}from"./Btpk0bE3.js";import{u as Te}from"./D528XDxk.js";import{u as Pe}from"./1CNRncdf.js";import"./B7fncOYr.js";const ze={class:"mypage"},Oe={class:"return-dialog-content"},Me={class:"mb-4 text-body-2 text-medium-emphasis"},Fe={class:"return-book-list"},We={class:"return-book-info"},Ue=["src","alt"],je={key:1,class:"return-book-thumbnail no-image-placeholder"},Ge={class:"return-book-meta"},Qe={class:"return-book-title"},Xe={key:0,class:"return-book-author"},Ye={class:"return-book-details"},Je={class:"detail-item"},Ke={class:"detail-item"},Ze={class:"return-dialog-actions"},et={class:"page-header mb-6"},tt={class:"page-header-inner"},st={class:"rental-section mb-8"},ot={class:"section-header-with-filter mb-4"},at={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},nt={class:"text-body-1"},rt={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},lt={key:0,class:"text-center py-8"},it={key:1,class:"rental-books-grid"},ct={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},dt={class:"requested-section mb-8"},ut={key:0,class:"text-center py-8"},mt={key:1,class:"requested-books-grid"},vt={class:"requested-book-item"},_t={class:"requested-book-actions"},pt={class:"requested-info"},ft={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},yt={class:"history-section"},ht={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},gt={class:"text-body-1"},wt={key:0,class:"text-body-2 ml-2 text-medium-emphasis"},bt={key:0,class:"text-center py-8"},Dt={key:1,class:"history-books-grid"},kt={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},xt={class:"drawer-content"},Bt={__name:"index",setup(At){const{user:g}=Te(),{cancelRentRequest:ce}=$e(),{confirm:ee,alert:V}=Be(),{$firebaseFirestore:de}=Ae(),D=de,z=Re("navigationDrawer",()=>!1),te=w(280),N=w(!1),q=w([]),j=w(!1),se=[...Ne],L=w(""),M=w([]),G=w(!1),S=w([]),Q=w(!1),X=w(null),F=qe(()=>L.value?M.value.filter(t=>t.center===L.value):M.value),I=w([]),Y=w(!1),k=w([]),x=w([]),J=w(!1),ue=w(!1);ie(()=>{const t=()=>{te.value=window.innerWidth>=769?360:280};t(),window.addEventListener("resize",t),Ee(()=>{window.removeEventListener("resize",t)})}),Ce(L,()=>{k.value=[]});const me=async()=>{if(!g.value||!D)return"";try{const{doc:t,getDoc:e}=await T(async()=>{const{doc:m,getDoc:b}=await import("./DZQbVoBJ.js").then(B=>B.aE);return{doc:m,getDoc:b}},__vite__mapDeps([0,1]),import.meta.url),r=t(D,"users",g.value.uid),f=await e(r);if(f.exists())return f.data().workplace||""}catch(t){console.error("사용자 근무지 정보 가져오기 오류:",t)}return""};ie(async()=>{const t=await me();L.value=t?Ve(t):se[0],await Promise.all([oe(),ve(),K()])});const ve=async()=>{if(!(!g.value||!D))try{Q.value=!0;const{collection:t,query:e,where:r,getDocs:f}=await T(async()=>{const{collection:d,query:l,where:o,getDocs:i}=await import("./DZQbVoBJ.js").then(y=>y.aE);return{collection:d,query:l,where:o,getDocs:i}},__vite__mapDeps([0,1]),import.meta.url),m=t(D,"books"),b=e(m,r("requestedBy","==",g.value.uid),r("status","==","requested")),B=await f(b),v=[];B.forEach(d=>{v.push({id:d.id,...d.data()})}),v.sort((d,l)=>{const o=d.requestedAt?.toDate?.()||new Date(0);return(l.requestedAt?.toDate?.()||new Date(0))-o}),S.value=v}catch(t){console.error("신청 도서 로드 오류:",t),S.value=[]}finally{Q.value=!1}},oe=async()=>{if(!(!g.value||!D))try{G.value=!0;const{collection:t,query:e,where:r,getDocs:f}=await T(async()=>{const{collection:d,query:l,where:o,getDocs:i}=await import("./DZQbVoBJ.js").then(y=>y.aE);return{collection:d,query:l,where:o,getDocs:i}},__vite__mapDeps([0,1]),import.meta.url),m=t(D,"books"),b=e(m,r("rentedBy","==",g.value.uid)),B=await f(b),v=[];B.forEach(d=>{const l=d.data();l.rentedAt&&v.push({id:d.id,...l})}),v.sort((d,l)=>{const o=d.rentedAt?.toDate?.()||new Date(0);return(l.rentedAt?.toDate?.()||new Date(0))-o}),M.value=v}catch(t){console.error("대여 도서 로드 오류:",t),M.value=[]}finally{G.value=!1}},K=async()=>{if(!(!g.value||!D))try{Y.value=!0;const{collection:t,query:e,where:r,getDocs:f}=await T(async()=>{const{collection:l,query:o,where:i,getDocs:y}=await import("./DZQbVoBJ.js").then(E=>E.aE);return{collection:l,query:o,where:i,getDocs:y}},__vite__mapDeps([0,1]),import.meta.url),m=t(D,"rentalHistory"),b=e(m,r("userId","==",g.value.uid)),B=await f(b),v=new Map;B.forEach(l=>{const o=l.data(),i=o.isbn13||o.isbn||"";if(!i){const y=o.bookId;v.has(y)||v.set(y,{id:l.id,...o});return}if(!v.has(i))v.set(i,{id:l.id,...o});else{const E=v.get(i).returnedAt?.toDate?.()||new Date(0);(o.returnedAt?.toDate?.()||new Date(0))>E&&v.set(i,{id:l.id,...o})}});const d=Array.from(v.values());d.sort((l,o)=>{const i=l.returnedAt?.toDate?.()||new Date(0);return(o.returnedAt?.toDate?.()||new Date(0))-i}),I.value=d}catch(t){console.error("대여 이력 로드 오류:",t),I.value=[]}finally{Y.value=!1}},_e=t=>{if(!t)return"";const e=t?.toDate?.()||new Date(t),r=e.getFullYear(),f=String(e.getMonth()+1).padStart(2,"0"),m=String(e.getDate()).padStart(2,"0");return`${r}.${f}.${m} 신청`},pe=t=>{if(!t.rentedAt)return null;const e=t.rentedAt?.toDate?.()||new Date(t.rentedAt),r=new Date(e);return r.setDate(r.getDate()+7),r},ae=t=>k.value.some(e=>e.id===t.id),fe=(t,e)=>{e?ae(t)||k.value.push(t):k.value=k.value.filter(r=>r.id!==t.id)},ne=t=>x.value.some(e=>e.id===t.id),ye=(t,e)=>{e?ne(t)||x.value.push(t):x.value=x.value.filter(r=>r.id!==t.id)},he=async t=>{if(!(!g.value||!t)&&await ee(`"${t.title}" 대여 신청을 취소하시겠습니까?`))try{X.value=t.id;const e=t.labelNumber||t.id.split("_")[0];await ce(e,t.center,g.value.uid),S.value=S.value.filter(r=>r.id!==t.id),await V("대여 신청이 취소되었습니다.",{type:"success"})}catch(e){console.error("신청 취소 오류:",e),await V(e.message||"신청 취소에 실패했습니다.",{type:"error"})}finally{X.value=null}},ge=async()=>{if(x.value.length===0||!g.value)return;const t=x.value.map(e=>e.title).join(", ");if(await ee(`다음 도서들을 읽은 책 목록에서 삭제하시겠습니까?

${t}`))try{J.value=!0;const{doc:e,deleteDoc:r}=await T(async()=>{const{doc:f,deleteDoc:m}=await import("./DZQbVoBJ.js").then(b=>b.aE);return{doc:f,deleteDoc:m}},__vite__mapDeps([0,1]),import.meta.url);for(const f of x.value)await r(e(D,"rentalHistory",f.id));await K(),await V(`${x.value.length}권이 읽은 책 목록에서 삭제되었습니다.`,{type:"success"}),x.value=[]}catch(e){console.error("이력 삭제 오류:",e),await V("삭제에 실패했습니다.",{type:"error"})}finally{J.value=!1}},we=()=>{k.value.length===0||!g.value||(q.value=[...k.value],N.value=!0)},re=()=>{N.value=!1,q.value=[]},be=async()=>{if(!(q.value.length===0||!g.value))try{j.value=!0;const{doc:t,updateDoc:e,collection:r,addDoc:f,query:m,where:b,getDocs:B,serverTimestamp:v,deleteField:d}=await T(async()=>{const{doc:o,updateDoc:i,collection:y,addDoc:E,query:$,where:H,getDocs:s,serverTimestamp:C,deleteField:le}=await import("./DZQbVoBJ.js").then(ke=>ke.aE);return{doc:o,updateDoc:i,collection:y,addDoc:E,query:$,where:H,getDocs:s,serverTimestamp:C,deleteField:le}},__vite__mapDeps([0,1]),import.meta.url);for(const o of q.value){const i=t(D,"books",o.id);await e(i,{status:"available",rentedBy:d(),rentedAt:d(),expectedReturnDate:d()});const y=r(D,"rentalHistory"),E=o.isbn13||o.isbn||"",$=m(y,b("userId","==",g.value.uid),b("isbn13","==",E)),H=await B($);if(H.empty)await f(y,{bookId:o.id,labelNumber:o.labelNumber||"",isbn13:o.isbn13||"",isbn:o.isbn||"",title:o.title||"",author:o.author||"",publisher:o.publisher||"",cover:o.cover||o.image||"",center:o.center||"",userId:g.value.uid,rentedAt:o.rentedAt,returnedAt:v(),rentCount:1});else{const s=H.docs[0],C=s.data();await e(t(D,"rentalHistory",s.id),{rentedAt:o.rentedAt,returnedAt:v(),rentCount:(C.rentCount||1)+1})}}await Promise.all([oe(),K()]);const l=q.value.length;k.value=k.value.filter(o=>!q.value.some(i=>i.id===o.id)),re(),await V(`${l}권의 도서가 반납되었습니다.`,{type:"success"})}catch(t){console.error("반납 처리 오류:",t),await V("반납 처리에 실패했습니다.",{type:"error"})}finally{j.value=!1}},De=t=>{!g.value||!t||(q.value=[t],N.value=!0)};return Pe({title:"마이페이지 - CNX Library",meta:[{name:"description",content:"내 대여 목록 및 읽은 책 이력"}]}),(t,e)=>{const r=A("v-icon"),f=A("v-spacer"),m=A("v-btn"),b=A("v-card"),B=A("v-dialog"),v=A("v-select"),d=A("v-progress-circular"),l=Le,o=A("v-col"),i=A("v-row"),y=Se,E=Ie,$=A("v-navigation-drawer"),H=A("v-app");return c(),P(H,null,{default:_(()=>[u(y,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:e[2]||(e[2]=s=>z.value=!n(z))},{default:_(()=>[a("div",ze,[u(B,{modelValue:n(N),"onUpdate:modelValue":e[0]||(e[0]=s=>Z(N)?N.value=s:null),"max-width":"450",persistent:""},{default:_(()=>[u(b,{class:"return-dialog-card"},{default:_(()=>[e[9]||(e[9]=a("div",{class:"return-dialog-title text-h6"}," 반납 확인 ",-1)),a("div",Oe,[a("div",Me," 반납 처리할 도서: "+R(n(q).length)+"권 ",1),a("div",Fe,[(c(!0),p(W,null,U(n(q),s=>(c(),p("div",{key:s.id,class:"return-book-item"},[a("div",We,[s.cover||s.image?(c(),p("img",{key:0,src:s.cover||s.image,alt:s.title,class:"return-book-thumbnail"},null,8,Ue)):(c(),p("div",je," NO IMAGE ")),a("div",Ge,[a("div",Qe,R(s.title),1),s.author?(c(),p("div",Xe,[e[4]||(e[4]=a("strong",null,"저자:",-1)),h(" "+R(s.author),1)])):O("",!0),a("div",Ye,[a("span",Je,[u(r,{size:"x-small",class:"mr-1"},{default:_(()=>[...e[5]||(e[5]=[h("mdi-label",-1)])]),_:1}),h(" "+R(s.labelNumber||"라벨없음"),1)]),a("span",Ke,[u(r,{size:"x-small",class:"mr-1"},{default:_(()=>[...e[6]||(e[6]=[h("mdi-map-marker",-1)])]),_:1}),h(" "+R(n(He)(s.location)||"위치없음"),1)])])])])]))),128))])]),a("div",Ze,[u(f),u(m,{variant:"text",onClick:re},{default:_(()=>[...e[7]||(e[7]=[h(" 취소 ",-1)])]),_:1}),u(m,{color:"primary",variant:"flat",loading:n(j),onClick:be},{default:_(()=>[...e[8]||(e[8]=[h(" 반납하기 ",-1)])]),_:1},8,["loading"])])]),_:1})]),_:1},8,["modelValue"]),a("div",et,[a("div",tt,[e[11]||(e[11]=a("h1",{class:"page-title mb-0"}," 마이페이지 ",-1)),u(m,{class:"edit-profile-btn",variant:"flat",size:"small",to:"/mypage/edit"},{default:_(()=>[...e[10]||(e[10]=[h(" 정보수정 ",-1)])]),_:1})])]),a("div",st,[a("div",ot,[e[12]||(e[12]=a("h2",{class:"section-title"}," 내 대여 목록 ",-1)),u(v,{modelValue:n(L),"onUpdate:modelValue":e[1]||(e[1]=s=>Z(L)?L.value=s:null),items:se,variant:"outlined",density:"comfortable","hide-details":"",class:"center-filter-select"},null,8,["modelValue"])]),a("div",at,[a("div",nt,[e[13]||(e[13]=h(" 총 ",-1)),a("strong",null,R(n(F).length),1),e[14]||(e[14]=h("권 대여중 ",-1)),n(k).length>0?(c(),p("span",rt," ("+R(n(k).length)+"권 선택됨) ",1)):O("",!0)]),n(F).length>0?(c(),P(m,{key:0,class:"return-btn",variant:"flat",size:"small",disabled:n(k).length===0,loading:n(ue),onClick:we},{default:_(()=>[...e[15]||(e[15]=[h(" 반납하기 ",-1)])]),_:1},8,["disabled","loading"])):O("",!0)]),n(G)?(c(),p("div",lt,[u(d,{indeterminate:"",color:"primary"})])):n(F).length>0?(c(),p("div",it,[u(i,{class:"book-list-row"},{default:_(()=>[(c(!0),p(W,null,U(n(F),(s,C)=>(c(),P(o,{key:`rented-${C}`,cols:"12",sm:"6",class:"book-list-col"},{default:_(()=>[u(l,{book:s,center:s.center||"","show-action":!1,selectable:!0,selected:ae(s),"show-status-flags":!1,"show-return-date":!0,"return-date":pe(s),"show-label-number":!0,"label-number":s.labelNumber,"show-location":!0,location:s.location,onSelect:fe,onReturn:De},null,8,["book","center","selected","return-date","label-number","location"])]),_:2},1024))),128))]),_:1})])):(c(),p("div",ct," 현재 대여중인 도서가 없습니다. "))]),a("div",dt,[e[18]||(e[18]=a("div",{class:"section-header mb-4"},[a("h2",{class:"section-title"}," 내가 신청한 책 ")],-1)),n(Q)?(c(),p("div",ut,[u(d,{indeterminate:"",color:"primary"})])):n(S).length>0?(c(),p("div",mt,[u(i,{class:"book-list-row"},{default:_(()=>[(c(!0),p(W,null,U(n(S),(s,C)=>(c(),P(o,{key:`requested-${C}`,cols:"12",sm:"6",class:"book-list-col"},{default:_(()=>[a("div",vt,[u(l,{book:s,center:s.center||"","show-action":!1,selectable:!1,"show-status-flags":!1,"show-label-number":!!s.labelNumber,"label-number":s.labelNumber,"show-location":!!s.location,location:s.location},null,8,["book","center","show-label-number","label-number","show-location","location"]),a("div",_t,[a("div",pt,[u(r,{size:"small",class:"mr-1"},{default:_(()=>[...e[16]||(e[16]=[h(" mdi-clock-outline ",-1)])]),_:1}),h(" "+R(_e(s.requestedAt)),1)]),u(m,{color:"error",variant:"outlined",size:"small",loading:n(X)===s.id,onClick:le=>he(s)},{default:_(()=>[...e[17]||(e[17]=[h(" 신청 취소 ",-1)])]),_:1},8,["loading","onClick"])])])]),_:2},1024))),128))]),_:1})])):(c(),p("div",ft," 신청한 도서가 없습니다. "))]),a("div",yt,[e[22]||(e[22]=a("div",{class:"section-header mb-4"},[a("h2",{class:"section-title"}," 읽은 책 목록 ")],-1)),a("div",ht,[a("div",gt,[e[19]||(e[19]=h(" 총 ",-1)),a("strong",null,R(n(I).length),1),e[20]||(e[20]=h("권 ",-1)),n(x).length>0?(c(),p("span",wt," ("+R(n(x).length)+"권 선택됨) ",1)):O("",!0)]),n(I).length>0?(c(),P(m,{key:0,class:"delete-history-btn",variant:"flat",size:"small",disabled:n(x).length===0,loading:n(J),onClick:ge},{default:_(()=>[...e[21]||(e[21]=[h(" 삭제하기 ",-1)])]),_:1},8,["disabled","loading"])):O("",!0)]),n(Y)?(c(),p("div",bt,[u(d,{indeterminate:"",color:"primary"})])):n(I).length>0?(c(),p("div",Dt,[u(i,{class:"book-list-row"},{default:_(()=>[(c(!0),p(W,null,U(n(I),(s,C)=>(c(),P(o,{key:`history-${s.id}`,cols:"12",sm:"6",class:"book-list-col"},{default:_(()=>[u(l,{book:s,center:s.center||"","show-action":!1,selectable:!0,selected:ne(s),"show-status-flags":!1,onSelect:ye},null,8,["book","center","selected"])]),_:2},1024))),128))]),_:1})])):(c(),p("div",kt," 아직 읽은 책이 없습니다. "))])])]),_:1}),u($,{modelValue:n(z),"onUpdate:modelValue":e[3]||(e[3]=s=>Z(z)?z.value=s:null),location:"right",temporary:"",width:n(te),class:"side-navigation"},{default:_(()=>[a("div",xt,[u(E)])]),_:1},8,["modelValue","width"])]),_:1})}}},It=xe(Bt,[["__scopeId","data-v-ea9f28c0"]]);export{It as default};
