const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Dw84HrPm.js","./entry.yfGVSS21.css"])))=>i.map(i=>d[i]);
import{F as ge,N as ye,r as d,a as he,u as ke,o as Ce,O as X,L as n,_ as ae,g as w,H as k,K as o,P as a,I as t,J as f,Q as O,M as v,G as T,R as De,S as Ne,T as Re,U as G}from"./Dw84HrPm.js";import{_ as Be}from"./CLxtAmYj.js";import{g as xe,C as Ve,_ as Le,c as J}from"./BmY9MuGI.js";import{u as Se,_ as Ae}from"./Co5Ttkt1.js";import{u as Ee}from"./DjMHYbGS.js";import{u as Te}from"./2Ftor6gv.js";import{u as Ie}from"./DaFGRQh7.js";import"./Br9hWO33.js";import"./Bmka-bGZ.js";import"./Doj8Tdqm.js";import"./C-xtXPWq.js";const Pe={class:"home-page"},Ue={class:"my-rental-status-section"},$e={class:"rental-status-header mb-6"},ze={class:"page-title mb-0"},Me={class:"rental-dashboard"},Oe={class:"dashboard-number"},Fe={class:"dashboard-number"},He={class:"dashboard-number"},qe={class:"center-header mb-6"},Qe={class:"center-header-inner"},We={class:"page-title mb-0"},Xe={class:"new-books-section"},Ge={class:"more-books-btn-wrapper"},Je={class:"mb-4 text-body-2"},Ke={class:"label-list"},je=["onClick"],Ye={class:"label-info"},Ze={class:"label-number"},et={class:"label-location"},tt={key:0,class:"rent-book-card"},at={class:"rent-book-cover"},st=["src","alt"],ot={class:"rent-book-info"},nt={class:"rent-book-title"},lt={class:"rent-book-author"},rt={class:"rent-book-details"},it={class:"detail-item"},ut={class:"detail-item"},ct={key:1,class:"rent-notice mt-4"},dt={class:"drawer-content"},se=5,vt={__name:"index",setup(mt){const{user:g}=Ee(),{getBooksByCenter:oe,rentBook:ne,requestRent:le,calculateBookStatus:I,checkAlreadyRentedSameIsbn:re}=Te(),{alert:B}=ye(),x=d(!1),y=d(null),b=d(""),C=d(""),c=d(null),D=d(!1),{$firebaseFirestore:ie}=he(),L=ie,F=d(!1),{drawer:S,drawerWidth:ue}=Se(),K=[...Ve],_=d(""),P=d(""),A=d([]),H=d(!1),j=d(""),q=d(0),Y=d(0),Z=d(0),ce=ke(),Q=()=>{ce.push("/mypage")},de=async()=>{if(!g.value||!L)return{workplace:"",name:""};try{const{doc:s,getDoc:e}=await ae(async()=>{const{doc:r,getDoc:m}=await import("./Dw84HrPm.js").then(V=>V.b2);return{doc:r,getDoc:m}},__vite__mapDeps([0,1]),import.meta.url),u=s(L,"users",g.value.uid),l=await e(u);if(l.exists()){const r=l.data();return{workplace:r.workplace||"",name:r.name||""}}}catch(s){console.error("사용자 정보 가져오기 오류:",s)}return{workplace:"",name:""}},ee=async()=>{if(!(!g.value||!L))try{const{collection:s,query:e,where:u,getDocs:l}=await ae(async()=>{const{collection:p,query:E,where:R,getDocs:W}=await import("./Dw84HrPm.js").then(i=>i.b2);return{collection:p,query:E,where:R,getDocs:W}},__vite__mapDeps([0,1]),import.meta.url),r=s(L,"books"),m=e(r,u("rentedBy","==",g.value.uid)),h=(await l(m)).docs.map(p=>p.data()).filter(p=>p.status==="rented"||p.status==="overdue");q.value=h.length;const N=new Date;N.setDate(N.getDate()+1),N.setHours(23,59,59,999),Y.value=h.filter(p=>{if(p.rentedAt){const E=p.rentedAt?.toDate?.()||new Date(p.rentedAt),R=new Date(E);return R.setDate(R.getDate()+7),R<=N}return!1}).length;const $=s(L,"rentalHistory"),z=e($,u("userId","==",g.value.uid)),M=await l(z);Z.value=M.docs.length}catch(s){console.error("대여 현황 로드 오류:",s)}};Ce(async()=>{const s=await de();P.value=s.workplace,j.value=s.name,_.value=s.workplace?xe(s.workplace):K[0],await Promise.all([U(),ee()])});const ve=async()=>{await U()},te=d([]),U=async()=>{try{H.value=!0;const e=(await oe(_.value)).filter(l=>l.location==="구매칸");te.value=e;const u=new Map;e.forEach(l=>{const r=l.isbn13||l.isbn;if(!u.has(r))u.set(r,{...l,copies:[l],availableCount:1,totalCount:1});else{const m=u.get(r);m.copies.push(l),m.totalCount++,I(l)||m.availableCount++}}),u.forEach(l=>{l.availableCount=l.copies.filter(r=>!I(r)).length}),A.value=Array.from(u.values())}catch(s){console.error("신규 도서 로드 오류:",s),A.value=[],te.value=[]}finally{H.value=!1}},me=async s=>{if(!g.value||!s)return;if(J(P.value,_.value)&&q.value>=se){await B(`${se}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(s.availableCount===0){await B("현재 대여 가능한 도서가 없습니다.",{type:"warning"});return}const u=s.isbn13||s.isbn,l=await re(g.value.uid,u,_.value);if(l){await B(`이미 같은 도서를 대여중입니다.
(라벨번호: ${l.labelNumber||"-"})`,{type:"warning"});return}const r=s.copies.filter(m=>!I(m));if(r.length===1){const m=r[0];y.value=s,b.value=m.labelNumber,C.value=m.location,c.value=m,D.value=!0}else y.value=s,b.value="",C.value="",c.value=null,x.value=!0},_e=s=>{b.value=s.labelNumber,C.value=s.location,c.value=s},pe=()=>{x.value=!1,y.value=null,b.value="",C.value="",c.value=null},fe=()=>{!y.value||!b.value||(x.value=!1,D.value=!0)},be=()=>{D.value=!1,y.value=null,b.value="",C.value="",c.value=null},we=async()=>{if(!c.value||!g.value)return;const s=J(P.value,_.value);try{F.value=!0,D.value=!1;const e=c.value.labelNumber,u=c.value.isbn13||c.value.isbn;s?(await ne(e,_.value,g.value.uid,u),await Promise.all([U(),ee()]),await B("도서 대여가 완료되었습니다.",{type:"success"})):(await le(e,_.value,g.value.uid,u),await U(),await B(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"}))}catch(e){console.error("대여 신청 오류:",e),await B(e.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{F.value=!1,y.value=null,b.value="",C.value="",c.value=null}};return Ie({title:"홈 - CNX Library",meta:[{name:"description",content:"CNX Library 도서 관리 시스템"}]}),(s,e)=>{const u=w("v-select"),l=Be,r=w("v-btn"),m=Le,V=w("v-card-title"),h=w("v-icon"),N=w("v-card-text"),$=w("v-spacer"),z=w("v-card-actions"),M=w("v-card"),p=w("v-dialog"),E=Ae,R=w("v-navigation-drawer"),W=w("v-app");return k(),X(W,null,{default:n(()=>[o(m,{"header-type":"home","show-header-actions":!0,onToggleDrawer:e[1]||(e[1]=i=>S.value=!a(S))},{default:n(()=>[t("div",Pe,[t("div",Ue,[t("div",$e,[t("h1",ze,f(a(j))+"님의 도서 대여 현황 ",1)]),t("div",Me,[t("div",{class:"dashboard-card",onClick:Q},[t("div",Oe,f(a(q)),1),e[5]||(e[5]=t("div",{class:"dashboard-label"}," 대여중 도서 ",-1))]),t("div",{class:"dashboard-card warning",onClick:Q},[t("div",Fe,f(a(Y)),1),e[6]||(e[6]=t("div",{class:"dashboard-label"}," 반납 예정 도서 ",-1))]),t("div",{class:"dashboard-card",onClick:Q},[t("div",He,f(a(Z)),1),e[7]||(e[7]=t("div",{class:"dashboard-label"}," 내가 읽은 책 ",-1))])])]),t("div",qe,[t("div",Qe,[t("h1",We,f(a(_))+" 신규 도서 ",1),o(u,{modelValue:a(_),"onUpdate:modelValue":[e[0]||(e[0]=i=>O(_)?_.value=i:null),ve],items:K,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),t("div",Xe,[o(l,{books:a(A),center:a(_),"registered-books":a(A),loading:a(H),title:`총 ${a(A).length}권`,"empty-message":"신규 입고된 도서가 없습니다.","nav-id":"new-books","show-action":!1,"show-status-flags":!0,"show-rent-button":!0,"hide-overdue-status":!0,onRent:me},null,8,["books","center","registered-books","loading","title"]),t("div",Ge,[o(r,{class:"more-books-btn",variant:"flat",size:"large",block:"",to:"/books"},{default:n(()=>[v(f(a(_))+" 도서 더보기 ",1)]),_:1})])])])]),_:1}),o(p,{modelValue:a(x),"onUpdate:modelValue":e[2]||(e[2]=i=>O(x)?x.value=i:null),"max-width":"500"},{default:n(()=>[o(M,{class:"label-select-card"},{default:n(()=>[o(V,{class:"label-select-title"},{default:n(()=>[...e[8]||(e[8]=[v(" 대여할 도서 선택 ",-1)])]),_:1}),o(N,{class:"label-select-content"},{default:n(()=>[t("p",Je,[v(" 같은 도서가 "+f(a(y)?.copies?.length||0)+"권 있습니다.",1),e[9]||(e[9]=t("br",null,null,-1)),e[10]||(e[10]=v(" 대여할 도서를 선택해주세요. ",-1))]),t("div",Ke,[(k(!0),T(De,null,Ne(a(y)?.copies?.filter(i=>!a(I)(i))||[],i=>(k(),T("div",{key:i.labelNumber,class:Re(["label-item",{selected:a(b)===i.labelNumber}]),onClick:_t=>_e(i)},[t("div",Ye,[t("span",Ze,f(i.labelNumber),1),t("span",et,f(i.location),1)]),a(b)===i.labelNumber?(k(),X(h,{key:0,color:"primary"},{default:n(()=>[...e[11]||(e[11]=[v(" mdi-check-circle ",-1)])]),_:1})):G("",!0)],10,je))),128))])]),_:1}),o(z,{class:"label-select-actions"},{default:n(()=>[o($),o(r,{variant:"text",onClick:pe},{default:n(()=>[...e[12]||(e[12]=[v(" 취소 ",-1)])]),_:1}),o(r,{color:"primary",variant:"flat",disabled:!a(b),onClick:fe},{default:n(()=>[...e[13]||(e[13]=[v(" 선택 완료 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(p,{modelValue:a(D),"onUpdate:modelValue":e[3]||(e[3]=i=>O(D)?D.value=i:null),"max-width":"500"},{default:n(()=>[o(M,{class:"rent-confirm-card"},{default:n(()=>[o(V,{class:"rent-confirm-title"},{default:n(()=>[...e[14]||(e[14]=[v(" 대여 확인 ",-1)])]),_:1}),o(N,{class:"rent-confirm-content"},{default:n(()=>[e[20]||(e[20]=t("div",{class:"rent-confirm-info mb-4"},[t("p",null,"아래 정보를 확인 후 대여해주세요.")],-1)),a(c)?(k(),T("div",tt,[t("div",at,[a(c).cover?(k(),T("img",{key:0,src:a(c).cover,alt:a(c).title},null,8,st)):(k(),X(h,{key:1,size:"48",color:"grey-lighten-1"},{default:n(()=>[...e[15]||(e[15]=[v(" mdi-book-outline ",-1)])]),_:1}))]),t("div",ot,[t("h3",nt,f(a(c).title),1),t("p",lt,f(a(c).author),1),t("div",rt,[t("span",it,[o(h,{size:"16"},{default:n(()=>[...e[16]||(e[16]=[v(" mdi-label-outline ",-1)])]),_:1}),v(" "+f(a(b)),1)]),t("span",ut,[o(h,{size:"16"},{default:n(()=>[...e[17]||(e[17]=[v(" mdi-map-marker-outline ",-1)])]),_:1}),v(" "+f(a(C)),1)])])])])):G("",!0),a(J)(a(P),a(_))?G("",!0):(k(),T("div",ct,[o(h,{size:"20",color:"warning"},{default:n(()=>[...e[18]||(e[18]=[v(" mdi-information-outline ",-1)])]),_:1}),e[19]||(e[19]=t("span",null,"관리자 승인 후 대여가 완료됩니다.",-1))]))]),_:1}),o(z,{class:"rent-confirm-actions"},{default:n(()=>[o($),o(r,{variant:"text",onClick:be},{default:n(()=>[...e[21]||(e[21]=[v(" 취소 ",-1)])]),_:1}),o(r,{color:"primary",variant:"flat",loading:a(F),onClick:we},{default:n(()=>[...e[22]||(e[22]=[v(" 대여하기 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(R,{modelValue:a(S),"onUpdate:modelValue":e[4]||(e[4]=i=>O(S)?S.value=i:null),location:"right",temporary:"",width:a(ue),class:"side-navigation"},{default:n(()=>[t("div",dt,[o(E)])]),_:1},8,["modelValue","width"])]),_:1})}}},Rt=ge(vt,[["__scopeId","data-v-25a2a58c"]]);export{Rt as default};
