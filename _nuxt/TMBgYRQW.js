const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Bb-IZLVQ.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as Pe,N as Ne,a as Me,D as We,r as _,o as pe,e as ze,_ as z,k as K,X as He,O as ge,L as C,g as x,H as P,K as m,P as a,I as c,J as N,Q as M,G as j,M as A,V as Qe,W as je}from"./Bb-IZLVQ.js";import{u as Xe,_ as Ge}from"./BO47ws7G.js";import{g as Je,C as Ke,_ as Ye}from"./Bi71xubJ.js";import{_ as Ze}from"./BXLUrFre.js";import{u as et}from"./DU0bEG_V.js";import{u as tt}from"./D0YV89OB.js";import"./D8OVkwJr.js";const nt={class:"books-admin-page"},st={class:"center-header mb-6"},rt={class:"center-header-inner"},ot={class:"page-title mb-0"},at={class:"registered-books-section"},lt={class:"registered-books-header mb-0"},it={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},ut={class:"text-body-1"},dt={class:"text-body-2 text-medium-emphasis"},ct={class:"d-flex align-center registered-search-group"},vt={class:"d-flex align-center justify-space-between flex-wrap gap-4 mt-4"},mt={class:"d-flex action-buttons"},ft={key:0,class:"text-center py-8"},pt={key:1,class:"registered-books-grid"},gt={key:2,class:"text-center py-8 text-medium-emphasis empty-state"},yt={key:0},wt={key:1},_t={class:"drawer-content"},ht={class:"rent-dialog-content"},bt={class:"mb-4 text-body-2 text-medium-emphasis"},Dt={class:"rent-dialog-actions"},Y=5,Bt={__name:"index",setup(At){const{user:ue}=et(),{getBooksByCenter:ye,deleteBook:we,calculateBookStatus:R}=Xe(),{confirm:J,alert:b}=Ne(),{$firebaseFirestore:_e}=Me(),D=_e,X=We("navigationDrawer",()=>!1),de=_(280),Z=[...Ke],$=_(""),he=_(""),H=_([]),ee=_(!1),U=_(""),L=_("title"),be=[{title:"제목순",value:"title"},{title:"등록일순",value:"date"},{title:"대여중도서",value:"rented"},{title:"연체중도서",value:"overdue"},{title:"대여신청도서",value:"requested"},{title:"신규등록도서",value:"new"}],d=_([]),G=_(!1),I=_(!1),te=_({}),ne=_({}),Q=_(!1),O=_([]),se=_(!1),S=_(""),T=_(""),E=_("");pe(()=>{const e=()=>{de.value=window.innerWidth>=769?360:280};e(),window.addEventListener("resize",e),ze(()=>{window.removeEventListener("resize",e)})});const De=async()=>{if(!ue.value||!D)return"";try{const{doc:e,getDoc:t}=await z(async()=>{const{doc:o,getDoc:u}=await import("./Bb-IZLVQ.js").then(l=>l.aF);return{doc:o,getDoc:u}},__vite__mapDeps([0,1]),import.meta.url),n=e(D,"users",ue.value.uid),s=await t(n);if(s.exists())return s.data().workplace||""}catch(e){console.error("사용자 근무지 정보 가져오기 오류:",e)}return""};pe(async()=>{const e=await De();he.value=e,$.value=e?Je(e):Z[0],await W()});const Be=async()=>{await W()},W=async()=>{try{ee.value=!0;const e=await ye($.value);H.value=e,await Ae(e)}catch(e){console.error("등록된 도서 로드 오류:",e),H.value=[]}finally{ee.value=!1}},Ae=async e=>{if(!D)return;const{doc:t,getDoc:n}=await z(async()=>{const{doc:l,getDoc:g}=await import("./Bb-IZLVQ.js").then(y=>y.aF);return{doc:l,getDoc:g}},__vite__mapDeps([0,1]),import.meta.url),s=[...new Set(e.filter(l=>l.rentedBy).map(l=>l.rentedBy))],o=[...new Set(e.filter(l=>l.requestedBy).map(l=>l.requestedBy))],u=[...new Set([...s,...o])];for(const l of u)if(!(te.value[l]&&ne.value[l]))try{const g=t(D,"users",l),y=await n(g);if(y.exists()){const v=y.data(),w=(v.email||"").split("@")[0]||"",f=v.name||"",V=`${v.workplace||""} ${f}(${w})`;te.value[l]=V,ne.value[l]=V}}catch(g){console.error("대여자/신청자 정보 로드 오류:",g)}},ke=e=>e.rentedBy&&te.value[e.rentedBy]||"",ce=e=>e.requestedBy&&ne.value[e.requestedBy]||"",Ce=e=>{if(!e.rentedAt)return null;const t=e.rentedAt?.toDate?.()||new Date(e.rentedAt),n=new Date(t);return n.setDate(n.getDate()+7),n},xe=()=>{},F=K(()=>{let e=[...H.value];if(U.value.trim()){const t=U.value.toLowerCase();e=e.filter(n=>{const s=(n.title||"").toLowerCase(),o=(n.author||"").toLowerCase(),u=(n.publisher||"").toLowerCase();return s.includes(t)||o.includes(t)||u.includes(t)})}return L.value==="title"?e.sort((t,n)=>{const s=(t.title||"").toLowerCase(),o=(n.title||"").toLowerCase();return s.localeCompare(o,"ko")}):L.value==="date"?e.sort((t,n)=>{const s=t.registeredAt?.toDate?.()||new Date(0);return(n.registeredAt?.toDate?.()||new Date(0))-s}):L.value==="rented"?e=e.filter(t=>R(t)==="rented"):L.value==="overdue"?e=e.filter(t=>R(t)==="overdue"):L.value==="requested"?(e=e.filter(t=>R(t)==="requested"),e.sort((t,n)=>{const s=t.requestedAt?.toDate?.()||new Date(0);return(n.requestedAt?.toDate?.()||new Date(0))-s})):L.value==="new"&&(e=e.filter(t=>{if(t.registeredAt){const n=t.registeredAt?.toDate?.()||new Date(t.registeredAt),s=new Date;return s.setMonth(s.getMonth()-1),n>=s}return!1})),e}),Re=K(()=>H.value.filter(e=>R(e)==="rented").length),Ve=K(()=>H.value.filter(e=>R(e)==="overdue").length),Ie=K(()=>H.value.filter(e=>R(e)==="requested").length),qe=e=>R(e),ve=e=>{const t=e.isbn13||e.isbn||e.id||"";return d.value.some(n=>{const s=n.isbn13||n.isbn||n.id||"";return t===s})},$e=(e,t)=>{const n=e.isbn13||e.isbn||e.id||"";t?ve(e)||d.value.push(e):d.value=d.value.filter(s=>{const o=s.isbn13||s.isbn||s.id||"";return n!==o}),G.value=d.value.length===F.value.length&&F.value.length>0},Ee=e=>{e?d.value=[...F.value]:d.value=[]};He(()=>F.value,()=>{G.value=d.value.length===F.value.length&&F.value.length>0});const Le=async()=>{if(d.value.length===0)return;const e=[],t=[];for(const s of d.value){const o=R(s);o==="rented"||o==="overdue"?t.push({book:s,reason:"대여중"}):o==="requested"?t.push({book:s,reason:"대여신청중"}):e.push(s)}if(e.length===0){const s=t.map(o=>`• ${o.book.title} (${o.reason})`).join(`
`);await b(`선택한 도서를 삭제할 수 없습니다.

${s}

대여중/대여신청중인 도서는 반납 또는 신청 취소 후 삭제해주세요.`,{type:"warning"});return}let n=`선택한 ${d.value.length}권 중 ${e.length}권의 도서를 삭제하시겠습니까?`;if(t.length>0){const s=t.map(o=>`• ${o.book.title} (${o.reason})`).join(`
`);n+=`

⚠️ 다음 도서는 삭제할 수 없습니다:
${s}`}if(await J(n))try{I.value=!0;const s=e.map(o=>{const u=o.isbn13||o.isbn;return we(u,$.value)});await Promise.all(s),d.value=[],await W(),t.length>0?await b(`${e.length}권의 도서가 삭제되었습니다.
(${t.length}권은 대여중/대여신청중으로 삭제되지 않았습니다.)`,{type:"success"}):await b(`${e.length}권의 도서가 삭제되었습니다.`,{type:"success"})}catch(s){console.error("도서 삭제 오류:",s),await b("도서 삭제에 실패했습니다.",{type:"error"})}finally{I.value=!1}},Se=async()=>{if(d.value.length===0)return;const e=d.value.filter(t=>{const n=R(t);return n!=="rented"&&n!=="overdue"});if(e.length===0){await b("선택한 도서가 모두 대여중입니다.",{type:"warning"});return}O.value=e,S.value=$.value,T.value="",E.value="",Q.value=!0},me=async e=>{if(!D||!e)return 0;try{const{collection:t,query:n,where:s,getDocs:o}=await z(async()=>{const{collection:v,query:i,where:w,getDocs:f}=await import("./Bb-IZLVQ.js").then(h=>h.aF);return{collection:v,query:i,where:w,getDocs:f}},__vite__mapDeps([0,1]),import.meta.url),u=t(D,"books"),l=n(u,s("rentedBy","==",e)),g=await o(l);let y=0;return g.forEach(v=>{const i=v.data();(i.status==="rented"||i.status==="overdue")&&y++}),y}catch(t){return console.error("대여 권수 조회 오류:",t),0}},Te=async e=>{if(R(e)==="requested"&&e.requestedBy){if(await me(e.requestedBy)>=Y){await b(`신청자가 이미 ${Y}권을 대여중입니다.
반납 후 대여 처리해주세요.`,{type:"warning"});return}if(!await J(`신청자 정보로 대여 처리하시겠습니까?

도서: ${e.title}
신청자: ${ce(e)}`))return;try{I.value=!0;const{doc:s,setDoc:o,serverTimestamp:u,deleteField:l}=await z(async()=>{const{doc:v,setDoc:i,serverTimestamp:w,deleteField:f}=await import("./Bb-IZLVQ.js").then(h=>h.aF);return{doc:v,setDoc:i,serverTimestamp:w,deleteField:f}},__vite__mapDeps([0,1]),import.meta.url),g=e.id||e.isbn13||e.isbn,y=s(D,"books",g);await o(y,{status:"rented",rentedBy:e.requestedBy,rentedAt:u(),requestedBy:l(),requestedAt:l(),updatedAt:u()},{merge:!0}),await W(),await b("대여 처리가 완료되었습니다.",{type:"success"})}catch(s){console.error("대여 처리 오류:",s),await b("대여 처리에 실패했습니다.",{type:"error"})}finally{I.value=!1}return}O.value=[e],S.value=$.value,T.value="",E.value="",Q.value=!0},fe=()=>{Q.value=!1,O.value=[],S.value="",T.value="",E.value=""},Fe=async()=>{if(!(!S.value||!T.value))try{se.value=!0,E.value="";const{collection:e,query:t,where:n,getDocs:s,doc:o,setDoc:u,serverTimestamp:l}=await z(async()=>{const{collection:p,query:r,where:k,getDocs:re,doc:oe,setDoc:ae,serverTimestamp:le}=await import("./Bb-IZLVQ.js").then(ie=>ie.aF);return{collection:p,query:r,where:k,getDocs:re,doc:oe,setDoc:ae,serverTimestamp:le}},__vite__mapDeps([0,1]),import.meta.url),g=e(D,"users"),y=t(g,n("email","==",T.value)),v=await s(y);if(v.empty){E.value="해당 이메일의 사용자를 찾을 수 없습니다.";return}const i=v.docs[0].data();if(i.center!==S.value){E.value=`해당 사용자는 ${i.center} 소속입니다.`;return}const f=v.docs[0].id,h=await me(f),V=O.value.length,B=Y-h;if(B<=0){E.value=`해당 사용자가 이미 ${Y}권을 대여중입니다.`;return}if(V>B){E.value=`해당 사용자는 ${B}권까지만 추가 대여 가능합니다. (현재 ${h}권 대여중)`;return}for(const p of O.value){const r=p.id||p.isbn13||p.isbn,k=o(D,"books",r);await u(k,{status:"rented",rentedBy:f,rentedAt:l(),updatedAt:l()},{merge:!0})}const q=O.value.length;await W(),d.value=d.value.filter(p=>!O.value.some(r=>r.id===p.id)),fe(),await b(`${q}권의 도서가 대여 처리되었습니다.`,{type:"success"})}catch(e){console.error("도서 대여 오류:",e),E.value=e.message||"대여 처리에 실패했습니다."}finally{se.value=!1}},Ue=async()=>{if(d.value.length===0)return;const e=d.value.filter(t=>{const n=R(t);return n==="rented"||n==="overdue"});if(e.length===0){await b("선택한 도서 중 대여중인 도서가 없습니다.",{type:"warning"});return}if(await J(`선택한 ${e.length}권의 도서를 반납 처리하시겠습니까?`))try{I.value=!0;const{doc:t,updateDoc:n,collection:s,addDoc:o,query:u,where:l,getDocs:g,serverTimestamp:y,deleteField:v}=await z(async()=>{const{doc:i,updateDoc:w,collection:f,addDoc:h,query:V,where:B,getDocs:q,serverTimestamp:p,deleteField:r}=await import("./Bb-IZLVQ.js").then(k=>k.aF);return{doc:i,updateDoc:w,collection:f,addDoc:h,query:V,where:B,getDocs:q,serverTimestamp:p,deleteField:r}},__vite__mapDeps([0,1]),import.meta.url);for(const i of e){const w=i.id||i.isbn13||i.isbn,f=i.rentedBy,h=i.rentedAt,V=t(D,"books",w);if(await n(V,{status:"available",rentedBy:v(),rentedAt:v()}),f){const B=s(D,"rentalHistory"),q=u(B,l("userId","==",f),l("bookId","==",w)),p=await g(q);if(p.empty)await o(B,{bookId:w,isbn13:i.isbn13||"",isbn:i.isbn||"",title:i.title||"",author:i.author||"",publisher:i.publisher||"",cover:i.cover||i.image||"",center:i.center||"",userId:f,rentedAt:h,returnedAt:y(),rentCount:1});else{const r=p.docs[0],k=r.data();await n(t(D,"rentalHistory",r.id),{rentedAt:h,returnedAt:y(),rentCount:(k.rentCount||1)+1})}}}d.value=[],await W(),await b(`${e.length}권의 도서가 반납 처리되었습니다.`,{type:"success"})}catch(t){console.error("도서 반납 오류:",t),await b("도서 반납에 실패했습니다.",{type:"error"})}finally{I.value=!1}},Oe=async e=>{const t=R(e);if(t!=="rented"&&t!=="overdue"){await b("대여중인 도서가 아닙니다.",{type:"warning"});return}if(await J(`"${e.title}" 도서를 반납 처리하시겠습니까?`))try{I.value=!0;const{doc:n,updateDoc:s,collection:o,addDoc:u,query:l,where:g,getDocs:y,serverTimestamp:v,deleteField:i}=await z(async()=>{const{doc:B,updateDoc:q,collection:p,addDoc:r,query:k,where:re,getDocs:oe,serverTimestamp:ae,deleteField:le}=await import("./Bb-IZLVQ.js").then(ie=>ie.aF);return{doc:B,updateDoc:q,collection:p,addDoc:r,query:k,where:re,getDocs:oe,serverTimestamp:ae,deleteField:le}},__vite__mapDeps([0,1]),import.meta.url),w=e.id||e.isbn13||e.isbn,f=e.rentedBy,h=e.rentedAt,V=n(D,"books",w);if(await s(V,{status:"available",rentedBy:i(),rentedAt:i()}),f){const B=o(D,"rentalHistory"),q=l(B,g("userId","==",f),g("bookId","==",w)),p=await y(q);if(p.empty)await u(B,{bookId:w,isbn13:e.isbn13||"",isbn:e.isbn||"",title:e.title||"",author:e.author||"",publisher:e.publisher||"",cover:e.cover||e.image||"",center:e.center||"",userId:f,rentedAt:h,returnedAt:v(),rentCount:1});else{const r=p.docs[0],k=r.data();await s(n(D,"rentalHistory",r.id),{rentedAt:h,returnedAt:v(),rentCount:(k.rentCount||1)+1})}}await W(),await b("도서가 반납 처리되었습니다.",{type:"success"})}catch(n){console.error("도서 반납 오류:",n),await b("도서 반납에 실패했습니다.",{type:"error"})}finally{I.value=!1}};return tt({title:"도서 관리 - CNX Library",meta:[{name:"description",content:"도서 검색 및 등록 관리"}]}),(e,t)=>{const n=x("v-select"),s=x("v-text-field"),o=x("v-checkbox"),u=x("v-btn"),l=x("v-progress-circular"),g=Ge,y=x("v-col"),v=x("v-row"),i=x("v-icon"),w=Ye,f=Ze,h=x("v-navigation-drawer"),V=x("v-spacer"),B=x("v-card"),q=x("v-dialog"),p=x("v-app");return P(),ge(p,null,{default:C(()=>[m(w,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:t[4]||(t[4]=r=>X.value=!a(X))},{default:C(()=>[c("div",nt,[c("div",st,[c("div",rt,[c("h1",ot,N(a($))+" 도서 관리 ",1),m(n,{modelValue:a($),"onUpdate:modelValue":[t[0]||(t[0]=r=>M($)?$.value=r:null),Be],items:Z,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),c("div",at,[c("div",lt,[c("div",it,[c("div",ut,[t[9]||(t[9]=A(" 총 ",-1)),c("strong",null,N(a(F).length),1),t[10]||(t[10]=A("권 ",-1))]),c("div",dt,[t[11]||(t[11]=A(" 대여중 ",-1)),c("strong",null,N(a(Re)),1),t[12]||(t[12]=A("권, 연체중 ",-1)),c("strong",null,N(a(Ve)),1),t[13]||(t[13]=A("권, 대여신청 ",-1)),c("strong",null,N(a(Ie)),1),t[14]||(t[14]=A("권 ",-1))])]),c("div",ct,[m(s,{modelValue:a(U),"onUpdate:modelValue":[t[1]||(t[1]=r=>M(U)?U.value=r:null),xe],label:"등록도서 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"registered-search-input"},null,8,["modelValue"]),m(n,{modelValue:a(L),"onUpdate:modelValue":t[2]||(t[2]=r=>M(L)?L.value=r:null),items:be,label:"정렬",variant:"outlined",density:"comfortable","hide-details":"",class:"sort-select"},null,8,["modelValue"])]),c("div",vt,[m(o,{modelValue:a(G),"onUpdate:modelValue":[t[3]||(t[3]=r=>M(G)?G.value=r:null),Ee],label:"전체선택","hide-details":"",class:"select-all-checkbox"},null,8,["modelValue"]),c("div",mt,[m(u,{class:"action-btn",variant:"flat",size:"small",disabled:a(d).length===0,loading:a(I),onClick:Le},{default:C(()=>[...t[15]||(t[15]=[A(" 도서 삭제 ",-1)])]),_:1},8,["disabled","loading"]),m(u,{class:"action-btn",variant:"flat",size:"small",disabled:a(d).length===0,loading:a(I),onClick:Se},{default:C(()=>[...t[16]||(t[16]=[A(" 대여 처리 ",-1)])]),_:1},8,["disabled","loading"]),m(u,{class:"action-btn",variant:"flat",size:"small",disabled:a(d).length===0,loading:a(I),onClick:Ue},{default:C(()=>[...t[17]||(t[17]=[A(" 반납 처리 ",-1)])]),_:1},8,["disabled","loading"])])])]),a(ee)?(P(),j("div",ft,[m(l,{indeterminate:"",color:"primary"})])):a(F).length>0?(P(),j("div",pt,[m(v,{class:"book-list-row"},{default:C(()=>[(P(!0),j(Qe,null,je(a(F),(r,k)=>(P(),ge(y,{key:`registered-${k}`,cols:"12",sm:"6",class:"book-list-col"},{default:C(()=>[m(g,{book:r,center:a($),"registered-books":[r],"is-registered":!0,"show-action":!1,selectable:!0,selected:ve(r),status:qe(r),"show-status-flags":!0,"renter-info":ke(r),"requester-info":ce(r),"return-date":Ce(r),"show-admin-rent-button":!0,"show-admin-return-button":!0,onSelect:$e,onAdminRent:Te,onAdminReturn:Oe},null,8,["book","center","registered-books","selected","status","renter-info","requester-info","return-date"])]),_:2},1024))),128))]),_:1})])):(P(),j("div",gt,[m(i,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:C(()=>[A(N(a(U)?"mdi-book-search-outline":"mdi-book-off-outline"),1)]),_:1}),a(U)?(P(),j("p",yt,[t[18]||(t[18]=A(" '",-1)),c("strong",null,N(a(U)),1),t[19]||(t[19]=A("'에 대한 검색 결과가 없습니다. ",-1))])):(P(),j("p",wt," 등록된 도서가 없습니다. "))]))])])]),_:1}),m(h,{modelValue:a(X),"onUpdate:modelValue":t[5]||(t[5]=r=>M(X)?X.value=r:null),location:"right",temporary:"",width:a(de),class:"side-navigation"},{default:C(()=>[c("div",_t,[m(f)])]),_:1},8,["modelValue","width"]),m(q,{modelValue:a(Q),"onUpdate:modelValue":t[8]||(t[8]=r=>M(Q)?Q.value=r:null),"max-width":"400",persistent:""},{default:C(()=>[m(B,{class:"rent-dialog-card"},{default:C(()=>[t[22]||(t[22]=c("div",{class:"rent-dialog-title text-h6"}," 대여자 정보 입력 ",-1)),c("div",ht,[c("div",bt," 대여 처리할 도서: "+N(a(O).length)+"권 ",1),m(n,{modelValue:a(S),"onUpdate:modelValue":t[6]||(t[6]=r=>M(S)?S.value=r:null),items:Z,label:"센터",variant:"outlined",density:"comfortable",class:"mb-3"},null,8,["modelValue"]),m(s,{modelValue:a(T),"onUpdate:modelValue":t[7]||(t[7]=r=>M(T)?T.value=r:null),label:"이메일",variant:"outlined",density:"comfortable",placeholder:"example@email.com","error-messages":a(E)},null,8,["modelValue","error-messages"])]),c("div",Dt,[m(V),m(u,{variant:"text",onClick:fe},{default:C(()=>[...t[20]||(t[20]=[A(" 취소 ",-1)])]),_:1}),m(u,{color:"primary",variant:"flat",loading:a(se),disabled:!a(S)||!a(T),onClick:Fe},{default:C(()=>[...t[21]||(t[21]=[A(" 대여 처리 ",-1)])]),_:1},8,["loading","disabled"])])]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},$t=Pe(Bt,[["__scopeId","data-v-a309c537"]]);export{$t as default};
