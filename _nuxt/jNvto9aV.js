const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CxY3VaYY.js","./entry.DYRcaxkF.css"])))=>i.map(i=>d[i]);
import{F as fe,N as ge,a as we,D as ye,r as _,o as Z,e as he,_ as ee,k as X,O as te,L as B,g as w,H as v,K as m,P as a,I as u,J as f,Q as P,G as y,M as h,W as A,X as be}from"./CxY3VaYY.js";import{u as ke,_ as Be}from"./JgwnPQNb.js";import{g as xe,C as Ce,_ as Re,c as se}from"./DkmCLlXj.js";import{_ as De}from"./GaOnRRIw.js";import{u as Ve}from"./DRbzCEke.js";import{u as Le}from"./CVZK6l8v.js";import"./D_MPEFBF.js";const $e={class:"books-page"},Se={class:"center-header mb-6"},Ee={class:"center-header-inner"},qe={class:"page-title mb-0"},Ne={class:"registered-books-section"},Pe={class:"registered-books-header mb-0"},Ae={class:"d-flex align-center justify-space-between flex-wrap gap-4 mb-4"},Te={class:"text-body-1"},Ue={class:"d-flex align-center registered-search-group"},We={class:"d-flex align-center justify-space-between flex-wrap gap-4 mt-4"},Ie={class:"text-body-2 text-medium-emphasis"},Me={key:0,class:"text-center py-8 mt-6"},Oe={key:1,class:"registered-books-grid mt-6"},ze={key:2,class:"text-center py-8 mt-6 text-medium-emphasis empty-state"},je={key:0},Fe={key:1},Xe={class:"drawer-content"},x=5,He={__name:"index",setup(Qe){const{user:p}=Ve(),{getBooksByCenter:ae,calculateBookStatus:ne,rentBook:H,requestRent:Q}=ke(),{confirm:G,alert:d}=ge(),{$firebaseFirestore:oe}=we(),E=oe,V=ye("navigationDrawer",()=>!1),J=_(280),K=[...Ce],c=_(""),T=_(""),U=_([]),W=_(!1),b=_(""),L=_("date"),re=[{title:"등록일순",value:"date"},{title:"제목순",value:"title"}],r=_([]),$=_(!1),k=_(0);Z(()=>{const e=()=>{J.value=window.innerWidth>=769?360:280};e(),window.addEventListener("resize",e),he(()=>{window.removeEventListener("resize",e)})});const ie=async()=>{if(!p.value||!E)return"";try{const{doc:e,getDoc:t}=await ee(async()=>{const{doc:o,getDoc:i}=await import("./CxY3VaYY.js").then(g=>g.aB);return{doc:o,getDoc:i}},__vite__mapDeps([0,1]),import.meta.url),n=e(E,"users",p.value.uid),s=await t(n);if(s.exists())return s.data().workplace||""}catch(e){console.error("사용자 근무지 정보 가져오기 오류:",e)}return""};Z(async()=>{const e=await ie();T.value=e,c.value=e?xe(e):K[0],await Promise.all([R(),I()])});const I=async()=>{if(!p.value||!E){k.value=0;return}try{const{collection:e,query:t,where:n,getDocs:s}=await ee(async()=>{const{collection:S,query:D,where:z,getDocs:j}=await import("./CxY3VaYY.js").then(F=>F.aB);return{collection:S,query:D,where:z,getDocs:j}},__vite__mapDeps([0,1]),import.meta.url),o=e(E,"books"),i=t(o,n("rentedBy","==",p.value.uid)),g=await s(i);let N=0;g.forEach(S=>{const D=S.data();(D.status==="rented"||D.status==="overdue")&&N++}),k.value=N}catch(e){console.error("대여중인 도서 수 로드 오류:",e),k.value=0}},q=X(()=>k.value<x),C=X(()=>x-k.value),le=async()=>{await R()},R=async()=>{try{W.value=!0;const e=await ae(c.value);U.value=e}catch(e){console.error("등록된 도서 로드 오류:",e),U.value=[]}finally{W.value=!1}},ue=()=>{},M=X(()=>{let e=[...U.value];if(b.value.trim()){const t=b.value.toLowerCase();e=e.filter(n=>{const s=(n.title||"").toLowerCase(),o=(n.author||"").toLowerCase(),i=(n.publisher||"").toLowerCase();return s.includes(t)||o.includes(t)||i.includes(t)})}return L.value==="title"?e.sort((t,n)=>{const s=(t.title||"").toLowerCase(),o=(n.title||"").toLowerCase();return s.localeCompare(o,"ko")}):L.value==="date"&&e.sort((t,n)=>{const s=t.registeredAt?.toDate?.()||new Date(0);return(n.registeredAt?.toDate?.()||new Date(0))-s}),e}),O=e=>ne(e),ce=e=>{const t=O(e);return t==="rented"||t==="overdue"||t==="requested"},Y=e=>{const t=e.isbn13||e.isbn||e.id||"";return r.value.some(n=>{const s=n.isbn13||n.isbn||n.id||"";return t===s})},de=async(e,t)=>{const n=e.isbn13||e.isbn||e.id||"",s=O(e);if(!(s==="rented"||s==="overdue"||s==="requested"))if(t){if(!q.value){await d(`${x}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(r.value.length>=C.value){await d(`현재 ${C.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}Y(e)||r.value.push(e)}else r.value=r.value.filter(o=>{const i=o.isbn13||o.isbn||o.id||"";return n!==i})},ve=async()=>{if(r.value.length===0||!p.value)return;const e=se(T.value,c.value);if(e){if(!q.value){await d(`${x}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}if(r.value.length>C.value){await d(`현재 ${C.value}권까지 추가 대여 가능합니다.`,{type:"warning"});return}}const t=r.value.map(s=>s.title).join(", "),n=e?`다음 도서들을 대여 신청하시겠습니까?

${t}`:`대여 신청하시겠습니까?
(관리자 승인 후 대여 가능)

${t}`;if(await G(n))try{$.value=!0;const s=r.value.length;if(e){const o=r.value.map(i=>{const g=i.isbn13||i.isbn;return H(g,c.value,p.value.uid)});await Promise.all(o),await Promise.all([R(),I()]),await d(`${s}권의 도서 대여가 완료되었습니다.`,{type:"success"})}else{const o=r.value.map(i=>{const g=i.isbn13||i.isbn;return Q(g,c.value,p.value.uid)});await Promise.all(o),await R(),await d(`${s}권의 도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"})}r.value=[]}catch(s){console.error("대여 신청 오류:",s),await d(s.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{$.value=!1}},me=async e=>{if(!p.value||!e)return;const t=se(T.value,c.value);if(t&&!q.value){await d(`${x}권을 대여중입니다. 대여중인 도서를 반납 후 대여해주세요.`,{type:"warning"});return}const n=t?`"${e.title}"을(를) 대여 신청하시겠습니까?`:`"${e.title}"을(를) 대여 신청하시겠습니까?
(관리자 승인 후 대여 가능)`;if(await G(n))try{$.value=!0;const s=e.isbn13||e.isbn;t?(await H(s,c.value,p.value.uid),await Promise.all([R(),I()]),await d("도서 대여가 완료되었습니다.",{type:"success"})):(await Q(s,c.value,p.value.uid),await R(),await d(`도서 대여가 신청되었습니다.
관리자 승인 후 대여가 완료됩니다.`,{type:"success"})),r.value=r.value.filter(o=>o.id!==e.id)}catch(s){console.error("대여 신청 오류:",s),await d(s.message||"대여 신청에 실패했습니다.",{type:"error"})}finally{$.value=!1}};return Le({title:"도서 대여 - CNX Library",meta:[{name:"description",content:"센터별 도서 대여 신청"}]}),(e,t)=>{const n=w("v-select"),s=w("v-text-field"),o=w("v-btn"),i=w("v-progress-circular"),g=Be,N=w("v-col"),S=w("v-row"),D=w("v-icon"),z=Re,j=De,F=w("v-navigation-drawer"),pe=w("v-app");return v(),te(pe,null,{default:B(()=>[m(z,{"header-type":"back-home","show-header-actions":!0,onToggleDrawer:t[3]||(t[3]=l=>V.value=!a(V))},{default:B(()=>[u("div",$e,[u("div",Se,[u("div",Ee,[u("h1",qe,f(a(c))+" 도서 대여 ",1),m(n,{modelValue:a(c),"onUpdate:modelValue":[t[0]||(t[0]=l=>P(c)?c.value=l:null),le],items:K,variant:"outlined",density:"comfortable","hide-details":"",class:"center-select"},null,8,["modelValue"])])]),u("div",Ne,[u("div",Pe,[u("div",Ae,[u("div",Te,[t[5]||(t[5]=h(" 총 ",-1)),u("strong",null,f(a(M).length),1),t[6]||(t[6]=h("권 ",-1))])]),u("div",Ue,[m(s,{modelValue:a(b),"onUpdate:modelValue":[t[1]||(t[1]=l=>P(b)?b.value=l:null),ue],label:"도서 검색","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable","hide-details":"",clearable:"",class:"registered-search-input"},null,8,["modelValue"]),m(n,{modelValue:a(L),"onUpdate:modelValue":t[2]||(t[2]=l=>P(L)?L.value=l:null),items:re,label:"정렬",variant:"outlined",density:"comfortable","hide-details":"",class:"sort-select"},null,8,["modelValue"])]),u("div",We,[u("div",Ie,[a(k)>=x?(v(),y(A,{key:0},[h(f(x)+"권 대여중 (반납 후 대여 가능) ")],64)):a(r).length>0?(v(),y(A,{key:1},[h(f(a(r).length)+"권 선택됨 ("+f(a(k))+"권 대여중, "+f(a(C))+"권 추가 가능) ",1)],64)):(v(),y(A,{key:2},[h(" 대여할 도서를 선택하세요 ("+f(a(k))+"권 대여중, "+f(a(C))+"권 추가 가능) ",1)],64))]),m(o,{class:"rent-request-btn",variant:"flat",size:"small",disabled:a(r).length===0||!a(q),loading:a($),onClick:ve},{default:B(()=>[...t[7]||(t[7]=[h(" 대여 신청 ",-1)])]),_:1},8,["disabled","loading"])])]),a(W)?(v(),y("div",Me,[m(i,{indeterminate:"",color:"primary"})])):a(M).length>0?(v(),y("div",Oe,[m(S,{class:"book-list-row"},{default:B(()=>[(v(!0),y(A,null,be(a(M),(l,_e)=>(v(),te(N,{key:`registered-${_e}`,cols:"12",sm:"6",class:"book-list-col"},{default:B(()=>[m(g,{book:l,center:a(c),"registered-books":[l],"is-registered":!0,"show-action":!1,selectable:!0,selected:Y(l),status:O(l),"show-status-flags":!0,disabled:ce(l),"hide-overdue-status":!0,"show-rent-button":!0,onSelect:de,onRent:me},null,8,["book","center","registered-books","selected","status","disabled"])]),_:2},1024))),128))]),_:1})])):(v(),y("div",ze,[m(D,{size:"48",color:"grey-lighten-1",class:"mb-4"},{default:B(()=>[h(f(a(b)?"mdi-book-search-outline":"mdi-book-off-outline"),1)]),_:1}),a(b)?(v(),y("p",je,[t[8]||(t[8]=h(" '",-1)),u("strong",null,f(a(b)),1),t[9]||(t[9]=h("'에 대한 검색 결과가 없습니다. ",-1))])):(v(),y("p",Fe," 등록된 도서가 없습니다. "))]))])])]),_:1}),m(F,{modelValue:a(V),"onUpdate:modelValue":t[4]||(t[4]=l=>P(V)?V.value=l:null),location:"right",temporary:"",width:a(J),class:"side-navigation"},{default:B(()=>[u("div",Xe,[m(j)])]),_:1},8,["modelValue","width"])]),_:1})}}},st=fe(He,[["__scopeId","data-v-2e34addb"]]);export{st as default};
